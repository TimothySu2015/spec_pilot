# Flow Builder UI 設計規格

## 設計目標

**核心理念:** 降低 Flow YAML 編寫門檻,提供直覺的視覺化介面,同時保持專業工具的強大功能。

**目標使用者:**
- 🎯 **主要:** API 測試工程師、QA 工程師
- 🎯 **次要:** 後端開發者、DevOps 工程師
- 🎯 **進階:** 使用 AI (Claude) 協作的開發者

**使用場景:**
1. 快速建立簡單的 API 測試流程
2. 編輯複雜的多步驟測試流程
3. 從 OpenAPI 規格自動生成測試
4. 團隊協作分享測試範本

---

## 整體佈局

### 主版面配置 (Layout)

```
┌─────────────────────────────────────────────────────────────┐
│  Header (高度: 64px)                                         │
│  ┌──────────────┐  Flow Builder        [儲存] [匯出] [預覽]│
│  │ SpecPilot 🚀 │                                            │
│  └──────────────┘                                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌───────────────────┐  ┌──────────────┐ │
│  │              │  │                   │  │              │ │
│  │   Left       │  │   Main Content    │  │   Right      │ │
│  │   Sidebar    │  │   Editor Area     │  │   Panel      │ │
│  │              │  │                   │  │              │ │
│  │  (240px)     │  │   (彈性寬度)       │  │  (320px)     │ │
│  │              │  │                   │  │  可摺疊       │ │
│  │              │  │                   │  │              │ │
│  │              │  │                   │  │              │ │
│  │              │  │                   │  │              │ │
│  │              │  │                   │  │              │ │
│  └──────────────┘  └───────────────────┘  └──────────────┘ │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 元件設計規格

### 1. Header (頁首)

**功能:** 品牌識別、主要操作按鈕、專案資訊

```
┌─────────────────────────────────────────────────────────────┐
│  🚀 SpecPilot Flow Builder                                   │
│                                                               │
│  目前專案: user-management-test.yaml                  🔔 👤  │
│                                                               │
│  [📁 新增] [💾 儲存] [📤 匯出] [👁️ 預覽] [⚙️ 設定]          │
└─────────────────────────────────────────────────────────────┘
```

**元件列表:**
- Logo + 專案名稱
- 麵包屑導航 (可選)
- 主要操作按鈕組
  - 新增 Flow
  - 儲存 (自動儲存狀態顯示)
  - 匯出 (YAML + Schema)
  - 預覽 (開啟 Preview Modal)
  - 設定 (開啟 Settings Drawer)
- 使用者資訊 (可選)
- 通知中心 (可選)

**技術實作:**
```tsx
<Header>
  <Logo>SpecPilot Flow Builder</Logo>
  <Breadcrumb>
    <BreadcrumbItem>Projects</BreadcrumbItem>
    <BreadcrumbItem>user-management-test</BreadcrumbItem>
  </Breadcrumb>
  <ActionButtons>
    <Button icon={<FolderIcon />}>新增</Button>
    <Button icon={<SaveIcon />}>儲存</Button>
    <Button icon={<ExportIcon />}>匯出</Button>
    <Button icon={<EyeIcon />}>預覽</Button>
  </ActionButtons>
</Header>
```

---

### 2. Left Sidebar (左側邊欄)

**功能:** 導航、Steps 列表、快速跳轉

```
┌──────────────────┐
│ 📋 Flow 資訊      │
│ ├─ 基本設定       │
│ ├─ 變數管理       │
│ └─ 全域設定       │
│                  │
│ 🔧 測試步驟 (12) │
│ ├─ ✅ 1. 健康檢查│
│ ├─ ✅ 2. 登入測試│
│ ├─ ⚠️ 3. 建立用戶│ ← 有警告
│ ├─ 📝 4. 查詢列表│ ← 正在編輯
│ ├─ 5. 更新資料   │
│ ├─ 6. 刪除資料   │
│ └─ + 新增步驟    │
│                  │
│ 📦 範本庫        │
│ ├─ CRUD 測試     │
│ ├─ 認證流程      │
│ └─ 錯誤處理      │
└──────────────────┘
```

**元件列表:**

1. **Flow 資訊區塊**
   - 基本設定 (點擊跳轉到編輯區)
   - 變數管理
   - 全域設定 (Options, Reporting)

2. **測試步驟列表**
   - 步驟編號 + 名稱
   - 狀態圖示:
     - ✅ 驗證通過
     - ⚠️ 有警告 (如 OpenAPI 衝突)
     - ❌ 驗證錯誤
     - 📝 正在編輯
   - 拖拉排序功能
   - 摺疊/展開群組
   - 快速搜尋步驟

3. **範本庫**
   - 內建範本
   - 自訂範本
   - 匯入範本

**技術實作:**
```tsx
<Sidebar>
  <Section title="📋 Flow 資訊">
    <NavItem onClick={scrollToBasicInfo}>基本設定</NavItem>
    <NavItem onClick={scrollToVariables}>變數管理</NavItem>
    <NavItem onClick={scrollToOptions}>全域設定</NavItem>
  </Section>

  <Section title="🔧 測試步驟" count={steps.length}>
    <DragDropContext onDragEnd={handleReorder}>
      <Droppable droppableId="steps">
        {steps.map((step, index) => (
          <Draggable key={step.id} draggableId={step.id} index={index}>
            <StepListItem
              step={step}
              status={getStepStatus(step)}
              active={activeStepId === step.id}
              onClick={() => setActiveStep(step.id)}
            />
          </Draggable>
        ))}
      </Droppable>
    </DragDropContext>
    <AddStepButton onClick={handleAddStep} />
  </Section>

  <Section title="📦 範本庫">
    <TemplateList templates={templates} />
  </Section>
</Sidebar>
```

---

### 3. Main Content Area (主編輯區)

**功能:** Flow 與 Step 編輯的主要區域

#### 3.1 Flow 基本資訊編輯區

```
┌─────────────────────────────────────────────────────────┐
│ 📋 Flow 基本資訊                                         │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Flow 名稱 *                                             │
│  ┌────────────────────────────────────────────────────┐ │
│  │ 使用者管理完整測試流程                              │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  描述                                                    │
│  ┌────────────────────────────────────────────────────┐ │
│  │ 完整測試 SpecPilot Mock Server 的使用者管理        │ │
│  │ 與認證功能,包含健康檢查、認證登入、使用者 CRUD...   │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  版本                Schema 版本                        │
│  ┌──────────┐      ┌──────────────┐                   │
│  │ 1.0.0    │      │ v1.0.0  ▼   │                    │
│  └──────────┘      └──────────────┘                   │
│                                                          │
│  Base URL *                                              │
│  ┌────────────────────────────────────────────────────┐ │
│  │ http://localhost:3000                               │ │
│  └────────────────────────────────────────────────────┘ │
│  ℹ️ 此 URL 將作為所有步驟的基礎 URL                     │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**欄位說明:**
- Flow 名稱 (必填)
- 描述 (選填,支援 Markdown)
- 版本號 (選填,建議格式 x.y.z)
- Schema 版本 (下拉選單,預設最新版)
- Base URL (必填,自動驗證 URL 格式)

#### 3.2 變數管理區

```
┌─────────────────────────────────────────────────────────┐
│ 🔢 變數管理                                      [+ 新增]│
├─────────────────────────────────────────────────────────┤
│                                                          │
│  變數名稱              值                        操作    │
│  ┌─────────────────┬──────────────────────┬──────────┐ │
│  │ admin_username  │ admin                │ [✏️] [🗑️]│ │
│  ├─────────────────┼──────────────────────┼──────────┤ │
│  │ admin_password  │ ******               │ [✏️] [🗑️]│ │
│  ├─────────────────┼──────────────────────┼──────────┤ │
│  │ test_email_pre  │ newtestuser99        │ [✏️] [🗑️]│ │
│  ├─────────────────┼──────────────────────┼──────────┤ │
│  │ test_domain     │ example.com          │ [✏️] [🗑️]│ │
│  └─────────────────┴──────────────────────┴──────────┘ │
│                                                          │
│  💡 提示: 在步驟中使用 {{變數名稱}} 來引用變數           │
│     範例: username: '{{admin_username}}'                │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**功能:**
- 新增/編輯/刪除變數
- 密碼欄位自動遮罩
- 變數使用提示
- 變數引用預覽 (hover 顯示實際值)

#### 3.3 Step 編輯器

```
┌─────────────────────────────────────────────────────────┐
│ Step 3: 建立新使用者                         [複製][刪除]│
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ┌─ 基本資訊 ─────────────────────────────────────────┐ │
│ │                                                      │ │
│ │ 步驟名稱 *                                           │ │
│ │ ┌──────────────────────────────────────────────────┐│ │
│ │ │ 建立新使用者                                      ││ │
│ │ └──────────────────────────────────────────────────┘│ │
│ │                                                      │ │
│ │ 描述                                                 │ │
│ │ ┌──────────────────────────────────────────────────┐│ │
│ │ │ 建立一個新的測試使用者                            ││ │
│ │ └──────────────────────────────────────────────────┘│ │
│ └──────────────────────────────────────────────────────┘ │
│                                                          │
│ ┌─ Request ──────────────────────────────────────────┐ │
│ │                                                      │ │
│ │ Method        Path                                   │ │
│ │ ┌─────────┐  ┌─────────────────────────────────────┐│ │
│ │ │ POST ▼ │  │ /api/users                           ││ │
│ │ └─────────┘  └─────────────────────────────────────┘│ │
│ │                                                      │ │
│ │ Headers                                 [+ 新增標頭] │ │
│ │ ┌────────────────┬───────────────────────┬────────┐ │ │
│ │ │ Authorization  │ Bearer {{admin_token}}│ [🗑️]   │ │ │
│ │ ├────────────────┼───────────────────────┼────────┤ │ │
│ │ │ Content-Type   │ application/json      │ [🗑️]   │ │ │
│ │ └────────────────┴───────────────────────┴────────┘ │ │
│ │                                                      │ │
│ │ Body (JSON)                          [美化] [最小化]│ │
│ │ ┌──────────────────────────────────────────────────┐│ │
│ │ │ {                                                 ││ │
│ │ │   "name": "API 測試使用者",                       ││ │
│ │ │   "email": "{{test_email_pre}}@{{test_domain}}", ││ │
│ │ │   "role": "user",                                 ││ │
│ │ │   "status": "active"                              ││ │
│ │ │ }                                                 ││ │
│ │ └──────────────────────────────────────────────────┘│ │
│ │ ⚠️ 欄位 'email' 長度不足 (OpenAPI 要求至少 5 字元)  │ │
│ └──────────────────────────────────────────────────────┘ │
│                                                          │
│ ┌─ Expect ───────────────────────────────────────────┐ │
│ │                                                      │ │
│ │ Status Code *                                        │ │
│ │ ┌──────────┐                                        │ │
│ │ │ 201      │ ✅ Created                             │ │
│ │ └──────────┘                                        │ │
│ │                                                      │ │
│ │ Response Body (可選)                    [+ 新增欄位]│ │
│ │                                                      │ │
│ │ 欄位名稱         預期值          驗證模式      操作  │ │
│ │ ┌────────────┬──────────────┬────────────┬───────┐│ │
│ │ │ id         │ (任意值)     │ 存在即可 ▼ │ [🗑️] ││ │
│ │ ├────────────┼──────────────┼────────────┼───────┤│ │
│ │ │ name       │ API 測試使用者│ 精確匹配 ▼ │ [🗑️] ││ │
│ │ ├────────────┼──────────────┼────────────┼───────┤│ │
│ │ │ email      │ test@exa...  │ 精確匹配 ▼ │ [🗑️] ││ │
│ │ ├────────────┼──────────────┼────────────┼───────┤│ │
│ │ │ status     │ active       │ 精確匹配 ▼ │ [🗑️] ││ │
│ │ └────────────┴──────────────┴────────────┴───────┘│ │
│ │                                                      │ │
│ │ 💡 驗證模式說明:                                    │ │
│ │ • 存在即可: 欄位存在即通過,值不限 (YAML: null)      │ │
│ │ • 精確匹配: 必須完全相同 (YAML: "具體值")           │ │
│ │ • 需要模糊匹配時,請使用下方 Validation 規則         │ │
│ └──────────────────────────────────────────────────────┘ │
│                                                          │
│ ┌─ Validation ────────────────────────────[+ 新增規則]┐ │
│ │                                                      │ │
│ │ 規則類型      Path              Value          操作  │ │
│ │ ┌──────────┬─────────────────┬─────────────┬──────┐│ │
│ │ │ notNull ▼│ id              │             │ [🗑️] ││ │
│ │ ├──────────┼─────────────────┼─────────────┼──────┤│ │
│ │ │ contains▼│ name            │ API 測試    │ [🗑️] ││ │
│ │ ├──────────┼─────────────────┼─────────────┼──────┤│ │
│ │ │ regex   ▼│ email           │ ^.+@.+\..+$ │ [🗑️] ││ │
│ │ └──────────┴─────────────────┴─────────────┴──────┘│ │
│ └──────────────────────────────────────────────────────┘ │
│                                                          │
│ ┌─ Capture ──────────────────────────────[+ 新增變數]─┐ │
│ │                                                      │ │
│ │ 變數名稱          從 Response 擷取路徑        操作   │ │
│ │ ┌──────────────┬────────────────────────┬─────────┐│ │
│ │ │ new_user_id  │ id                     │ [🗑️]    ││ │
│ │ ├──────────────┼────────────────────────┼─────────┤│ │
│ │ │ new_user_email│ email                 │ [🗑️]    ││ │
│ │ └──────────────┴────────────────────────┴─────────┘│ │
│ │                                                      │ │
│ │ 💡 擷取的變數可在後續步驟中使用 {{new_user_id}}      │ │
│ └──────────────────────────────────────────────────────┘ │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**元件功能:**

1. **基本資訊區塊**
   - 步驟名稱 (必填)
   - 描述 (選填)

2. **Request 區塊**
   - HTTP Method 下拉選單 (GET, POST, PUT, PATCH, DELETE)
   - Path 輸入框 (支援變數插值自動完成)
   - Headers 編輯器 (key-value pairs)
   - Body 編輯器 (JSON,支援語法高亮、格式化)

3. **Expect 區塊**
   - Status Code 輸入 (常用狀態碼快速選擇)
   - Response Body 預期值 (Table 表單模式)
   - 支援三種驗證模式:
     - **存在即可** (YAML: null) - 只驗證欄位存在
     - **精確匹配** (YAML: "具體值") - 必須完全相同
     - **類型驗證** (選填,未來擴充)

4. **Validation 區塊**
   - 驗證規則列表
   - 規則類型: notNull, regex, contains
   - JSON Path 輸入 (支援自動完成)
   - 與 Expect Body 配合使用 (互補而非重複)

5. **Capture 區塊**
   - 變數擷取設定
   - JSON Path 輸入
   - 變數名稱定義

---

### 4. Right Panel (右側面板,可摺疊)

**功能:** 即時預覽、驗證錯誤、輔助資訊

#### 4.1 Tab 切換

```
┌──────────────────────────────────────┐
│ [YAML 預覽] [驗證] [說明]             │
├──────────────────────────────────────┤
│                                      │
│  (依選擇的 Tab 顯示不同內容)         │
│                                      │
└──────────────────────────────────────┘
```

#### 4.2 YAML 預覽 Tab

```
┌──────────────────────────────────────┐
│ YAML 預覽                   [複製]   │
├──────────────────────────────────────┤
│                                      │
│ name: 使用者管理完整測試流程          │
│ description: |                       │
│   完整測試 SpecPilot Mock Server... │
│ version: 1.0.0                       │
│ baseUrl: http://localhost:3000       │
│                                      │
│ variables:                           │
│   admin_username: admin              │
│   admin_password: '1234562'          │
│   test_email_prefix: newtestuser99   │
│                                      │
│ steps:                               │
│   - name: 建立新使用者                │
│     request:                         │
│       method: POST                   │
│       path: /api/users               │
│       body:                          │
│         name: API 測試使用者          │
│         email: '{{test_email_pr...   │
│                                      │
│ (可滾動查看完整內容)                  │
│                                      │
└──────────────────────────────────────┘
```

**功能:**
- 即時顯示產生的 YAML
- 語法高亮
- 複製到剪貼簿
- 可滾動查看完整內容

#### 4.3 驗證 Tab

```
┌──────────────────────────────────────┐
│ 驗證結果                              │
├──────────────────────────────────────┤
│                                      │
│ ✅ Zod Schema 驗證通過                │
│                                      │
│ ⚠️ 發現 2 個警告                     │
│                                      │
│ ┌──────────────────────────────────┐│
│ │ ⚠️ Step 3: 建立新使用者           ││
│ │                                  ││
│ │ OpenAPI 衝突:                    ││
│ │ • 欄位 'email' 長度不足          ││
│ │   要求: 最少 5 字元               ││
│ │   實際: 4 字元                    ││
│ │                                  ││
│ │ [查看詳情] [前往修正]            ││
│ └──────────────────────────────────┘│
│                                      │
│ ┌──────────────────────────────────┐│
│ │ ⚠️ Step 5: 更新使用者資料         ││
│ │                                  ││
│ │ 變數未定義:                       ││
│ │ • {{update_user_id}} 尚未擷取    ││
│ │                                  ││
│ │ [查看詳情] [前往修正]            ││
│ └──────────────────────────────────┘│
│                                      │
│ ❌ 發現 0 個錯誤                     │
│                                      │
└──────────────────────────────────────┘
```

**功能:**
- Zod Schema 驗證狀態
- OpenAPI 衝突警告
- 變數未定義警告
- 點擊跳轉到對應步驟

#### 4.4 說明 Tab

```
┌──────────────────────────────────────┐
│ 快速說明                              │
├──────────────────────────────────────┤
│                                      │
│ 📖 變數使用                           │
│ • 定義變數: 在「變數管理」中新增      │
│ • 使用變數: {{變數名稱}}              │
│ • 範例: username: '{{admin_user}}'   │
│                                      │
│ 📖 驗證規則                           │
│ • notNull: 檢查欄位不為 null         │
│ • regex: 正則表達式驗證               │
│ • contains: 包含指定文字              │
│                                      │
│ 📖 變數擷取                           │
│ • 從 Response 擷取資料存為變數        │
│ • 使用 JSON Path 語法                │
│ • 範例: id → 擷取 response.id        │
│                                      │
│ 📖 快捷鍵                             │
│ • Ctrl+S: 儲存                       │
│ • Ctrl+E: 匯出                       │
│ • Ctrl+P: 預覽                       │
│                                      │
└──────────────────────────────────────┘
```

**功能:**
- 快速使用說明
- 語法參考
- 範例程式碼
- 快捷鍵列表

---

## 互動流程

### 使用者操作流程

#### 1. 建立新 Flow

```
使用者操作                    系統回應
───────────────────────────────────────────
點擊「新增」按鈕      →      開啟新 Flow 對話框
                             ├─ 選擇空白 Flow
                             ├─ 從範本建立
                             └─ 從 OpenAPI 生成

選擇「空白 Flow」     →      導航到編輯頁面
                             預設游標在 Flow 名稱欄位

輸入基本資訊          →      即時 Zod 驗證
                             顯示驗證錯誤 (紅色底線)

點擊「新增步驟」      →      建立第一個 Step
                             展開 Step 編輯區
                             預設游標在步驟名稱欄位
```

#### 2. 編輯 Step

```
使用者操作                    系統回應
───────────────────────────────────────────
在 Step 名稱輸入文字   →      左側 Sidebar 同步更新
                             Step 列表顯示新名稱

選擇 HTTP Method      →      更新右側 YAML 預覽
                             (即時更新)

輸入 Request Path     →      自動完成變數提示
                             顯示 {{variable}} 建議

輸入 Request Body     →      JSON 格式驗證
                             語法高亮
                             OpenAPI 衝突檢查 (如有上傳)

新增 Validation 規則  →      規則類型改變時
                             自動調整 Value 欄位型別
                             (regex 顯示正則輸入框)

新增 Capture 變數     →      變數名稱加入變數清單
                             後續 Step 可引用
```

#### 3. 預覽與匯出

```
使用者操作                    系統回應
───────────────────────────────────────────
點擊「預覽」按鈕      →      開啟全螢幕 Modal
                             ├─ 左側: YAML 預覽
                             ├─ 右側: JSON Schema 預覽
                             └─ 底部: 驗證結果

在 Modal 中切換 Tab   →      切換顯示內容
                             保持 Modal 開啟

點擊「匯出」按鈕      →      開啟匯出選項對話框
                             ├─ 匯出為 YAML
                             ├─ 匯出為 YAML + Schema
                             ├─ 複製 YAML 到剪貼簿
                             └─ 儲存到 SpecPilot 專案

選擇匯出選項          →      下載檔案 / 複製內容
                             顯示成功訊息
```

---

## 視覺設計規範

### 色彩系統

**主色調 (Primary):**
```
Primary:     #3B82F6 (藍色 - 專業、可信賴)
Primary-600: #2563EB
Primary-700: #1D4ED8
```

**語意顏色:**
```
Success: #10B981 (綠色 - 驗證通過)
Warning: #F59E0B (橘色 - 警告)
Error:   #EF4444 (紅色 - 錯誤)
Info:    #3B82F6 (藍色 - 資訊)
```

**灰階:**
```
Gray-50:  #F9FAFB (背景)
Gray-100: #F3F4F6 (次要背景)
Gray-200: #E5E7EB (邊框)
Gray-300: #D1D5DB
Gray-400: #9CA3AF (次要文字)
Gray-500: #6B7280
Gray-600: #4B5563
Gray-700: #374151
Gray-800: #1F2937
Gray-900: #111827 (主要文字)
```

### 字型系統

**字體:**
```
Sans:      'Inter', system-ui, sans-serif
Mono:      'JetBrains Mono', 'Fira Code', monospace
```

**字級:**
```
xs:   0.75rem  (12px) - 輔助說明
sm:   0.875rem (14px) - 次要文字
base: 1rem     (16px) - 主要文字
lg:   1.125rem (18px) - 小標題
xl:   1.25rem  (20px) - 標題
2xl:  1.5rem   (24px) - 大標題
```

**字重:**
```
normal:   400 - 正文
medium:   500 - 強調文字
semibold: 600 - 小標題
bold:     700 - 標題
```

### 間距系統

```
xs:  4px   (0.25rem)
sm:  8px   (0.5rem)
md:  16px  (1rem)
lg:  24px  (1.5rem)
xl:  32px  (2rem)
2xl: 48px  (3rem)
```

### 圓角

```
sm: 4px   - 按鈕、輸入框
md: 8px   - 卡片
lg: 12px  - Modal
xl: 16px  - 大型容器
```

### 陰影

```
sm: 0 1px 2px rgba(0, 0, 0, 0.05)
md: 0 4px 6px rgba(0, 0, 0, 0.1)
lg: 0 10px 15px rgba(0, 0, 0, 0.1)
xl: 0 20px 25px rgba(0, 0, 0, 0.15)
```

---

## 元件樣式規範

### Button (按鈕)

**類型:**

1. **Primary Button** - 主要操作
```
背景: Primary (#3B82F6)
文字: White
高度: 40px
Padding: 12px 24px
圓角: 6px
Hover: Primary-600
```

2. **Secondary Button** - 次要操作
```
背景: White
邊框: Gray-300
文字: Gray-700
Hover: Gray-50
```

3. **Ghost Button** - 輕量操作
```
背景: Transparent
文字: Gray-600
Hover: Gray-100
```

4. **Danger Button** - 危險操作
```
背景: Error (#EF4444)
文字: White
Hover: Error-600
```

### Input (輸入框)

```
高度: 40px
Padding: 8px 12px
邊框: 1px solid Gray-300
圓角: 6px
字體: base (16px)

Focus:
├─ 邊框: Primary
└─ 陰影: 0 0 0 3px rgba(59, 130, 246, 0.1)

Error:
├─ 邊框: Error
└─ 陰影: 0 0 0 3px rgba(239, 68, 68, 0.1)
```

### Card (卡片)

```
背景: White
邊框: 1px solid Gray-200
圓角: 8px
陰影: sm
Padding: 16px

標題:
├─ 字級: lg
├─ 字重: semibold
└─ 顏色: Gray-900
```

### Select (下拉選單)

```
高度: 40px
背景: White
邊框: 1px solid Gray-300
圓角: 6px
Icon: Chevron Down

Hover:
└─ 邊框: Gray-400

Focus:
└─ 邊框: Primary

Options:
├─ 背景: White
├─ Hover: Gray-50
├─ Selected: Primary-50
└─ 陰影: md
```

---

## 響應式設計

### 斷點

```
sm:  640px   - 手機橫向
md:  768px   - 平板直向
lg:  1024px  - 平板橫向 / 小筆電
xl:  1280px  - 筆電
2xl: 1536px  - 桌機
```

### 佈局調整

**< 768px (Mobile):**
```
├─ 隱藏 Left Sidebar (改為 Drawer)
├─ 隱藏 Right Panel (改為 Bottom Sheet)
└─ Single Column 佈局
```

**768px - 1024px (Tablet):**
```
├─ Left Sidebar 可摺疊
├─ Right Panel 可摺疊
└─ 彈性寬度調整
```

**> 1024px (Desktop):**
```
├─ 完整三欄佈局
└─ 固定 Sidebar 寬度
```

---

## 無障礙設計 (Accessibility)

### ARIA 標籤

```tsx
<button aria-label="新增測試步驟">
  <PlusIcon />
</button>

<input
  aria-describedby="email-hint"
  aria-invalid={errors.email ? "true" : "false"}
/>

<div role="alert" aria-live="polite">
  驗證錯誤: 欄位不可為空
</div>
```

### 鍵盤導航

**支援快捷鍵:**
```
Ctrl/Cmd + S: 儲存
Ctrl/Cmd + E: 匯出
Ctrl/Cmd + P: 預覽
Ctrl/Cmd + N: 新增 Step
Ctrl/Cmd + D: 複製 Step
Tab:          下一個欄位
Shift + Tab:  上一個欄位
Esc:          關閉 Modal
```

**Focus 管理:**
- 所有互動元件可使用 Tab 導航
- 清晰的 Focus 視覺提示
- Modal 開啟時 Focus 移至 Modal
- Modal 關閉時 Focus 返回觸發元素

### 色彩對比

**WCAG AA 標準:**
```
正文 (Gray-900 on White):       對比度 ≥ 4.5:1
大字 (Gray-700 on White):       對比度 ≥ 3:1
按鈕文字 (White on Primary):    對比度 ≥ 4.5:1
```

---

## UI 元件庫選擇建議

### 推薦方案: Shadcn/ui

**優點:**
- ✅ 基於 Radix UI (無障礙友善)
- ✅ Headless 設計,完全可客製化
- ✅ TypeScript 支援
- ✅ 與 Tailwind CSS 完美整合
- ✅ 複製即用,不需額外依賴

**核心元件:**
```
- Button
- Input
- Select
- Textarea
- Card
- Dialog (Modal)
- Tabs
- Accordion
- Alert
- Badge
- Dropdown Menu
- Form (整合 React Hook Form)
```

### 替代方案

| UI 庫 | 優點 | 缺點 | 推薦度 |
|-------|------|------|--------|
| Ant Design | 元件豐富、中文友善 | 包體積大、客製化困難 | ⭐⭐⭐ |
| MUI | 成熟穩定、文件完整 | 學習曲線陡、樣式覆蓋複雜 | ⭐⭐⭐ |
| Chakra UI | API 簡潔、主題系統強大 | 效能較差、包體積大 | ⭐⭐ |
| Headless UI | 輕量、完全客製化 | 需自行實作樣式 | ⭐⭐⭐⭐ |

---

## 特殊元件設計

### JSON Editor (Request Body / Expect Body)

**技術選型:** Monaco Editor (VS Code 編輯器核心)

**功能:**
```
✅ 語法高亮
✅ 自動完成 (變數名稱)
✅ 括號配對
✅ JSON 格式驗證
✅ 格式化 (Prettier)
✅ 錯誤提示 (紅色底線)
✅ 摺疊/展開
```

**配置範例:**
```tsx
import Editor from '@monaco-editor/react';

<Editor
  height="200px"
  language="json"
  theme="vs-light"
  value={requestBody}
  onChange={handleBodyChange}
  options={{
    minimap: { enabled: false },
    lineNumbers: 'on',
    formatOnPaste: true,
    formatOnType: true,
    autoIndent: 'full',
    tabSize: 2,
  }}
/>
```

### Variable Autocomplete (變數自動完成)

**實作方式:**

1. **在 Input 中偵測 `{{`**
2. **顯示變數建議清單**
3. **選擇後自動插入 `{{variable}}`**

```tsx
function VariableInput({ variables, value, onChange }) {
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [cursorPosition, setCursorPosition] = useState(0);

  const handleChange = (e) => {
    const newValue = e.target.value;
    const cursor = e.target.selectionStart;

    // 偵測 {{ 開頭
    if (newValue.slice(cursor - 2, cursor) === '{{') {
      setShowSuggestions(true);
      setCursorPosition(cursor);
    }

    onChange(newValue);
  };

  const insertVariable = (varName) => {
    const before = value.slice(0, cursorPosition);
    const after = value.slice(cursorPosition);
    onChange(`${before}${varName}}}${after}`);
    setShowSuggestions(false);
  };

  return (
    <>
      <Input value={value} onChange={handleChange} />
      {showSuggestions && (
        <Suggestions>
          {variables.map(v => (
            <SuggestionItem onClick={() => insertVariable(v.name)}>
              {v.name}
            </SuggestionItem>
          ))}
        </Suggestions>
      )}
    </>
  );
}
```

---

## 動畫與過渡效果

### 過渡時間

```
快速: 150ms  - Hover, Focus
正常: 300ms  - Modal 開啟/關閉, Tab 切換
緩慢: 500ms  - Page 切換
```

### 緩動函數

```
ease-in:     cubic-bezier(0.4, 0, 1, 1)      - 加速
ease-out:    cubic-bezier(0, 0, 0.2, 1)      - 減速
ease-in-out: cubic-bezier(0.4, 0, 0.2, 1)    - 加速後減速
```

### 常用動畫

**Fade In/Out:**
```css
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-enter {
  animation: fadeIn 300ms ease-out;
}
```

**Slide Down (Accordion):**
```css
@keyframes slideDown {
  from {
    height: 0;
    opacity: 0;
  }
  to {
    height: var(--radix-accordion-content-height);
    opacity: 1;
  }
}
```

**Scale (Button Hover):**
```css
.button:hover {
  transform: scale(1.02);
  transition: transform 150ms ease-out;
}
```

---

## 錯誤狀態設計

### 表單驗證錯誤

```
┌────────────────────────────────────────┐
│ Flow 名稱 *                            │
│ ┌────────────────────────────────────┐ │
│ │                                    │ │ ← 紅色邊框
│ └────────────────────────────────────┘ │
│ ❌ Flow 名稱不可為空                   │ ← 錯誤訊息 (紅色)
└────────────────────────────────────────┘
```

### OpenAPI 衝突警告

```
┌────────────────────────────────────────┐
│ Body (JSON)                            │
│ ┌────────────────────────────────────┐ │
│ │ {                                  │ │
│ │   "email": "test@example.com"      │ │ ← 橘色底線
│ │ }                                  │ │
│ └────────────────────────────────────┘ │
│ ⚠️ 欄位 'email' 長度不足               │ ← 警告訊息 (橘色)
│    OpenAPI 要求至少 5 字元              │
└────────────────────────────────────────┘
```

### 變數未定義提示

```
┌────────────────────────────────────────┐
│ Path                                   │
│ ┌────────────────────────────────────┐ │
│ │ /api/users/{{user_id}}             │ │ ← 變數高亮 (橘色背景)
│ └────────────────────────────────────┘ │
│ ⚠️ 變數 {{user_id}} 尚未定義           │
│    [前往定義變數]                       │
└────────────────────────────────────────┘
```

---

## 成功狀態設計

### 儲存成功

```
┌────────────────────────────────────────┐
│ ✅ Flow 已自動儲存 (2 秒前)            │ ← Toast 通知
└────────────────────────────────────────┘
```

### 匯出成功

```
┌────────────────────────────────────────┐
│ ✅ 已匯出 2 個檔案                     │
│    • user-flow.yaml                    │
│    • user-flow.schema.json             │
└────────────────────────────────────────┘
```

### 驗證通過

```
┌────────────────────────────────────────┐
│ ✅ 所有驗證通過                        │
│    • Zod Schema: 通過                  │
│    • JSON Schema: 通過                 │
│    • OpenAPI: 無衝突                   │
└────────────────────────────────────────┘
```

---

## 載入狀態設計

### Skeleton Loading

```
┌────────────────────────────────────────┐
│ ┌────────────────────────────────────┐ │
│ │ ▓▓▓▓▓▓▓▓▓▓                        │ │ ← 灰色矩形閃爍
│ └────────────────────────────────────┘ │
│                                        │
│ ┌────────────────────────────────────┐ │
│ │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
```

### Spinner Loading

```
┌────────────────────────────────────────┐
│              ⏳ 載入中...              │
│           (旋轉的圓圈動畫)              │
└────────────────────────────────────────┘
```

---

## 空狀態設計

### 無 Steps

```
┌────────────────────────────────────────┐
│                                        │
│              📋                        │
│                                        │
│        尚未建立任何測試步驟             │
│                                        │
│   [+ 新增第一個步驟]  [從範本開始]     │
│                                        │
└────────────────────────────────────────┘
```

### 無變數

```
┌────────────────────────────────────────┐
│              🔢                        │
│                                        │
│        尚未定義任何變數                 │
│                                        │
│         [+ 新增變數]                   │
└────────────────────────────────────────┘
```

---

## OpenAPI 整合功能

### OpenAPI 上傳區

**位置:** Left Sidebar 頂部 (Flow 資訊區塊上方)

**未上傳狀態:**

```
┌──────────────────┐
│ 📄 OpenAPI 規格  │
│                  │
│ [上傳 OpenAPI]   │
│                  │
│ 💡 上傳後可:     │
│ • 查看 API 清單  │
│ • 自動生成測試   │
│ • 智能驗證       │
└──────────────────┘
```

**已上傳狀態:**

```
┌──────────────────┐
│ 📄 OpenAPI 規格  │
├──────────────────┤
│ ✅ api.yaml      │
│ • 12 個端點      │
│ • Base URL:      │
│   localhost:3000 │
│                  │
│ [查看清單]       │
│ [重新上傳]       │
└──────────────────┘
```

---

### API 端點清單 Modal

**觸發:** 點擊 Sidebar 的「查看清單」或 Header 的「從 OpenAPI 生成」

```
┌─────────────────────────────────────────────────────────┐
│ API 端點清單                                    [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 🔍 [搜尋 API...]                                         │
│                                                          │
│ 篩選: [全部 ▼] [GET] [POST] [PUT] [DELETE]              │
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │                                                     │ │
│ │ 🔐 Auth (2)                                         │ │
│ │ ├─ POST   /api/auth/login        [+ 新增測試]     │ │
│ │ └─ POST   /api/auth/register     [+ 新增測試]     │ │
│ │                                                     │ │
│ │ 👤 Users (5)                                        │ │
│ │ ├─ GET    /api/users              [+ 新增測試]     │ │
│ │ ├─ POST   /api/users              [+ 新增測試]     │ │
│ │ ├─ GET    /api/users/{id}         [+ 新增測試]     │ │
│ │ ├─ PUT    /api/users/{id}         [+ 新增測試]     │ │
│ │ └─ DELETE /api/users/{id}         [+ 新增測試]     │ │
│ │                                                     │ │
│ │ ❤️ Health (1)                                       │ │
│ │ └─ GET    /health                 [+ 新增測試]     │ │
│ │                                                     │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ [批次生成全部]                                           │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**互動行為:**

1. **點擊單一「+ 新增測試」:**
   - 自動建立 Step
   - 填入 Method + Path
   - 根據 OpenAPI schema 生成 Request Body 範例
   - 自動設定 Status Code
   - 建議 Validation 規則

2. **點擊「批次生成全部」:**
   - 開啟批次生成設定 Modal (見下方)

---

### 批次生成測試 Modal

```
┌─────────────────────────────────────────────────────────┐
│ 🚀 批次生成測試流程                            [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 選擇要生成的 API:                                        │
│                                                          │
│ ☑️ Auth                                                  │
│ ├─ ☑️ POST /api/auth/login                              │
│ └─ ☐  POST /api/auth/register                          │
│                                                          │
│ ☑️ Users (CRUD)                                          │
│ ├─ ☑️ GET    /api/users          (查詢列表)            │
│ ├─ ☑️ POST   /api/users          (建立)                │
│ ├─ ☑️ GET    /api/users/{id}     (查詢單筆)            │
│ ├─ ☑️ PUT    /api/users/{id}     (更新)                │
│ └─ ☑️ DELETE /api/users/{id}     (刪除)                │
│                                                          │
│ 測試選項:                                                │
│ ☑️ 包含認證流程 (先執行登入取得 token)                   │
│ ☑️ 自動串接步驟 (使用 capture 傳遞資料)                 │
│ ☑️ 包含錯誤情境 (401, 404, 400 等)                      │
│ ☑️ 自動建議驗證規則                                     │
│                                                          │
│ 📊 預覽: 將建立 15 個測試步驟                            │
│                                                          │
│ [取消] [生成測試流程]                                    │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**生成後:**
- 自動建立所有 Steps
- 自動串接 capture 變數
- 顯示成功訊息

```
┌────────────────────────────────────┐
│ ✅ 已生成 15 個測試步驟            │
│                                    │
│ • 認證流程: 1 步                   │
│ • CRUD 操作: 10 步                 │
│ • 錯誤情境: 4 步                   │
│                                    │
│ [開始編輯]                         │
└────────────────────────────────────┘
```

---

### Request Body 智能編輯器 (OpenAPI 整合)

**在 Step 編輯器的 Request Body 區域:**

```
┌─────────────────────────────────────────────────────────┐
│ Body (JSON)                [美化] [最小化] [從 API 生成]│
├─────────────────────────────────────────────────────────┤
│                                                          │
│ {                                                        │
│   "username": "     ← 輸入時顯示自動完成                │
│                                                          │
│   ┌─────────────────────────────────────────┐          │
│   │ 💡 OpenAPI Schema 建議:                 │          │
│   │                                          │          │
│   │ • username (string, required)           │          │
│   │   minLength: 3                          │          │
│   │   範例: "john_doe"                       │          │
│   │                                          │          │
│   │ • email (string, format: email)         │          │
│   │   範例: "user@example.com"              │          │
│   │                                          │          │
│   │ • password (string, minLength: 6)       │          │
│   │   範例: "password123"                    │          │
│   └─────────────────────────────────────────┘          │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**即時驗證警告:**

```
┌─────────────────────────────────────────────────────────┐
│ Body (JSON)                                              │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ {                                                        │
│   "username": "ab",      ← 橘色波浪底線                  │
│   "email": "invalid",    ← 紅色波浪底線                  │
│   "age": 15              ← 橘色波浪底線                  │
│ }                                                        │
│                                                          │
│ ⚠️ 發現 3 個與 OpenAPI 規格的差異:                       │
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ 1. username: "ab"                                   │ │
│ │    長度不足 (最少 3 字元)                           │ │
│ │    建議: "abc" 或 "john_doe"                        │ │
│ │    [自動修正]                                       │ │
│ │                                                     │ │
│ │ 2. email: "invalid"                                 │ │
│ │    不是有效的 email 格式                            │ │
│ │    建議: "user@example.com"                         │ │
│ │    [自動修正]                                       │ │
│ │                                                     │ │
│ │ 3. age: 15                                          │ │
│ │    數值過小 (最小值 18)                             │ │
│ │    建議: 18                                         │ │
│ │    [自動修正]                                       │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ [一鍵修正全部] [忽略警告]                                │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

### Expect Body 驗證模式設計

**設計理念:** 提供簡潔的欄位值驗證方式,降低簡單測試場景的複雜度。

#### 驗證模式說明

**三種驗證模式:**

| 驗證模式 | UI 顯示 | YAML 輸出 | 用途 | 範例 |
|---------|---------|-----------|------|------|
| **存在即可** | (任意值) | `null` | 只驗證欄位存在,值不限 | 自動生成的 ID |
| **精確匹配** | 具體值 | `"王大明"` | 必須完全相同 | 使用者名稱 |
| **類型驗證** | (未來擴充) | `{ type: "string" }` | 只驗證類型 | - |

**使用情境:**

```yaml
# 範例: 建立使用者後驗證 Response
expect:
  statusCode: 201
  body:
    id: null                    # 存在即可 (ID 由系統生成,無法預測)
    name: "王大明"               # 精確匹配 (必須與 Request 一致)
    email: "test@example.com"   # 精確匹配
    status: "active"            # 精確匹配 (預設值)
    createdAt: null             # 存在即可 (時間戳由系統生成)
```

#### UI 設計

**Expect Body 表單模式:**

```
┌─────────────────────────────────────────────────────────┐
│ ┌─ Expect ───────────────────────────────────────────┐ │
│ │                                                      │ │
│ │ Status Code *                                        │ │
│ │ ┌──────────┐                                        │ │
│ │ │ 201      │ ✅ Created                             │ │
│ │ └──────────┘                                        │ │
│ │                                                      │ │
│ │ Response Body (可選)                    [+ 新增欄位]│ │
│ │                                                      │ │
│ │ 欄位名稱        預期值           驗證模式      操作  │ │
│ │ ┌───────────┬───────────────┬────────────┬───────┐│ │
│ │ │ id        │ (任意值)      │ 存在即可 ▼ │ [🗑️] ││ │
│ │ ├───────────┼───────────────┼────────────┼───────┤│ │
│ │ │ name      │ 王大明        │ 精確匹配 ▼ │ [🗑️] ││ │
│ │ ├───────────┼───────────────┼────────────┼───────┤│ │
│ │ │ email     │ test@exa...   │ 精確匹配 ▼ │ [🗑️] ││ │
│ │ ├───────────┼───────────────┼────────────┼───────┤│ │
│ │ │ status    │ active        │ 精確匹配 ▼ │ [🗑️] ││ │
│ │ ├───────────┼───────────────┼────────────┼───────┤│ │
│ │ │ createdAt │ (任意值)      │ 存在即可 ▼ │ [🗑️] ││ │
│ │ └───────────┴───────────────┴────────────┴───────┘│ │
│ │                                                      │ │
│ │ 💡 提示:                                            │ │
│ │ • 存在即可: 欄位存在即通過 (YAML: null)             │ │
│ │ • 精確匹配: 必須完全相同 (YAML: "具體值")           │ │
│ │ • 需要模糊匹配或正則驗證時,使用下方 Validation 規則 │ │
│ └──────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### 與 Validation 規則的配合使用

**設計原則:** Expect Body 與 Validation 互補,而非重複。

**使用場景對照:**

| 驗證需求 | 使用方式 | 範例 |
|---------|---------|------|
| 欄位必須存在 | Expect Body: 存在即可 | `id: null` |
| 欄位值精確匹配 | Expect Body: 精確匹配 | `name: "王大明"` |
| 欄位值包含特定文字 | Validation: contains | `contains: name, "王"` |
| 欄位值符合格式 | Validation: regex | `regex: email, ^.+@.+\..+$` |
| 欄位值不為 null | Validation: notNull | `notNull: status` |

**完整範例:**

```yaml
# 綜合使用 Expect Body + Validation
expect:
  statusCode: 201
  body:
    id: null                    # Expect: 存在即可
    name: "王大明"               # Expect: 精確匹配
    email: "test@example.com"   # Expect: 精確匹配
    status: "active"            # Expect: 精確匹配

validation:
  # Expect Body 已驗證基本值,這裡加強格式驗證
  - rule: regex
    path: email
    value: ^.+@.+\..+$         # 確保 email 格式正確

  - rule: regex
    path: createdAt
    value: ^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}  # ISO 8601 格式

  # 業務邏輯驗證 (Expect Body 無法表達)
  - rule: contains
    path: name
    value: "王"                # 名字必須包含「王」
```

#### 互動行為

**新增欄位:**

```
步驟 1: 點擊「+ 新增欄位」
───────────────────────────────────────
系統新增一行空白欄位

步驟 2: 輸入欄位名稱
───────────────────────────────────────
輸入: id

步驟 3: 選擇驗證模式
───────────────────────────────────────
下拉選單:
• 存在即可 (預設)
• 精確匹配

步驟 4: 輸入預期值 (如選擇「精確匹配」)
───────────────────────────────────────
輸入: 王大明

結果:
YAML 輸出: name: "王大明"
```

**從 Request Body 自動填充 (未來擴充):**

```
當使用者在 Request Body 填入:
{
  "name": "王大明",
  "email": "test@example.com"
}

系統提供快速按鈕:
[📋 從 Request Body 複製到 Expect]

點擊後自動填充 Expect Body:
• name: "王大明" (精確匹配)
• email: "test@example.com" (精確匹配)
```

#### 技術實作考量

**資料結構:**

```typescript
interface ExpectBodyField {
  fieldName: string;
  expectedValue: string | null;  // null = 存在即可, string = 精確匹配
  validationMode: 'any' | 'exact' | 'type';
}

interface ExpectConfig {
  statusCode: number;
  body: ExpectBodyField[];
}
```

**YAML 轉換邏輯:**

```typescript
// UI → YAML
function convertToYAML(fields: ExpectBodyField[]): object {
  const body: Record<string, any> = {};

  fields.forEach(field => {
    if (field.validationMode === 'any') {
      body[field.fieldName] = null;  // 存在即可
    } else if (field.validationMode === 'exact') {
      body[field.fieldName] = field.expectedValue;  // 精確匹配
    }
  });

  return body;
}

// 範例輸出
{
  id: null,
  name: "王大明",
  email: "test@example.com"
}
```

**優先級規劃:**

- **P0 (MVP):**
  - ✅ 表單模式編輯 Expect Body
  - ✅ 兩種驗證模式: 存在即可、精確匹配
  - ✅ 新增/刪除欄位

- **P1 (第一版):**
  - ✅ 從 OpenAPI Response Schema 自動填充欄位名稱
  - ✅ 驗證模式說明 Tooltip
  - ✅ 欄位名稱自動完成 (基於 OpenAPI)

- **P2 (進階):**
  - ⭐ 從 Request Body 複製到 Expect
  - ⭐ 類型驗證模式 (type: string/number/boolean)
  - ⭐ 巢狀物件支援 (使用 JSON Path)

---

### 驗證規則自動建議

**設計理念:** 採用「智能建議 + 手動編輯」混合模式,降低使用者負擔同時保持彈性。

#### 資料來源與模式

**三種 Validation 建立方式:**

1. **從 OpenAPI Schema 自動建議** (推薦,降低錯誤)
   - 解析 Response Schema 的 `required`、`format`、`pattern` 等欄位
   - 自動產生對應的驗證規則建議
   - 使用者可選擇性套用

2. **手動建立** (完全彈性)
   - 點擊「+ 新增規則」手動輸入
   - 適用於業務邏輯驗證 (OpenAPI 無法表達的規則)

3. **混合模式** (實際使用情境)
   - 先套用 OpenAPI 建議的基礎規則
   - 再手動新增額外的業務驗證規則

#### OpenAPI Schema → Validation 對應表

| OpenAPI Schema 定義 | 自動建議的規則 | 建議原因 |
|---------------------|----------------|----------|
| `required: ['id']` | `notNull: id` | 欄位為必填 |
| `format: 'email'` | `regex: ^.+@.+\..+$` | Email 格式驗證 |
| `format: 'date-time'` | `regex: ^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}` | ISO 8601 日期格式 |
| `pattern: '^[A-Z]'` | `regex: ^[A-Z]` | 自訂正則表達式 |
| `enum: ['active', 'inactive']` | `contains: status, "active"` | 列舉值驗證 (範例) |

**注意:** `minLength`、`maxLength` 等限制不自動建立規則,僅在 Request Body 編輯時顯示警告。

#### UI 設計

**在 Validation 區塊下方顯示:**

```
┌─────────────────────────────────────────────────────────┐
│ ┌─ Validation ────────────────────────────[+ 新增規則]┐ │
│ │                                                      │ │
│ │ 規則類型      Path              Value          操作  │ │
│ │ ┌──────────┬─────────────────┬─────────────┬──────┐│ │
│ │ │ notNull ▼│ id              │             │ [🗑️] ││ │ ← 已套用 (來源: OpenAPI)
│ │ ├──────────┼─────────────────┼─────────────┼──────┤│ │
│ │ │ contains▼│ name            │ 測試使用者   │ [🗑️] ││ │ ← 手動新增
│ │ └──────────┴─────────────────┴─────────────┴──────┘│ │
│ │                                                      │ │
│ └──────────────────────────────────────────────────────┘ │
│                                                          │
│ 💡 根據 OpenAPI Response Schema 建議 (來源: POST /api/users):│
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ ☑️ id (必填欄位)                          [已套用]  │ │
│ │   • notNull: id                                     │ │
│ │   📌 來源: OpenAPI required 欄位                    │ │
│ │                                                     │ │
│ │ ☐ username (必填欄位)                               │ │
│ │   • notNull: username                    [套用]     │ │
│ │   📌 來源: OpenAPI required 欄位                    │ │
│ │                                                     │ │
│ │ ☐ email (必填 + 格式驗證)                           │ │
│ │   • notNull: email                       [套用]     │ │
│ │   • regex: ^.+@.+\..+$                   [套用]     │ │
│ │   📌 來源: OpenAPI required + format: email         │ │
│ │                                                     │ │
│ │ ☐ createdAt (日期時間格式)                          │ │
│ │   • regex: ^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}    │ │
│ │   📌 來源: OpenAPI format: date-time                │ │
│ │                                          [套用]     │ │
│ │                                                     │ │
│ │ ☐ age (數值範圍限制)                                │ │
│ │   ⚠️ minLength/maxLength 暫不支援自動驗證          │ │
│ │   💡 建議: 在 Request Body 階段檢查                │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ [全選] [全不選] [套用選取的規則] [重新分析 Schema]      │
│                                                          │
│ ℹ️ 提示: 已套用的規則會自動加入上方列表                │
└─────────────────────────────────────────────────────────┘
```

#### 互動行為

**初次載入 Step:**
1. 系統偵測到 OpenAPI 已上傳
2. 根據當前 Step 的 Method + Path 找到對應的 Response Schema
3. 自動解析並顯示建議規則面板

**使用者操作流程:**

```
步驟 1: 查看建議規則
───────────────────────────────────────
使用者看到 4 個建議規則
• id (notNull) - 必填欄位
• username (notNull) - 必填欄位
• email (notNull + regex) - 必填 + 格式驗證
• createdAt (regex) - 日期格式

步驟 2: 選擇要套用的規則
───────────────────────────────────────
☑️ 勾選 id
☑️ 勾選 email (包含 2 個規則)
☐ 不勾選 username (因為測試不需要)

步驟 3: 套用規則
───────────────────────────────────────
點擊「套用選取的規則」

系統回應:
✅ 已新增 3 個驗證規則到列表
• notNull: id
• notNull: email
• regex: email (^.+@.+\..+$)

步驟 4: 手動補充業務邏輯驗證
───────────────────────────────────────
點擊「+ 新增規則」
手動新增: contains: name, "測試使用者"
(這是 OpenAPI 無法表達的業務需求)
```

**點擊「套用選取的規則」後:**
- 自動加入到 Validation 列表 (上方 Table)
- 建議面板的對應項目顯示「[已套用]」標籤
- 顯示 Toast 通知:「✅ 已新增 N 個驗證規則」
- 建議面板保持開啟 (方便繼續選擇)

**點擊「重新分析 Schema」:**
- 重新解析 OpenAPI Response Schema
- 更新建議清單
- 用於 OpenAPI 檔案更新後重新載入

#### 技術實作考量

**資料結構:**

```typescript
interface ValidationRule {
  id: string;
  source: 'openapi' | 'manual';  // 標示來源
  rule: 'notNull' | 'contains' | 'regex';
  path: string;
  value?: string;
  openApiReason?: string;  // OpenAPI 建議原因
}

interface ValidationSuggestion {
  fieldName: string;
  fieldDescription: string;  // 如 "必填欄位"
  rules: {
    rule: 'notNull' | 'regex';
    value?: string;
  }[];
  openApiSource: string;  // 如 "required + format: email"
  applied: boolean;  // 是否已套用
}
```

**優先級規劃:**

- **P0 (MVP):**
  - ✅ 手動新增驗證規則
  - ✅ 從 OpenAPI `required` 自動建議 `notNull`
  - ✅ 一鍵套用建議規則

- **P1 (第一版):**
  - ✅ 從 `format: email/date-time` 推斷 `regex`
  - ✅ 顯示建議原因標籤
  - ✅ 已套用規則的視覺標示

- **P2 (進階):**
  - ⭐ 從 `pattern` 直接轉換為 `regex`
  - ⭐ 智能分析 Request Body 建議 `contains` 規則
  - ⭐ 學習使用者習慣,記住常用模式

---

### 匯出 Flow Modal

**觸發:** 點擊 Header 的「匯出」按鈕

```
┌─────────────────────────────────────────────────────────┐
│ 📤 匯出 Flow                                    [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ Flow 名稱: user-management-test                          │
│                                                          │
│ 選擇匯出格式:                                            │
│                                                          │
│ ☑️ YAML 檔案 (user-management-test.yaml)                │
│    完整 Flow 定義,可被 SpecPilot CLI 使用               │
│                                                          │
│ ☑️ JSON Schema (user-management-test.schema.json)       │
│    用於 Flow 驗證 (--flow-schema 參數)                  │
│                                                          │
│ ☐ OpenAPI 規格 (user-management-api.yaml)               │
│    一併匯出上傳的 OpenAPI 檔案                          │
│                                                          │
│ 匯出方式:                                                │
│ ● 下載為 ZIP 壓縮檔                                     │
│ ○ 下載為個別檔案                                        │
│ ○ 複製 YAML 到剪貼簿                                    │
│                                                          │
│ 💡 建議: 將檔案放到 SpecPilot 的 flows/ 目錄            │
│                                                          │
│ [取消] [匯出]                                            │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**匯出成功:**

```
┌─────────────────────────────────────────────────────────┐
│ ✅ 匯出成功!                                             │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 已匯出檔案:                                              │
│ • user-management-test.yaml                              │
│ • user-management-test.schema.json                       │
│                                                          │
│ 下一步:                                                  │
│ 1. 將檔案放到 SpecPilot 的 flows/ 目錄                  │
│ 2. 執行測試:                                             │
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ pnpm run start --                                   │ │
│ │   --spec samples/api.yaml                           │ │
│ │   --flow flows/user-management-test.yaml            │ │
│ │   --flow-schema flows/schemas/user-management-te... │ │
│ │   --baseUrl http://localhost:3000                   │ │
│ └────────────────────────────────────────────────────┘ │
│                                    [複製指令]           │
│                                                          │
│ [關閉]                                                   │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

### 匯入 Flow Modal

**觸發:** 點擊 Header 的「新增」→「匯入 Flow」

```
┌─────────────────────────────────────────────────────────┐
│ 📥 匯入 Flow                                    [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 選擇匯入方式:                                            │
│                                                          │
│ ┌───────────────────┐  ┌───────────────────┐           │
│ │ 📁 上傳 YAML 檔案 │  │ 📋 貼上 YAML 內容 │           │
│ └───────────────────┘  └───────────────────┘           │
│         ●                      ○                        │
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │                                                     │ │
│ │  拖曳 Flow YAML 檔案到此                            │ │
│ │  或                                                 │ │
│ │  [選擇檔案上傳]                                     │ │
│ │                                                     │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ 匯入選項:                                                │
│ ☑️ 驗證 YAML 格式                                       │
│ ☑️ 檢查 Schema 版本相容性                               │
│ ☑️ 顯示差異比較 (如有衝突)                              │
│                                                          │
│ [取消] [開始匯入]                                        │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**驗證中:**

```
┌─────────────────────────────────────────────────────────┐
│ 🔍 驗證 Flow 檔案...                                     │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ⏳ 正在驗證 user-management-test.yaml                    │
│                                                          │
│ [進度條 ▓▓▓▓▓▓▓░░░ 70%]                                │
│                                                          │
│ ✅ YAML 格式正確                                         │
│ ✅ Schema 版本相容                                       │
│ 🔍 檢查變數定義...                                       │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**驗證完成:**

```
┌─────────────────────────────────────────────────────────┐
│ ✅ 驗證完成                                              │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 檔案: user-management-test.yaml                          │
│                                                          │
│ ✅ YAML 格式正確                                         │
│ ✅ Schema 版本: v1.0.0 (相容)                            │
│ ✅ 包含 15 個測試步驟                                    │
│ ⚠️ 使用 3 個變數需要設定值:                             │
│    • admin_username                                     │
│    • admin_password                                     │
│    • test_email_prefix                                  │
│                                                          │
│ 📊 Flow 摘要:                                            │
│ ┌────────────────────────────────────────────────────┐ │
│ │ name: 使用者管理完整測試流程                         │ │
│ │ version: 1.0.0                                      │ │
│ │ baseUrl: http://localhost:3000                      │ │
│ │ steps: 15                                           │ │
│ │ variables: 3                                        │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ [取消] [確認匯入]                                        │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**匯入成功:**

```
┌────────────────────────────────────────┐
│ ✅ Flow 匯入成功!                      │
├────────────────────────────────────────┤
│                                        │
│ • 已載入 15 個測試步驟                 │
│ • 已載入 3 個變數 (需設定值)           │
│                                        │
│ 下一步:                                │
│ 請到「變數管理」設定變數的值           │
│                                        │
│ [前往設定變數] [開始編輯]              │
│                                        │
└────────────────────────────────────────┘
```

**版本衝突處理:**

```
┌─────────────────────────────────────────────────────────┐
│ ⚠️ Schema 版本衝突                              [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 匯入的 Flow 使用 Schema v0.9.0                           │
│ 目前系統支援 Schema v1.0.0                               │
│                                                          │
│ 發現以下不相容:                                          │
│                                                          │
│ 1. 欄位名稱變更                                          │
│    • statusCode → status_code (可自動轉換)              │
│                                                          │
│ 2. 新增必填欄位                                          │
│    • 所有 step 需要 description 欄位 (5 個缺少)         │
│                                                          │
│ 3. 驗證規則格式變更                                      │
│    • contains 的 value 必須是字串 (2 處需調整)          │
│                                                          │
│ 建議:                                                    │
│ ○ 自動升級到 v1.0.0 (需手動調整部分內容)                │
│ ○ 保持 v0.9.0 (可能無法使用新功能)                      │
│ ○ 取消匯入,手動調整後再試                               │
│                                                          │
│ [取消] [保持舊版] [自動升級]                             │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

### Flow 範本庫

**位置:** Left Sidebar 底部

**範本清單:**

```
┌──────────────────┐
│ 📦 範本庫        │
├──────────────────┤
│                  │
│ 🔐 JWT 認證流程  │
│ 📝 CRUD 測試     │
│ ⚠️ 錯誤處理      │
│ ❤️ 健康檢查      │
│                  │
│ + 我的範本 (2)   │
│                  │
│ [瀏覽更多...]    │
└──────────────────┘
```

**點擊「瀏覽更多」:**

```
┌─────────────────────────────────────────────────────────┐
│ 📦 Flow 範本庫                                  [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 🔍 [搜尋範本...]                                         │
│                                                          │
│ 分類: [全部 ▼] [認證] [CRUD] [錯誤處理] [效能]          │
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │                                                     │ │
│ │ 🔐 JWT 認證流程                                     │ │
│ │    包含登入、Token 刷新、登出測試                   │ │
│ │    步驟: 5    [使用] [預覽]                         │ │
│ │                                                     │ │
│ │ 📝 CRUD 完整測試                                    │ │
│ │    建立、查詢、更新、刪除的完整流程                 │ │
│ │    步驟: 8    [使用] [預覽]                         │ │
│ │                                                     │ │
│ │ ⚠️ 錯誤情境測試                                     │ │
│ │    測試 400, 401, 403, 404, 500                     │ │
│ │    步驟: 6    [使用] [預覽]                         │ │
│ │                                                     │ │
│ │ ❤️ API 健康檢查                                     │ │
│ │    基本健康檢查與可用性測試                         │ │
│ │    步驟: 2    [使用] [預覽]                         │ │
│ │                                                     │ │
│ │ --- 我的範本 ---                                    │ │
│ │                                                     │ │
│ │ 💾 我的 CRUD 範本                                   │ │
│ │    自訂的 CRUD 測試流程                             │ │
│ │    步驟: 12   [使用] [編輯] [刪除]                  │ │
│ │                                                     │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ [+ 新增自訂範本]                                         │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**儲存為範本:**

```
┌─────────────────────────────────────────────────────────┐
│ 💾 儲存為範本                                   [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 範本名稱 *                                               │
│ ┌────────────────────────────────────────────────────┐ │
│ │ 我的 CRUD 測試範本                                  │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ 描述                                                     │
│ ┌────────────────────────────────────────────────────┐ │
│ │ 包含完整的 CRUD 操作與錯誤處理                      │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ 分類                                                     │
│ ┌────────────────────────────────────────────────────┐ │
│ │ CRUD ▼                                              │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ 標籤 (用於搜尋)                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ crud, api, test, validation                         │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ ☑️ 分享給團隊 (儲存到共用範本庫)                        │
│                                                          │
│ [取消] [儲存範本]                                        │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

### 其他進階功能 UI

#### 歷史版本管理

**觸發:** Header 右上角顯示自動儲存狀態,點擊開啟

```
┌──────────────────────────────────┐
│ 💾 自動儲存                      │
│ 最後儲存: 30 秒前                │
│ [檢視歷史]                       │
└──────────────────────────────────┘
```

**歷史版本 Modal:**

```
┌─────────────────────────────────────────────────────────┐
│ 📜 版本歷史                                     [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ 目前版本 (未儲存)                                   │ │
│ │ • 修改 Step 3                                       │ │
│ │ • 新增 Step 16                                      │ │
│ │ 2 分鐘前                             [復原]         │ │
│ ├────────────────────────────────────────────────────┤ │
│ │ v1.2.0 ✅                                           │ │
│ │ • 新增 5 個驗證規則                                 │ │
│ │ 1 小時前                             [復原]         │ │
│ ├────────────────────────────────────────────────────┤ │
│ │ v1.1.0 ✅                                           │ │
│ │ • 調整 Request Body                                 │ │
│ │ 3 小時前                             [復原]         │ │
│ ├────────────────────────────────────────────────────┤ │
│ │ v1.0.0 ✅                                           │ │
│ │ • 初始版本                                          │ │
│ │ 1 天前                               [復原]         │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ [比較版本]                                               │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

#### 測試執行預覽 (可選功能)

**觸發:** Header 新增「執行測試」按鈕

```
┌─────────────────────────────────────────────────────────┐
│ ▶️ 執行測試                                     [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ Base URL                                                 │
│ ┌────────────────────────────────────────────────────┐ │
│ │ http://localhost:3000                               │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ 認證 Token (選填)                                        │
│ ┌────────────────────────────────────────────────────┐ │
│ │ Bearer eyJhbGc...                                   │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ 執行模式:                                                │
│ ● 執行全部步驟 (15)                                     │
│ ○ 僅執行選取的步驟                                      │
│ ○ 執行到第一個失敗為止                                  │
│                                                          │
│ [取消] [開始執行]                                        │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**執行中:**

```
┌─────────────────────────────────────────────────────────┐
│ ⏳ 執行測試中...                            [停止] [✕]  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 進度: 8 / 15 步驟                                        │
│ [進度條 ▓▓▓▓▓▓▓▓░░░░░░░ 53%]                            │
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ ✅ Step 1: 健康檢查           200 OK    (125ms)     │ │
│ │ ✅ Step 2: 管理者登入         200 OK    (234ms)     │ │
│ │ ✅ Step 3: 建立新使用者       201 Created (156ms)   │ │
│ │ ✅ Step 4: 查詢使用者列表     200 OK    (89ms)      │ │
│ │ ✅ Step 5: 取得使用者詳情     200 OK    (76ms)      │ │
│ │ ✅ Step 6: 更新使用者         200 OK    (145ms)     │ │
│ │ ✅ Step 7: 刪除使用者         200 OK    (98ms)      │ │
│ │ ⏳ Step 8: 錯誤處理測試       執行中...              │ │
│ │ ⏸️ Step 9: ...                                      │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**執行完成:**

```
┌─────────────────────────────────────────────────────────┐
│ 📊 測試結果                                     [關閉 ✕] │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ✅ 執行完成                                              │
│ 總步驟: 15   通過: 13   失敗: 2   跳過: 0               │
│ 執行時間: 2.5 秒                                         │
│                                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ ✅ Step 1: 健康檢查               200 OK  (125ms)   │ │
│ │ ✅ Step 2: 管理者登入             200 OK  (234ms)   │ │
│ │ ❌ Step 3: 建立新使用者           400 Bad Request   │ │
│ │    錯誤: email 格式不正確                           │ │
│ │    [查看詳情] [修正]                                │ │
│ │ ✅ Step 4: 查詢使用者列表         200 OK  (89ms)    │ │
│ │ ❌ Step 5: 更新使用者資料         404 Not Found     │ │
│ │    錯誤: 使用者不存在                               │ │
│ │    [查看詳情] [修正]                                │ │
│ │ ✅ Step 6: ...                                      │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ [匯出報表] [重新執行] [修正錯誤]                         │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 完整使用流程範例

### 情境: 從 OpenAPI 建立完整測試流程

```
步驟 1: 上傳 OpenAPI
───────────────────────────────────────
使用者操作:
1. 點擊 Sidebar「上傳 OpenAPI」
2. 拖曳 openapi.yaml 檔案

系統回應:
✅ 解析成功
✅ 發現 12 個 API 端點
✅ Base URL: http://localhost:3000


步驟 2: 瀏覽 API 清單
───────────────────────────────────────
使用者操作:
3. 點擊「查看清單」

系統回應:
• 顯示 API 端點清單 Modal
• 依 Tag 分組顯示
• 每個端點旁有「+ 新增測試」按鈕


步驟 3: 批次生成測試
───────────────────────────────────────
使用者操作:
4. 點擊「批次生成全部」
5. 勾選要生成的 API
6. 選擇測試選項:
   ☑️ 包含認證流程
   ☑️ 自動串接步驟
   ☑️ 包含錯誤情境
7. 點擊「生成測試流程」

系統回應:
✅ 生成 15 個測試步驟
✅ 自動串接 capture 變數
✅ 自動設定 Request Body 範例
✅ 自動設定 Status Code
✅ 建議驗證規則


步驟 4: 檢視與編輯
───────────────────────────────────────
使用者操作:
8. 在 Sidebar 點擊 Step 3
9. 查看 Request Body
10. 發現 OpenAPI 衝突警告

系統回應:
⚠️ 顯示衝突詳情
• email 長度不足
• 提供自動修正建議


步驟 5: 套用驗證規則
───────────────────────────────────────
使用者操作:
11. 滾動到 Validation 區塊
12. 查看建議的驗證規則
13. 勾選需要的規則
14. 點擊「套用選取的規則」

系統回應:
✅ 自動加入 4 個驗證規則
✅ 更新右側 YAML 預覽


步驟 6: 預覽與匯出
───────────────────────────────────────
使用者操作:
15. 點擊 Header「預覽」
16. 檢查 YAML 內容
17. 點擊「匯出」
18. 選擇匯出為 ZIP
19. 點擊「匯出」

系統回應:
✅ 下載 user-flow.zip
  • user-flow.yaml
  • user-flow.schema.json
✅ 顯示 CLI 執行指令


步驟 7: 在 SpecPilot 執行
───────────────────────────────────────
使用者操作:
20. 將檔案放到 flows/ 目錄
21. 執行 CLI 指令

SpecPilot:
✅ 載入 Flow YAML
✅ 使用 JSON Schema 驗證
✅ 執行 15 個測試步驟
✅ 產生測試報表
```

---

**文件版本:** v2.0.0
**最後更新:** 2025-01-15
**狀態:** 📝 Draft - 已整合 OpenAPI 功能
