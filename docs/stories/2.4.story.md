# Story 2.4: 結構化 LOG 與報表輸出

## Status

允許

## Story

**As a** 系統維運者,
**I want** 紀錄測試過程並輸出報表,
**so that** 能快速追蹤錯誤來源。

## Acceptance Criteria

1. 每步驟在 LOG 紀錄請求摘要（方法、URL、Header、Body hash）與回應摘要（狀態碼、驗證結果、錯誤）。
2. LOG 支援時間戳與檔案輪替或區分，以免單檔過大。
3. 產生 `reports/result.json`，格式符合需求文件範例。
4. CLI 結束時在主控台輸出報表位置與失敗計數。

## Tasks / Subtasks

- [ ] 擴展 Reporting 套件支援完整報表生成 (AC: 3, 4)
  - [ ] 設計 ExecutionReport 完整 JSON Schema 與型別定義
  - [ ] 實作 ReportGenerator 類別產生符合規格的 `reports/result.json`
  - [ ] 支援報表中包含完整流程執行摘要與步驟細節
  - [ ] 實作報表檔案的安全寫入（臨時檔 + rename）
  - [ ] 整合 CLI 介面顯示報表位置與失敗計數

- [ ] 強化 StructuredLogger 支援完整步驟日誌記錄 (AC: 1, 2)
  - [ ] 擴展 Logger 支援請求摘要記錄（方法、URL、Header hash、Body hash）
  - [ ] 擴展 Logger 支援回應摘要記錄（狀態碼、驗證結果、錯誤詳情）
  - [ ] 實作日誌檔案輪替機制，避免單檔過大
  - [ ] 定義完整的日誌事件代碼（STEP_START, STEP_COMPLETE, STEP_FAILURE 等）
  - [ ] 確保敏感資料（Token、密碼）在日誌中正確遮罩

- [ ] 整合 Core Flow Orchestrator 的日誌與報表流程 (AC: 1, 3, 4)
  - [ ] 整合每個步驟執行前後的詳細日誌記錄
  - [ ] 收集步驟執行結果並建構完整的 ExecutionReport
  - [ ] 支援執行過程中的錯誤追蹤與回報
  - [ ] 實作流程完成後的報表產生與儲存
  - [ ] 整合認證流程的日誌記錄（使用 Story 2.3 的認證架構）

- [ ] 建立報表與日誌的 JSON Schema 驗證 (AC: 1, 3)
  - [ ] 定義 ExecutionReport 的完整 JSON Schema
  - [ ] 定義 StructuredLog 的 JSON Schema 規格
  - [ ] 實作報表與日誌格式的自動驗證
  - [ ] 確保輸出格式符合 JSON-RPC 與 MCP 要求

- [ ] 建立完整測試套件 (AC: 1-4)
  - [ ] 建立 ReportGenerator 單元測試
  - [ ] 建立 StructuredLogger 擴展功能測試
  - [ ] 建立 Core Flow 整合測試（日誌與報表流程）
  - [ ] 建立端對端測試：完整流程執行與報表產生
  - [ ] 測試日誌檔案輪替與報表檔案安全寫入
  - [ ] 測試報表生成失敗恢復機制
  - [ ] 測試大量日誌處理效能與記憶體使用

- [ ] 更新文件與範例 (AC: 3, 4)
  - [ ] 更新報表格式說明文件（`docs/prd/requirements.md`）
  - [ ] 提供日誌事件代碼參考文件
  - [ ] 建立報表查看與分析指南
  - [ ] 更新 CLI 使用說明包含報表輸出功能
  - [ ] 新增日誌輪替策略文件（`docs/architecture/logging.md`），載明設定方式與預設值

## Dev Notes

### Previous Story Insights

- Story 2.3 已建立完整的 StructuredLogger 架構與認證事件記錄機制，可直接擴展支援步驟日誌
- Story 2.1-2.2 已完成 HTTP Runner 與驗證引擎，可整合其執行結果到報表中
- Story 1.4 已建立基礎 CLI 架構，可擴展支援報表位置輸出與失敗計數顯示

### Technology Stack Requirements

[Source: docs/architecture/技術堆疊.md]

- **Logger**: pino 9.0.0 - 已建立結構化 JSON Lines 日誌，可擴展支援步驟詳細記錄
- **File System**: Node.js 原生 - 支援報表檔案的安全寫入與日誌檔案輪替
- **JSON Schema**: ajv 8.12.0 - 驗證報表與日誌格式
- **Language**: TypeScript 5.4.5 - 強型別報表與日誌結構定義
- **CLI Framework**: commander 11.1 - 支援報表位置與結果摘要輸出

### Data Models

[Source: docs/architecture/資料模型.md]

**ExecutionReport** - 流程執行報表：

- 現行屬性：`executionId`, `flowId`, `steps[]`, `summary`（參考 `docs/architecture/資料儲存與結構.md`）
- 本故事需擴充欄位：`startTime`, `endTime`, `duration`, `config`（baseUrl/fallback/auth）
- 關聯：一對一 `RunContext`、一對多 `StepResult`

**StepResult** - 步驟執行結果：

- 目前定義自含 `stepName`, `statusCode`, `success`, `timestamp`, `customChecks`
- 本故事需擴充：請求/回應摘要（method/url/headerHash/bodyHash、statusCode、validationResults、errorMessage）
- 關聯：多對一 `ExecutionReport`

**StructuredLogEntry** - 結構化日誌項目：

- 既有欄位：`timestamp`, `level`, `executionId`, `component`, `event`, `details`
- 本故事需新增：`stepName`, `duration`, `requestSummary`, `responseSummary`
- 事件代碼：與 `@specpilot/shared` 的 `EVENT_CODES` 對齊，並補充本故事新增事件

### Component Specifications

[Source: docs/architecture/系統元件.md]

**Reporting & Logging (`packages/reporting`)** - 報表與日誌管理：

- ReportGenerator：產生符合規格的 ExecutionReport JSON
- StructuredLogger：擴展支援步驟級別的詳細日誌記錄
- LogRotator：實作日誌檔案輪替機制
- ReportValidator：使用 ajv 驗證報表格式

**Flow Orchestrator (`packages/core-flow`)** - 需整合報表功能：

- 執行步驟時調用 StructuredLogger 記錄詳細資訊
- 收集 StepResult 並建構 ExecutionReport
- 完成流程後觸發報表產生與儲存

### File Locations

- 建議於 `packages/reporting/src/` 新增：
  - `report-generator.ts`（報表產生）
  - `structured-logger.ts`（步驟級日誌擴充）
  - `log-rotation.ts`（日誌輪替工具）
  - `report-validator.ts` 與 `schemas/execution-report.schema.json`
- 在 `packages/core-flow/src/` 新增 `reporting-integration.ts` 並於既有 Orchestrator 入口接軌
- 測試檔案集中於 `packages/reporting/__tests__/` 與 `tests/integration/reporting-flow.spec.ts`

### Report Format Requirements

[Source: docs/architecture/資料儲存與結構.md; docs/SpecPilot-Req.md §2.4]

- 基本輸出路徑固定為 `reports/result.json`，維持與 PRD 的檔名一致
- 報表為物件結構，包含 `summary` 與 `steps` 陣列；`steps` 需至少提供 PRD 範例中的欄位（Step/StatusCode/Success/ErrorMessage/Timestamp）
- 依據架構文件補強欄位（duration、request/response 摘要、config）；如需對外輸出簡化版本，於 CLI 層轉換
- 提供 JSON Schema (`schemas/execution-report.schema.json`) 以驗證欄位與型別

**完整報表結構範例：**

```json
{
  "executionId": "550e8400-e29b-41d4-a716-446655440000",
  "flowId": "user_crud_flow",
  "startTime": "2025-09-27T10:30:00.000Z",
  "endTime": "2025-09-27T10:30:15.234Z",
  "duration": 15234,
  "status": "success",
  "summary": {
    "totalSteps": 5,
    "successfulSteps": 5,
    "failedSteps": 0,
    "skippedSteps": 0
  },
  "steps": [
    {
      "name": "user_login",
      "status": "success",
      "startTime": "2025-09-27T10:30:00.100Z",
      "duration": 1200,
      "request": {
        "method": "POST",
        "url": "https://api.example.com/auth/login",
        "headerHash": "sha256:abc123...",
        "bodyHash": "sha256:def456..."
      },
      "response": {
        "statusCode": 200,
        "success": true,
        "validationResults": ["status_check_passed", "schema_validation_passed"],
        "errorMessage": null
      }
    }
  ],
  "config": {
    "baseUrl": "https://api.example.com",
    "fallbackUsed": false,
    "authNamespaces": ["api_v1"]
  }
}
```

### Logging Event Codes

[Source: packages/shared/src/index.ts EVENT_CODES; docs/architecture/資料儲存與結構.md]

- **FLOW_START** / **FLOW_COMPLETE** / **FLOW_FAILURE**：沿用既有事件
- **STEP_START** / **STEP_COMPLETE** / **STEP_FAILURE**：步驟前後紀錄
- **REQUEST_SENT** / **RESPONSE_RECEIVED**：HTTP Runner 事件
- **VALIDATION_SUCCESS** / **VALIDATION_FAILURE**：Validation Engine 事件
- **REPORT_GENERATED**：新增於本故事，報表產出時紀錄
- **LOG_ROTATED**：新增於本故事，日誌輪替時紀錄
- 認證相關事件（`TOKEN_LOADED` 等）沿用 Story 2.3

### Technical Constraints

[Source: docs/architecture/程式撰寫規範.md]

- 禁用 `console.log/error`，統一使用 StructuredLogger
- 匯出函式需明確型別註解，特別是報表與日誌相關介面
- 檔案寫入採非同步 + 臨時檔 rename 流程確保原子性
- 敏感資料（Token、密碼、API Key）在日誌與報表中遮罩為 `***`
- 主報表輸出檔名固定為 `reports/result.json`，必要時可額外保留歷史檔案（例如 `reports/archive/result-{timestamp}.json`）

### Log Rotation Requirements

- 本故事需定義正式輪替策略並記錄於 `docs/architecture/logging.md`
- 輪替條件至少包含：檔案尺寸上限、日期批次、保留數量
- 需支援舊檔壓縮或清除策略，避免磁碟爆滿
- 命名慣例建議：`logs/specpilot-{yyyyMMdd}-{index}.log`
- CLI 與 Dev Notes 中須載明如何調整輪替設定（透過 `@specpilot/config` 或環境變數）

**預設輪替配置範例：**

```typescript
// 透過 @specpilot/config 的預設值
const logRotationConfig = {
  maxFileSize: '10MB', // 單檔最大尺寸
  maxFiles: 10, // 保留檔案數量
  datePattern: 'YYYY-MM-DD', // 日期批次格式
  compress: true, // 壓縮舊檔案
  archiveAfterDays: 3, // 3天後壓縮
};

// 環境變數覆寫
// SPEC_PILOT_LOG_MAX_SIZE=5MB
// SPEC_PILOT_LOG_MAX_FILES=5
// SPEC_PILOT_LOG_COMPRESS=false
```

### Error Recovery & Performance Considerations

**報表生成失敗恢復策略：**

- 報表生成失敗時，保留 partial report 於 `reports/partial-{executionId}.json`
- 失敗時記錄詳細錯誤於 StructuredLogger，事件代碼 `REPORT_GENERATION_FAILED`
- 提供 CLI 選項 `--continue-on-report-error` 允許流程繼續執行
- 支援手動重新生成報表功能（透過 executionId 重建）

**大量日誌處理效能考量：**

- 使用 Stream API 處理大型日誌檔案，避免記憶體溢出
- 批次寫入機制：每 100 筆日誌項目批次寫入，減少 I/O 開銷
- 非同步日誌寫入：使用 Worker Thread 處理日誌寫入，避免阻塞主流程
- 記憶體監控：當記憶體使用量超過閾值時觸發強制日誌輪替

### Integration Points

- **依賴套件**: 整合 `@specpilot/core-flow` 的執行結果
- **共用模組**: 使用 `@specpilot/shared` 的錯誤類型與工具函式
- **設定管理**: 透過 `@specpilot/config` 讀取日誌與報表相關設定
- **認證整合**: 複用 Story 2.3 的認證日誌記錄機制
- **輸出格式**: 符合 MCP JSON-RPC 規格要求

## Testing

### Test File Locations

[Source: docs/architecture/測試策略.md]

- 單元測試：`packages/reporting/__tests__/*.test.ts`
- 整合測試：`tests/integration/reporting-flow.spec.ts`
- 測試資料：`packages/testing/fixtures/reports/` 報表測試資料

### Testing Standards

- 使用 Vitest 1.6.0 測試框架
- 目標覆蓋率 ≥ 85%（報表為關鍵模組）
- 遵守 AAA（Arrange, Act, Assert）模式
- 使用暫時檔案系統進行報表生成測試
- 測試後清理生成的報表與日誌檔案

### Testing Requirements for This Story

- 測試報表 JSON Schema 驗證功能
- 測試日誌輪替機制與檔案大小控制
- 測試步驟執行的完整日誌記錄
- 測試報表生成與檔案安全寫入
- 測試敏感資料遮罩功能
- 端對端測試：完整流程到報表輸出
- 測試 CLI 報表位置顯示與失敗計數

## Change Log

| Date       | Version | Description                                                              | Author                |
| ---------- | ------- | ------------------------------------------------------------------------ | --------------------- |
| 2025-09-27 | v0.1    | 初稿建立                                                                 | Bob (Scrum Master)    |
| 2025-09-27 | v0.2    | 品質修正：新增日誌輪替配置範例、完整報表結構範例、錯誤恢復策略與效能考量 | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used

_待開發階段填入_

### Debug Log References

_待開發階段填入_

### Completion Notes

_待開發階段填入_

### File List

_待開發階段填入_

## QA Results

_待 QA 階段填入_
