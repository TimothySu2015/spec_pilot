# Story 3.3: 實作 `runFlow` 支援檔案與即時內容

## Status

Draft

## Story

**As a** AI Agent,
**I want** 遠端觸發測試流程，支援檔案與即時內容模式,
**so that** 可以自動驗證 API 而不需要預先準備檔案。

## Acceptance Criteria

1. `runFlow` 支援 `spec` + `flow`（檔案模式）與 `specContent` + `flowContent`（字串模式），兩種模式互斥且必須提供完整參數組合。
2. 可傳入 `baseUrl`、`port`、`token` 等覆寫設定，支援設定一致性驗證與無效組合檢查。
3. 執行流程重用 Epic 2 的引擎，回傳執行狀態與標準化報表摘要（`IRunFlowResult` 格式）。
4. 錯誤需以 JSON-RPC `error` 格式回傳並記錄 LOG，支援內容大小限制與並發處理。

## Tasks / Subtasks

- [ ] 定義 `runFlow` 方法的參數介面與回應格式 (AC: 1, 2, 3, 4)
  - [ ] 在 `apps/mcp-server/src/rpc-handler.ts` 定義 `IRunFlowParams` 介面，支援檔案模式（`spec`、`flow`）與內容模式（`specContent`、`flowContent`）
  - [ ] 定義覆寫設定介面 `IRunFlowOptions`，包含 `baseUrl`、`port`、`token` 等欄位
  - [ ] 定義 `IRunFlowResult` 回應介面，包含 `executionId`、`status`、`reportSummary`、`reportPath`、`errorMessage`
  - [ ] 建立參數驗證函式，確保檔案模式與內容模式互斥且必要欄位完整
  - [ ] 實作內容大小限制檢查（最大 10MB）與設定組合一致性驗證（URL/埠號匹配）

- [ ] 實作檔案模式的 `runFlow` 處理器 (AC: 1, 3)
  - [ ] 建立 `apps/mcp-server/src/handlers/run-flow.ts`，實作檔案路徑驗證與讀取邏輯
  - [ ] 整合 `packages/spec-loader` 載入並驗證 OpenAPI 規格檔案
  - [ ] 整合 `packages/flow-parser` 解析 YAML 測試流程檔案
  - [ ] 實作檔案存在性檢查與安全路徑驗證，拒絕 `..` 或絕對路徑

- [ ] 實作即時內容模式的處理邏輯 (AC: 1, 3, 4)
  - [ ] 實作 `specContent` 字串解析，支援 JSON 與 YAML 格式的 OpenAPI 規格
  - [ ] 實作 `flowContent` 字串解析，驗證 YAML 測試流程內容
  - [ ] 建立臨時檔案處理機制，位於 `temp/` 目錄，命名格式為 `run-{executionId}-{timestamp}.{ext}`
  - [ ] 確保臨時檔案在執行完成後正確清理，包含異常情況的清理策略
  - [ ] 實作內容大小限制檢查，超過 10MB 回傳 `-32602` 錯誤

- [ ] 整合 Epic 2 的執行引擎 (AC: 3)
  - [ ] 整合 `packages/core-flow` 的 Flow Orchestrator 執行測試流程
  - [ ] 整合 `packages/http-runner` 進行 HTTP 請求執行
  - [ ] 整合 `packages/validation` 進行回應驗證
  - [ ] 整合 `packages/reporting` 產生 `ITestReport` 格式報表，並提取摘要資訊
  - [ ] 實作並發執行管理，使用執行 ID 隔離不同請求的執行狀態

- [ ] 實作設定覆寫功能 (AC: 2)
  - [ ] 建立設定合併邏輯，將 MCP 參數覆寫預設設定與環境變數
  - [ ] 實作 `baseUrl`、`port`、`token` 覆寫，並傳遞給執行引擎
  - [ ] 驗證覆寫參數的格式與安全性（URL 格式、埠號範圍 1-65535）
  - [ ] 實作設定組合一致性檢查（如 HTTPS URL 不應配 80 埠，HTTP URL 不應配 443 埠）
  - [ ] 確保敏感資料（token）在日誌中正確遮罩

- [ ] 實作結構化錯誤處理與日誌記錄 (AC: 4)
  - [ ] 使用 StructuredLogger 記錄 `run_flow_start`、`run_flow_success`、`run_flow_error` 事件
  - [ ] 實作詳細的錯誤分類：檔案錯誤（-32603）、參數錯誤（-32602）、執行錯誤（-32603）
  - [ ] 建立錯誤轉換機制，將執行引擎錯誤轉換為 JSON-RPC 標準錯誤格式
  - [ ] 記錄執行時間、參數摘要（敏感資料遮罩）與執行結果統計

- [ ] 建立單元測試與整合測試 (AC: 1, 2, 3, 4)
  - [ ] 在 `apps/mcp-server/__tests__/handlers/run-flow.test.ts` 建立單元測試：檔案模式、內容模式、設定覆寫、錯誤處理
  - [ ] 建立整合測試：模擬完整的 JSON-RPC 請求與回應流程，驗證與 Epic 2 引擎的整合
  - [ ] 使用 `packages/testing/fixtures/` 的測試資料，建立成功與失敗的測試案例
  - [ ] 驗證 StructuredLogger 事件記錄與敏感資料遮罩功能

## Dev Notes

### 前一故事的重要情資

來源：`docs/stories/3.2.story.md`（Dev Agent Record）

- Story 3.2 已完成 `listSpecs` 與 `listFlows` 方法，建立了 `IFileListItem` 介面與 JSON-RPC 回應建構工具
- `apps/mcp-server/src/bootstrap.ts` 與 `apps/mcp-server/src/rpc-handler.ts` 提供完整的路由與錯誤轉換機制
- StructuredLogger 整合已完成，可直接使用 `list_specs_start`、`list_specs_success`、`list_specs_error` 等事件模式

### 系統架構與檔案配置

來源：`docs/architecture/原始碼結構.md`

- MCP 伺服器位於 `apps/mcp-server/`，方法處理器存放於 `src/handlers/`
- 核心執行引擎套件位於 `packages/` 目錄：`core-flow`、`spec-loader`、`flow-parser`、`http-runner`、`validation`、`reporting`
- 測試檔案建議放在 `apps/mcp-server/__tests__/handlers/` 與現有整合測試檔案同層

### Epic 2 執行引擎整合

來源：`docs/architecture/核心流程.md`、`docs/architecture/技術堆疊.md`

- 使用 Flow Orchestrator (`packages/core-flow`) 作為主要執行協調器
- HTTP 執行引擎使用 axios 1.6.8，支援攔截器與重試機制
- OpenAPI 驗證器使用 @apidevtools/swagger-parser 10.1.0
- Schema 驗證使用 ajv 8.12.0，支援自訂驗證規則
- 報表系統使用 `packages/reporting` 產生結構化 JSON 報表

### 設定與參數處理

來源：`docs/architecture/程式撰寫規範.md`、`docs/architecture/錯誤處理策略.md`

- 使用 node-config 3.3 與 dotenv-flow 3.3 進行多環境設定管理
- 參數覆寫優先順序：MCP 參數 > CLI 參數 > 環境變數 > 預設值
- 檔案路徑需透過 `path.resolve` 與專案根路徑比對，拒絕 `..` 或絕對路徑
- URL 與埠號驗證需符合 RFC 規範，token 需遮罩記錄

### 錯誤處理策略

來源：`docs/architecture/錯誤處理策略.md`

- JSON-RPC 錯誤碼：-32602（無效參數）、-32603（內部錯誤）
- HTTP 執行使用 exponential backoff（500ms, 1s, 2s），最多 3 次重試
- 支援 circuit breaker 機制，連續 5 次失敗停止流程
- 錯誤訊息需對使用者友善，避免洩漏系統內部路徑或堆疊追蹤

### 日誌策略

來源：`docs/architecture/logging.md`

- 使用 pino 9.0.0 進行結構化 JSON Lines 日誌
- 必要欄位：`timestamp`、`executionId`、`component`（固定 `"mcp-server"`）、`event`、`method`、`details`
- 敏感資料自動遮罩：`token`、`password`、`secret`、`key`、`authorization` 等欄位
- 事件類型：`run_flow_start`、`run_flow_success`、`run_flow_error`，`details` 包含參數摘要與執行統計

### 回應格式定義

來源：`packages/reporting/src/index.ts`

```typescript
interface IRunFlowResult {
  executionId: string;
  status: 'success' | 'partial_failure' | 'failure';
  reportSummary: {
    total: number;
    passed: number;
    failed: number;
    skipped: number;
    duration: number;
  };
  reportPath?: string; // reports/result.json 相對路徑
  errorMessage?: string; // 僅在 status 為 failure 時存在
}
```

### 並發處理與限制策略

來源：`docs/architecture/錯誤處理策略.md`

- 使用 `executionId` 隔離不同請求的執行狀態，避免並發衝突
- 內容模式大小限制：`specContent` 和 `flowContent` 各自最大 10MB
- 臨時檔案策略：建立於 `temp/` 目錄，執行完成或 30 分鐘後自動清理
- 設定組合驗證：URL 協議與埠號一致性檢查、埠號範圍驗證

### Testing

來源：`docs/architecture/測試策略.md`

#### 測試檔案位置

- 單元測試：`apps/mcp-server/__tests__/handlers/run-flow.test.ts`
- 整合測試：`apps/mcp-server/__tests__/mcp-server.test.ts`（新增 runFlow 相關測試）
- 測試 fixtures：`packages/testing/fixtures/specs/`、`packages/testing/fixtures/flows/`

#### 測試標準與覆蓋要求

- 使用 Vitest 1.6.0，遵循 AAA（Arrange、Act、Assert）模式
- 單元測試覆蓋率需維持在 85% 以上，整合測試需覆蓋成功與錯誤流程
- 使用 nock 13.4.0 模擬外部 API 回應，測試 HTTP 執行引擎整合
- 測試中若需建立臨時檔案，請於 `afterEach`/`afterAll` 清理

#### 本故事測試要求

- **參數驗證測試**：
  - 檔案模式：`spec` + `flow` 組合有效，單獨提供無效（`-32602`）
  - 內容模式：`specContent` + `flowContent` 組合有效，單獨提供無效（`-32602`）
  - 模式互斥：同時提供檔案與內容參數回傳 `-32602`
  - 內容大小：超過 10MB 限制回傳 `-32602`
- **檔案模式測試**：
  - 成功載入檔案、檔案不存在、非法路徑（`-32602`）
- **內容模式測試**：
  - 成功解析內容、無效 JSON/YAML 格式（`-32602`）
- **設定覆寫測試**：
  - 有效參數覆寫、無效 URL/埠號格式（`-32602`）
  - 設定組合一致性檢查（HTTPS + 80 埠等無效組合）
- **執行引擎整合測試**：
  - 成功執行、HTTP 錯誤、驗證失敗、報表產生
  - 並發執行隔離驗證
- **臨時檔案測試**：
  - 檔案建立、清理成功、建立失敗處理
- **JSON-RPC 整合測試**：
  - 確認 `IRunFlowResult` 回應格式、錯誤碼正確性、`executionId` 關聯
- **日誌驗證測試**：
  - 檢查事件記錄、敏感資料遮罩、執行時間記錄


## Change Log

| Date       | Version | Description | Author             |
| ---------- | ------- | ----------- | ------------------ |
| 2025-09-28 | v0.1    | 初次建立    | Bob (Scrum Master) |
| 2025-09-28 | v0.2    | PO 修正：明確 AC 定義、範本結構、參數驗證、並發處理 | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used

_待開發者填入_

### Debug Log References

_待開發者填入_

### Completion Notes

_待開發者填入_

### File List

_待開發者填入_

## QA Results

_待 QA 代理填入_