# Story 1.2: 實作 OpenAPI 規格載入與驗證

## Status
Draft

## Story
**As a** 開發者,
**I want** 將 JSON/YAML OpenAPI 規格載入並轉為標準 JSON,
**so that** 後續流程可共用一致格式。

## Acceptance Criteria
1. 支援本地檔案 `swagger.json`、`openapi.yaml` 與 AI 傳入的 `specContent`。
2. `.json` 以 JSON.parse，`.yaml/.yml` 以 `yaml` 套件解析；錯誤需給出明確訊息。
3. 使用 `swagger-parser` 驗證規格完整性，若有錯誤需攔截並回報。
4. 解析成功與失敗都需記錄 LOG，並依錯誤處理策略遮罩敏感資訊。

## Tasks / Subtasks

- [ ] 建立 spec-loader 套件結構 (AC: 1-4)
  - [ ] 建立 `packages/spec-loader/package.json`（`name: "@specpilot/spec-loader"`, `type: "module"`, `main: "dist/index.cjs"`, `types: "dist/index.d.ts"`, `exports` 指向 `./dist/index.js`/`./dist/index.cjs`，`files` 包含 `dist/`、設定 `build`, `clean`, `test` scripts）。
  - [ ] 將 `@apidevtools/swagger-parser@10.1.0`, `yaml@2.4.3` 註冊為 dependencies，`zod@3.23` 與 `vitest`, `@vitest/coverage-v8` 作為 devDependencies。
  - [ ] 若 `packages/shared/src/errors/base-error.ts` 尚未建立，沿用 Story 1.1 的共用錯誤基底並匯出，可供 `SpecParseError`/`SpecValidationError` 繼承。

- [ ] 設計 SpecDocument 資料模型 (AC: 1, 2, 3, 4)
  - [ ] 建立 `packages/spec-loader/src/types.ts`，定義 `SpecDocument` 介面，包含 `id`, `rawContent`, `document`, `schemas` 屬性，`id` 採用檔案路徑或內容 SHA-256 雜湊。
  - [ ] 定義 `SpecLoadOptions` 介面，支援檔案路徑或直接內容輸入（含 `format?: 'json' | 'yaml'`）。
  - [ ] 建立 `packages/spec-loader/src/errors.ts`，定義錯誤類型：`SpecParseError`, `SpecValidationError`，繼承自共用錯誤基底並內含 `details`, `hint` 欄位。

- [ ] 實作 OpenAPI 檔案載入邏輯 (AC: 1, 2)
  - [ ] 建立 `loadSpecFromFile(filePath: string)` 函式，支援 `.json`, `.yaml`, `.yml` 副檔名並驗證檔案是否存在。
  - [ ] 實作檔案讀取與內容類型檢測（依副檔名判斷解析器），成功時回傳 `SpecDocument` 初始資料。
  - [ ] 使用 `yaml.parse()` 解析 YAML 檔案，`JSON.parse()` 解析 JSON 檔案，錯誤時拋出 `SpecParseError`。
  - [ ] 建立 `loadSpecFromContent(content: string, format?: 'json' | 'yaml')` 函式處理 AI 傳入內容，必要時推斷格式。
  - [ ] 加入錯誤處理與訊息，包含檔案不存在、格式錯誤、內容為空、JSON 無法解析等情況。

- [ ] 整合 swagger-parser 驗證機制 (AC: 3)
  - [ ] 建立 `validateAndDereferenceSpec(spec: any)` 函式，使用 `SwaggerParser.validate()` 驗證規格完整性。
  - [ ] 使用 `SwaggerParser.dereference()` 展開 `$ref` 參考，於失敗時拋出 `SpecValidationError` 並附上 `path` 資訊。
  - [ ] 提取 `components.schemas` 並存儲在 `SpecDocument.schemas` 中供後續驗證使用。
  - [ ] 將驗證結果整併回傳成完整的 `SpecDocument`。

- [ ] 實作結構化日誌記錄 (AC: 4)
  - [ ] 整合 `@specpilot/shared` 的 StructuredLogger，component 使用 `spec-loader`。
  - [ ] 記錄規格載入開始事件：`SPEC_LOAD_START`，包含檔案路徑或內容長度、推斷格式。
  - [ ] 記錄成功事件：`SPEC_LOAD_SUCCESS`，包含 OpenAPI 版本、路徑數量、schemas 數量。
  - [ ] 記錄失敗事件：`SPEC_LOAD_FAILURE`，包含錯誤類型與詳細訊息。
  - [ ] 根據 `docs/architecture/錯誤處理策略.md` 遮罩 `servers[*].url`, `securitySchemes.*.flows.*.tokenUrl`, `components.securitySchemes.*.clientSecret` 等敏感欄位。

- [ ] 建立主要匯出介面 (AC: 1-4)
  - [ ] 在 `packages/spec-loader/src/index.ts` 匯出主要函式：`loadSpec()`，包裝檔案路徑或內容字串。
  - [ ] `loadSpec()` 根據參數自動判斷輸入類型，鏈結載入與驗證流程，成功回傳 `SpecDocument`。
  - [ ] 統一錯誤處理並回傳標準化錯誤（包含 `code`, `message`, `details`）。
  - [ ] 確保所有操作都有適當的日誌記錄與 `executionId` 傳遞。

- [ ] 撰寫單元測試與測試資料 (AC: 1-4)
  - [ ] 於 `packages/testing/fixtures/specs/` 建立測試用範本：`petstore.json`, `minimal.yaml`, `invalid-schema.yaml`。
  - [ ] 建立 `packages/spec-loader/__tests__/spec-loader.test.ts`，測試正確載入 JSON 和 YAML 規格、直接內容載入、swagger-parser 驗證與錯誤處理、事件日誌。
  - [ ] 為錯誤情境（檔案不存在、格式錯誤、驗證失敗）撰寫對應測試案例。
  - [ ] 使用 `vi.mock` 模擬檔案存取與 logger，驗證敏感欄位已遮罩。
  - [ ] 確保測試覆蓋率達到 85%（關鍵模組標準），coverage 報告輸出至 `reports/coverage/spec-loader/` 方便追蹤。

## Dev Notes

### Previous Story Insights
- Story 1.1 已建立完整的 TypeScript Monorepo 結構，包含 `packages/spec-loader` 目錄與共用 logger、測試基礎設施。
- 共用錯誤基底預期位於 `packages/shared/src/errors/base-error.ts`，本故事的錯誤類別需延伸該基底。

### Technology Stack Requirements
[Source: docs/architecture/技術堆疊.md]
- **OpenAPI Validator**: @apidevtools/swagger-parser 10.1.0 - 驗證/展開規格，支援 dereference 與驗證
- **YAML Parser**: yaml 2.4.3 - Flow/OpenAPI 解析，AST 能力充足
- **Logger**: pino 9.0.0 - 結構化 LOG，JSON Lines、效能良好
- **Language**: TypeScript 5.4.5 - 主力開發語言，強型別支援

### Data Models
[Source: docs/architecture/資料模型.md]
**SpecDocument** – 代表單一 OpenAPI 規格：
- 屬性：`id`, `rawContent`, `document`, `schemas`
- 關聯：一對多 `FlowDefinition`、`StepResult`
- `id` 推薦使用檔案路徑或內容雜湊，確保唯一性

### Component Specifications
[Source: docs/architecture/系統元件.md]
**Spec Loader (`packages/spec-loader`)** – 解析與驗證 OpenAPI：
- 負責載入並驗證 OpenAPI 規格檔案
- 支援 JSON 和 YAML 格式
- 使用 swagger-parser 進行規格驗證
- 提供標準化的 SpecDocument 輸出格式

### File Locations
[Source: docs/architecture/原始碼結構.md]
- 主要實作：`packages/spec-loader/src/index.ts`
- 型別定義：`packages/spec-loader/src/types.ts`
- 錯誤類別：`packages/spec-loader/src/errors.ts`
- 單元測試：`packages/spec-loader/__tests__/spec-loader.test.ts`
- 測試檔案：`packages/testing/fixtures/specs/*.{json,yaml}`
- 套件配置：`packages/spec-loader/package.json`

### Technical Constraints
[Source: docs/architecture/程式撰寫規範.md]
- 禁用 `console.log/error`，統一使用 StructuredLogger
- 匯出函式需明確型別註解
- 檔案命名使用 kebab-case、類別使用 PascalCase、函式使用 camelCase
- 事件代碼使用 UPPER_SNAKE_CASE

### Error Handling Requirements
[Source: docs/architecture/錯誤處理策略.md]
- LOG 需區分 `component`（如 `spec-loader`）與共用 `executionId`
- 錯誤記錄時需同時輸出至檔案與主控台
- 依策略遮罩敏感資訊：`servers[*].url`, `securitySchemes.*`, `authorization`、`tokenUrl`、密鑰類欄位
- 自訂錯誤需附帶 `context`，方便 Orchestrator 判斷重試或中止

## Testing

### Test File Locations
[Source: docs/architecture/測試策略.md]
- 單元測試：`packages/spec-loader/__tests__/spec-loader.test.ts`
- 測試樣本：`packages/testing/fixtures/specs/` 儲存測試用 OpenAPI 規格檔案

### Testing Framework Standards
[Source: docs/architecture/測試策略.md]
- 採用 Vitest 1.6.0 與 `@vitest/coverage-v8`
- 善用 `vi.mock` 模擬外部 I/O，避免實際檔案操作
- 測試結束清理暫存檔與測試輸出
- 遵守 AAA（Arrange, Act, Assert）模式

### Specific Testing Requirements
[Source: docs/architecture/測試策略.md]
- 覆蓋率門檻：關鍵模組 `packages/spec-loader` 設定 ≥ 85%
- 測試成功載入有效的 JSON 和 YAML OpenAPI 規格（含 fixtures）
- 測試錯誤處理：無效檔案、格式錯誤、swagger-parser 驗證失敗、敏感欄位遮罩
- 驗證 `loadSpec()` 針對檔案輸入與內容輸入皆能回傳完整 `SpecDocument`
- coverage 報告需輸出至 `reports/coverage/spec-loader/` 方便追蹤

## Change Log
| Date       | Version | Description           | Author             |
|------------|---------|-----------------------|--------------------|
| 2025-09-26 | v0.1    | 初稿建立               | Bob (Scrum Master) |
| 2025-09-26 | v0.2    | 補充依賴、套件結構與測試細節 | Sarah (Product Owner) |
| 2025-09-26 | v0.3    | 修正錯誤檔案位置與測試報告路徑 | Sarah (Product Owner) |

## Dev Agent Record
_此區由開發代理於實作時填寫_

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
_此區由 QA 代理於審查時填寫_
