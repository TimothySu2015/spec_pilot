# Story 1.1: 初始化專案骨架與設定管理

## Status
Draft

## Story
**As a** 系統維運者,
**I want** 初始化 TypeScript 專案骨架與環境設定,
**so that** 團隊能在一致結構下開發與執行測試。

## Acceptance Criteria
1. 建立 TypeScript + Node.js 專案結構，包含編譯設定、ESLint/Prettier，並提供 `start`, `start:mcp`, `test`, `lint`, `dev` npm scripts。
2. 提供集中化設定管道（環境變數與設定服務）處理 `baseUrl`、`port`、`token`，支援預設值與本地覆寫。
3. 引入並配置結構化 Logger（pino、JSON Lines），可輸出到檔案及主控台，且強制記錄 `executionId`、`component`、`timestamp`。
4. README 說明初始化流程、必備環境變數、主要 scripts 與常見操作。

## Tasks / Subtasks

- [ ] 建置根目錄與 Monorepo 初始設定 (AC: 1, 4)
  - [ ] 建立 `package.json` 並設定 `type: "module"`、專案 metadata 與 scripts：`dev`, `start`, `start:mcp`, `test`, `lint`, `build`。
  - [ ] 產生 `pnpm-workspace.yaml`，納入 `apps/*`、`packages/*`、`specs/`、`flows/`、`reports/`。
  - [ ] 建立 `.gitignore` 忽略 `node_modules/`, `dist/`, `logs/`, `reports/result.json`, `.env.local`, `.DS_Store`。
  - [ ] 建立目錄骨架：`apps/cli`, `apps/mcp-server`, `packages/core-flow`, `packages/config`, `packages/shared`, `packages/testing`, `specs/`, `flows/`, `reports/`, `logs/`, `scripts/`, `docs/`。
  - [ ] 執行 `pnpm install` 產生 `pnpm-lock.yaml`，同步新增 `README.md` 大綱。

- [ ] 設定 TypeScript 編譯環境 (AC: 1)
  - [ ] 安裝 `typescript@5.4.5`、`@types/node@20`、`tsconfig-paths` 為開發依賴。
  - [ ] 建立 `tsconfig.base.json`（`module: "ESNext"`, `target: "ES2022"`, `moduleResolution: "Bundler"`, `strict: true`, `declaration: true`, `paths` 映射 `@specpilot/*` 至 `packages/*/src`）。
  - [ ] 建立 `tsconfig.build.json` 匯入 base 設定並啟用 `composite: true` 以利 tsup/vitest。
  - [ ] 確認 `packages/*/tsconfig.json` 可透過參考方式繼承 base。

- [ ] 建置程式碼品質工具鏈 (AC: 1)
  - [ ] 安裝 `eslint@9`, `@typescript-eslint/eslint-plugin@7`, `@typescript-eslint/parser@7`, `eslint-config-prettier`, `prettier@3`, `lint-staged`, `husky`。
  - [ ] 建立 `.eslintrc.cjs`（extends `eslint:recommended`, `plugin:@typescript-eslint/recommended`, `prettier`），並設定禁止 `console.log` / `console.error`。
  - [ ] 建立 `.prettierrc.cjs`（`singleQuote: true`, `trailingComma: "all"`, `printWidth: 100`）與 `.prettierignore`。
  - [ ] 建立 `lint-staged.config.mjs`，設定 TS/MD 檔案格式化與 lint。
  - [ ] 更新 `package.json` scripts：`lint` 執行 `pnpm exec eslint . --ext .ts`, `format` 執行 `pnpm exec prettier --check .`，並在 `prepare` 觸發 `husky install`。

- [ ] 建置開發與建置工具 (AC: 1)
  - [ ] 安裝 `tsx@4.7.0`、`tsup@8.0.1`、`rimraf`。
  - [ ] 新增 `tsup.config.ts`，配置 `entry` 為 `apps/*/src/index.ts` 與 `packages/*/src/index.ts`，輸出 ESM+CJS、啟用 `sourcemap` 與 `dts`。
  - [ ] 在 `package.json` scripts 中設定 `dev: "pnpm exec tsx apps/cli/src/index.ts"` 與 `start:mcp: "pnpm exec tsx apps/mcp-server/src/index.ts"`。
  - [ ] 設計 `build` 腳本：先清除 `dist/` 再執行 `pnpm exec tsup --config tsup.config.ts`。

- [ ] 建立設定管理模組 (AC: 2)
  - [ ] 安裝 `node-config@3.3.9`、`dotenv-flow@3.3.0`、`zod@3.23` 作為設定與驗證依賴。
  - [ ] 新增 `packages/config/package.json`（`type: "module"`, `main: "dist/index.cjs"`, `exports` 指向 `dist`, `types: "dist/index.d.ts"`）。
  - [ ] 建立 `packages/config/src/index.ts`，使用 `dotenv-flow` 載入 `.env.*`，以 `zod` 驗證 `SPEC_PILOT_BASE_URL`, `SPEC_PILOT_PORT`, `SPEC_PILOT_TOKEN`，提供 `getBaseUrl()`, `getPort()`, `getToken()`, `getConfig()`。
  - [ ] 建立 `config/default.ts`、`config/local.ts` 範例，設定預設 `port: 443`、`baseUrl` 留空，並允許 CLI/MCP 覆寫。
  - [ ] 新增 `.env.example`，列出所需環境變數與說明（含預設與覆寫規則）。

- [ ] 建立結構化 Logger 模組 (AC: 3)
  - [ ] 安裝 `pino@9.0.0`、`pino-pretty`（僅 dev）、`pino-multi-stream`。
  - [ ] 建立 `packages/shared/package.json` 與 `src/logger.ts`，輸出 `createStructuredLogger(component: string)`。
  - [ ] Logger 預設輸出 JSON Lines，欄位包含 `timestamp`, `level`, `executionId`, `component`, `message`, `context`。
  - [ ] 設定檔案輸出為 `logs/specpilot.log`（按日期輪替），同時輸出到 `process.stdout`。
  - [ ] 製作 `packages/shared/src/logger.test.ts`，驗證 logger 格式與欄位存在。

- [ ] 建立測試基礎設施 (AC: 1, 2, 3)
  - [ ] 安裝 `vitest@1.6.0`, `@vitest/coverage-v8`, `ts-node`, `c8`。
  - [ ] 建立 `vitest.config.ts`，啟用 `coverage`（`provider: "v8"`, `lines: 0.8`, `functions: 0.8`, `branches: 0.75`，核心模組 `packages/config`, `packages/shared` 設定 `thresholds: 0.85`）。
  - [ ] 建立 `packages/testing`，內含 `package.json`、`src/index.ts`（測試工具）、`__tests__/` 範例。
  - [ ] 建立初始單元測試：`packages/config/__tests__/config.test.ts`、`packages/shared/__tests__/logger.test.ts`。
  - [ ] 在 `package.json` scripts 設定 `test: "pnpm exec vitest run --coverage"`。

- [ ] 撰寫 README 與開發文件 (AC: 4)
  - [ ] 撰寫 `README.md`，涵蓋：專案目的、資料夾結構、安裝步驟、常用 scripts 說明、環境變數與設定覆寫流程。
  - [ ] 提供 CLI/MCP 啟動示例與 logs/報表輸出的檔案位置。
  - [ ] 記錄測試與 lint 命令、coverage 門檻、Git hooks（如使用 husky）的執行流程。
  - [ ] 在 README 中連結 `docs/prd/epic-details.md` 與 `docs/architecture/` 相關章節。

## Dev Notes

### Previous Story Insights
- 這是專案的首個故事，無先前累積事項。

### Technology Stack Requirements
- 依 `docs/architecture/技術堆疊.md` 指定版本：TypeScript 5.4.5、Node.js 20.11.1 LTS、pnpm 9.1、commander 11.1、pino 9.0.0、Vitest 1.6.0、tsx 4.7.0、tsup 8.0.1、node-config 3.3、dotenv-flow 3.3。

### Project Structure Requirements
- 依 `docs/architecture/原始碼結構.md` 建立目錄：`apps/cli`, `apps/mcp-server`, `packages/{core-flow,spec-loader,flow-parser,http-runner,validation,reporting,config,shared,testing}`, 以及 `specs/`, `flows/`, `reports/`, `logs/`, `docs/`, `scripts/`。
- 所有套件以 `packages/*/src` 為入口，透過 tsconfig path alias 匯入。

### Coding Standards
- 依 `docs/architecture/程式撰寫規範.md`：使用 ESM、嚴格型別、禁止 `any`、函式使用 `camelCase`、類別 `PascalCase`、檔名 `kebab-case`。
- 禁用 `console.*`，統一透過 StructuredLogger。
- 公用函式需附 JSDoc 撰寫參數與回傳值說明。

### Configuration Management Requirements
- 依 `docs/prd/secrets-與-token-管理流程.md`：敏感資訊透過環境變數或 config 檔案載入，不可提交憑證。
- `.env.local` 僅供本機開發；預設設定放在 `config/default.ts`，環境覆寫在 `config/{production,staging}.ts`。
- CLI/MCP 可透過參數覆寫設定值，需確保與設定服務互通。

### Logging Requirements
- 依 `docs/architecture/錯誤處理策略.md`：所有流程事件需記錄 JSON Lines，包含請求摘要、結果與錯誤堆疊。
- LOG 需區分 `component`（如 `config`, `logger`, `bootstrap`）與共用 `executionId`。
- 錯誤記錄時需同時輸出至檔案與主控台，避免失真。

### Testing Standards
- 依 `docs/architecture/測試策略.md`：單元測試放置於 `packages/*/__tests__/` 或 `packages/*/tests/unit/`，整合測試放於 `tests/integration/`。
- 採用 AAA（Arrange, Act, Assert），避免共享狀態。
- 覆蓋率門檻：語句與函式 ≥ 80%，`packages/config` 與 `packages/shared` 模組 ≥ 85%，未達門檻需於 README 說明例外與補救計畫。

## Testing

### Test File Locations
- 單元測試：`packages/{package-name}/__tests__/` 或 `packages/{package-name}/tests/unit/`
- 整合測試：`tests/integration/`
- 測試樣本與 fixture：`packages/testing/fixtures/`、`specs/demo/`、`flows/demo/`

### Testing Framework Standards
- 採用 Vitest 1.6.0 與 `@vitest/coverage-v8`。
- 善用 `vi.mock` 模擬外部 I/O，避免實際網路呼叫。
- 測試結束清理暫存檔與 `logs/`、`reports/` 測試輸出。

### Specific Testing Requirements
- 為 `packages/config` 建立成功與缺失變數的測試案例，驗證預設值與錯誤訊息。
- 為 `packages/shared/logger` 驗證 JSON Lines 結構與欄位完整性。
- 確認 `pnpm run test` 會自動執行 coverage 並產生報告，README 需說明輸出路徑。

## Change Log
| Date       | Version | Description         | Author             |
|------------|---------|---------------------|--------------------|
| 2025-01-14 | v0.1    | 初稿建立             | Bob (Scrum Master) |
| 2025-09-26 | v0.2    | 修正編碼與補足細節   | Sarah (Product Owner) |

## Dev Agent Record
*此區由開發代理於實作時填寫*

### Agent Model Used
*待填寫*

### Debug Log References
*待填寫*

### Completion Notes List
*待填寫*

### File List
*待填寫*

## QA Results
*此區由 QA 代理於驗收後填寫*
