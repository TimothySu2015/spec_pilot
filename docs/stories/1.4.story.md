# Story 1.4: 基礎 CLI 指令與設定覆寫

## Status

Draft

## Story

**As a** DevOps 工程師,
**I want** 透過 CLI 指定規格/流程與環境設定,
**so that** 可在不同環境快速執行測試。

## Acceptance Criteria

1. CLI 支援 `--spec`, `--flow`, `--baseUrl`, `--port`, `--token`。
2. CLI 能呼叫 Story 1.2、1.3 的功能並回報結果。
3. 預設值來自集中設定，CLI 參數可覆寫。
4. CLI 執行紀錄於 LOG，包含解析摘要。

## Tasks / Subtasks

- [ ] 完善 CLI 基礎設施與 Commander.js 整合 (AC: 1)
  - [ ] 完善 `apps/cli/src/index.ts` 中的 Commander.js 參數解析，確保支援所有必要選項
  - [ ] 加入完整的參數驗證邏輯，必填參數檢查與類型轉換
  - [ ] 實作參數覆寫機制，與 `@specpilot/config` 無縫整合
  - [ ] 添加 `--verbose` 選項控制日誌詳細程度

- [ ] 實作規格載入功能整合 (AC: 2)
  - [ ] 整合 `@specpilot/spec-loader` 套件，處理 `--spec` 參數指定的檔案
  - [ ] 加入檔案路徑驗證與存在性檢查
  - [ ] 實作規格載入成功/失敗的統一錯誤處理
  - [ ] 在日誌中記錄規格載入摘要資訊

- [ ] 實作流程解析功能整合 (AC: 2)
  - [ ] 整合 `@specpilot/flow-parser` 套件，處理 `--flow` 參數指定的檔案
  - [ ] 加入流程檔案驗證與 YAML 格式檢查
  - [ ] 實作流程解析成功/失敗的統一錯誤處理
  - [ ] 在日誌中記錄流程解析摘要資訊（步驟數量、全域設定等）

- [ ] 實作設定管理與環境變數覆寫 (AC: 3)
  - [ ] 確認 `@specpilot/config` 套件提供正確的設定載入與覆寫功能
  - [ ] 實作 CLI 參數優先級邏輯：CLI 參數 > 環境變數 > 預設設定檔
  - [ ] 加入設定值驗證，確保必要的 baseUrl、port 等參數有效
  - [ ] 在啟動時記錄最終使用的設定值（敏感資訊遮罩）

- [ ] 實作結構化日誌記錄 (AC: 4)
  - [ ] 整合 `@specpilot/shared` 的 StructuredLogger，component 使用 `cli`
  - [ ] 記錄 CLI 啟動事件：`CLI_START`，包含參數與設定摘要
  - [ ] 記錄解析事件：`SPEC_LOAD_SUMMARY`, `FLOW_LOAD_SUMMARY`
  - [ ] 記錄 CLI 完成事件：`CLI_COMPLETE` 或 `CLI_FAILURE`
  - [ ] 確保敏感資訊（token）在日誌中適當遮罩

- [ ] 建立使用者友善的錯誤處理與訊息 (AC: 1-4)
  - [ ] 實作統一的錯誤處理機制，將技術錯誤轉換為使用者友善訊息
  - [ ] 加入明確的幫助訊息和使用範例
  - [ ] 實作適當的退出碼：0（成功）、1（測試失敗）、2（系統錯誤）
  - [ ] 在錯誤發生時提供具體的修復建議

- [ ] 建立 CLI 單元測試 (AC: 1-4)
  - [ ] 建立 `apps/cli/__tests__/cli-integration.test.ts`，測試完整 CLI 流程
  - [ ] 使用 `execa` 測試 CLI 執行，模擬不同參數組合
  - [ ] 測試錯誤處理：缺少參數、無效檔案路徑、設定錯誤
  - [ ] 使用 `vi.mock` 模擬外部套件（spec-loader, flow-parser），驗證呼叫正確性
  - [ ] 確保測試覆蓋率達到 85%

- [ ] 完善 CLI 說明文件與使用範例 (AC: 1-4)
  - [ ] 更新 `apps/cli/package.json` 的 description 和 scripts
  - [ ] 確認 `bin/specpilot.ts` 正確配置為可執行的 CLI 入口點
  - [ ] 在 CLI 中加入完整的 `--help` 輸出，包含使用範例
  - [ ] 驗證 pnpm scripts（`pnpm run start`）可正確執行 CLI

## Dev Notes

### Previous Story Insights

- Story 1.1 建立了 `@specpilot/config` 套件與 StructuredLogger 基礎設施
- Story 1.2 實作了 `@specpilot/spec-loader` 套件，提供 `loadSpec()` 函式載入 OpenAPI 規格
- Story 1.3 完成了 `@specpilot/flow-parser` 套件，提供 `loadFlow()` 函式解析 YAML 流程
- 現有的 `apps/cli/src/index.ts` 已有基本的 Commander.js 架構，需要整合前述套件

### Technology Stack Requirements

[Source: docs/architecture/技術堆疊.md]

- **CLI Framework**: commander 11.1 - 指令解析，PRD 指定、API 穩定
- **Package Manager**: pnpm 9.1 - Monorepo 管理，節省磁碟、工作區支援成熟
- **Logger**: pino 9.0.0 - 結構化 LOG，JSON Lines、效能良好
- **Language**: TypeScript 5.4.5 - 主力開發語言，強型別支援
- **Config**: node-config / dotenv-flow - 多環境設定，支援檔案階層與密碼管理

### Component Specifications

[Source: docs/architecture/系統元件.md]

**CLI Interface (`apps/cli`)** – 解析指令、呼叫流程協調器、處理退出碼：
- 使用 Commander.js 解析 CLI 參數
- 整合 `@specpilot/spec-loader` 和 `@specpilot/flow-parser`
- 透過 `@specpilot/config` 管理設定覆寫
- 提供使用者友善的錯誤訊息和退出碼

### File Locations

[Source: docs/architecture/原始碼結構.md]

- CLI 主要實作：`apps/cli/src/index.ts`
- CLI 執行入口：`apps/cli/bin/specpilot.ts`
- CLI 測試檔案：`apps/cli/__tests__/cli-integration.test.ts`
- CLI 套件配置：`apps/cli/package.json`

### Technical Constraints

[Source: docs/architecture/程式撰寫規範.md]

- 禁用 `console.log/error`，統一使用 StructuredLogger
- 匯出函式需明確型別註解
- 檔案命名使用 kebab-case、類別使用 PascalCase、函式使用 camelCase
- 事件代碼使用 UPPER_SNAKE_CASE
- CLI 回應必須提供適當的退出碼

### Error Handling Requirements

[Source: docs/architecture/錯誤處理策略.md]

- LOG 需區分 `component`（如 `cli`）與共用 `executionId`
- 錯誤記錄時需同時輸出至檔案與主控台
- 業務錯誤：CLI 提供可讀訊息與報告位置
- 敏感資訊遮罩：token、auth header 等欄位需遮罩為 '***'

### Testing Requirements

[Source: docs/architecture/測試策略.md]

- **Test Framework**: Vitest 1.6.0 with `@vitest/coverage-v8`
- **Integration Tests**: `apps/cli/__tests__/cli-integration.test.ts`
- **Coverage Target**: ≥ 85% for critical modules like CLI
- **Mock Strategy**: 使用 `execa` 測試 CLI 執行，`vi.mock` 模擬外部依賴
- **Test Pattern**: 遵守 AAA（Arrange, Act, Assert）模式
- **Test Categories**:
  - CLI 參數解析與驗證
  - 設定載入與覆寫邏輯
  - 規格/流程載入整合測試
  - 錯誤處理與退出碼驗證
  - 日誌事件記錄測試

### Integration Points

- **依賴套件**: `@specpilot/config`, `@specpilot/spec-loader`, `@specpilot/flow-parser`, `@specpilot/shared`
- **設定優先級**: CLI 參數 > 環境變數 > 設定檔預設值
- **退出碼規範**: 0（成功）、1（測試失敗）、2（系統錯誤）
- **日誌標準**: 使用 `executionId` 追蹤單次執行，`component: 'cli'` 標識來源

## Change Log

| Date       | Version | Description | Author             |
| ---------- | ------- | ----------- | ------------------ |
| 2025-09-26 | v0.1    | 初稿建立    | Bob (Scrum Master) |

## Dev Agent Record

_此區由開發代理於實作時填寫_

## QA Results

_此區由 QA 代理審查時填寫_