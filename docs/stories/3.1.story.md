# Story 3.1: 建立 MCP 服務啟動器

## Status

Draft

## Story

**As a** AI Agent 運維人員,
**I want** 啟動 MCP JSON-RPC 服務,
**so that** AI 可以透過 STDIN/STDOUT 執行指令並取得結果。

## Acceptance Criteria

1. 執行 `pnpm run start:mcp` 能啟動 MCP 服務並綁定 STDIN/STDOUT 流，啟動完成後持續等待請求。
2. MCP 服務遵循 JSON-RPC 2.0，能驗證請求格式、路由至對應處理器並回傳正確格式的成功或錯誤回應。
3. 服務啟動、請求處理與錯誤流程皆使用 StructuredLogger 輸出 JSON Lines 日誌，包含 `executionId`、`component`、事件型別與摘要。
4. 服務能在收到 SIGINT/SIGTERM 或遇到未捕捉例外時執行優雅關閉，釋放資源、拒絕未完成請求並輸出對應錯誤資訊。

## Tasks / Subtasks

- [ ] 建立 MCP 服務啟動流程 (AC: 1, 4)
  - [ ] 更新 `apps/mcp-server/src/index.ts`，透過 `bootstrapMcpServer()` 啟動服務並綁定 STDIN/STDOUT。
  - [ ] 在 `apps/mcp-server/src/bootstrap.ts` 實作 `bootstrapMcpServer`，初始化 StructuredLogger、載入設定並建立 `McpServer` 實例。
  - [ ] 確認現有設定來源（如 `packages/config` 或 `.env`）提供啟動所需參數，例如 `executionId`、`component` 名稱與逾時設定。
  - [ ] 檢查 `apps/mcp-server/package.json` 的 `start:mcp` 指令使用 `pnpm exec tsx apps/mcp-server/src/index.ts`，必要時調整成正確路徑。
  - [ ] 建立服務關閉流程：註冊 SIGINT/SIGTERM 監聽、完成清理並結束程序。

- [ ] 強化 JSON-RPC 要求處理 (AC: 2)
  - [ ] 在 `apps/mcp-server/src/rpc-handler.ts` 定義並匯出 `IMcpRequest`、`IMcpResponse` 型別。
  - [ ] 實作請求驗證：檢查 `jsonrpc === "2.0"`、`method`、`id` 與 `params` 結構。
  - [ ] 根據 `method` 路由至 `src/handlers/` 內的對應邏輯，並支援未知方法時回傳 `-32601` 錯誤。
  - [ ] 補齊錯誤轉換邏輯，將解析錯誤、無效請求與內部例外對應至 JSON-RPC 錯誤碼。
  - [ ] 確保所有回應皆帶有原請求 `id`；未提供 `id` 的通知請求不得回覆。

- [ ] 實作結構化日誌 (AC: 3)
  - [ ] 在啟動完成時輸出 `component: "mcp-server"`、事件為 `service_started` 的日誌。
  - [ ] 對每一個請求輸出 `request_received` 日誌，包含 `method`、`id`、`params` 摘要。
  - [ ] 對成功回應輸出 `response_sent` 日誌，對錯誤回應輸出 `response_error` 日誌，記錄 `error.code` 與 `error.message`。
  - [ ] 於關閉流程輸出 `service_stopped` 日誌，包含結束原因與統計資訊（如處理請求數量）。

- [ ] 建立錯誤處理與資源清理 (AC: 4)
  - [ ] 為未捕捉的 Promise rejection 與未處理例外註冊全域監聽，確保記錄日誌並執行優雅關閉。
  - [ ] 在 `bootstrapMcpServer` 中確保所有非同步啟動步驟皆捕捉錯誤並回傳適當的 JSON-RPC error。
  - [ ] 確認 STDIN/STDOUT stream 於關閉時正確解除監聽與結束。
  - [ ] 為每個 JSON-RPC 處理程序設定逾時或中止機制，避免服務卡住。

- [ ] 建立整合測試與模擬流程 (AC: 1, 2, 3, 4)
  - [ ] 在 `apps/mcp-server/__tests__/mcp-server.test.ts` 撰寫整合測試，模擬 STDIN/STDOUT 傳遞多個請求與回應。
  - [ ] 編寫成功案例：啟動服務並呼叫至少一個已註冊方法，驗證回應格式與內容。
  - [ ] 編寫錯誤案例：傳入格式錯誤或未知方法，驗證 JSON-RPC error code 與訊息。
  - [ ] 測試優雅關閉：模擬 SIGINT，確認服務寫入停止日誌並釋放資源。
  - [ ] 使用 Vitest fake timers 或 mock 物件確保逾時與資源清理流程可測。

## Dev Notes

### 前一故事的重要情資

來源：`docs/stories/2.5.story.md`（Dev Agent Record）

- Epic 2 已建立 StructuredLogger 與 Config Service，可重複使用並延伸設定。
- JSON Schema 驗證、錯誤處理與 CLI 自動化流程已完成，可作為測試與整合參考。
- CLI 端已整合 CI 與報告輸出，MCP 服務需與既有輸出格式保持一致。

### 系統架構與檔案配置

來源：`docs/architecture/index.md`（章節：系統設計、程式檔案結構）

- MCP 伺服器位於 `apps/mcp-server/`。
  - 入口：`src/index.ts`
  - 啟動組態：`src/bootstrap.ts`
  - JSON-RPC 請求處理：`src/rpc-handler.ts`
  - 方法處理器：`src/handlers/`
  - 測試：`__tests__/mcp-server.test.ts`
- `pnpm run start:mcp` 應透過 tsx 執行 `src/index.ts`，供本地與 MCP 容器啟動。

### 技術堆疊與限制

來源：`docs/architecture/index.md`（章節：技術棧、程式碼規範）

- Node.js 20.11.1 LTS、TypeScript 5.4.5、pnpm 9.1。
- 必須使用 StructuredLogger 輸出 JSON Lines，禁止 `console.log`。
- 檔案命名：檔案 kebab-case、類別 PascalCase、函式 camelCase。
- MCP 回應必須符合 JSON-RPC 2.0 格式。

### JSON-RPC 型別定義

來源：`docs/architecture/index.md`（章節：資料模型）

```typescript
interface IMcpRequest {
  jsonrpc: '2.0';
  method: string;
  params?: unknown;
  id?: string | number;
}

interface IMcpResponse {
  jsonrpc: '2.0';
  id: string | number | null;
  result?: unknown;
  error?: {
    code: number;
    message: string;
    data?: unknown;
  };
}
```

**錯誤處理**：錯誤資訊封裝在 `IMcpResponse.error` 物件中，包含 `code`、`message` 與可選的 `data` 欄位。

常用錯誤碼：`-32700`（Parse error）、`-32600`（Invalid Request）、`-32601`（Method not found）、`-32602`（Invalid params）、`-32603`（Internal error）。

### 日誌策略

來源：`docs/architecture/logging.md`

- 所有日誌需包含 `executionId`、`component`、`timestamp`、事件型別與摘要資訊。
- 啟動、請求、回應、錯誤、關閉等事件皆需寫入日誌。
- 重大錯誤需附帶 `error.code`、`error.message` 與 stack 摘要。

### 錯誤與關閉流程

來源：`docs/architecture/index.md`（章節：錯誤處理策略）

- 服務需攔截未處理例外與未捕捉的 Promise rejection。
- 收到 SIGINT/SIGTERM 時需停止讀寫 STDIN/STDOUT，通知客戶端服務已關閉。
- 需釋放所有已註冊的 listener 或計時器，避免程序懸掛。

## Testing

### 測試檔案位置

- 單元／整合測試：`apps/mcp-server/__tests__/mcp-server.test.ts`
- 共用 fixtures：`packages/testing/fixtures/`

### 測試標準

- 使用 Vitest 1.6.0。
- 測試依 AAA（Arrange、Act、Assert）模式撰寫。
- 確保 JSON-RPC 回應格式與錯誤處理皆被覆蓋，程式覆蓋率維持專案 85% 標準以上。

### 本故事測試要求

- 建立啟動測試：模擬 `pnpm run start:mcp`，確認服務啟動成功並綁定 STDIN/STDOUT。
- 建立請求／回應測試：透過模擬輸入 JSON-RPC 請求，驗證成功回應內容。
- 建立錯誤測試：傳入格式錯誤、未知方法與錯誤參數，確認返回對應錯誤碼。
- 建立日誌測試：驗證 StructuredLogger 寫入啟動、請求、回應、錯誤與關閉事件。
- 建立關閉流程測試：模擬 SIGINT/SIGTERM，確認服務釋放資源並輸出停止日誌。

## Change Log

| Date       | Version | Description                                                   | Author             |
| ---------- | ------- | ------------------------------------------------------------- | ------------------ |
| 2025-09-28 | v0.1    | 初次建立                                                       | Bob (Scrum Master) |
| 2025-09-28 | v0.2    | 修正亂碼、統一啟動指令並補足任務與測試細節                     | Sarah (Product Owner) |
| 2025-09-28 | v0.3    | 移除IMcpError型別參考，統一使用IMcpResponse.error；確認pnpm指令正確 | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used

_等待開發時填寫_

### Debug Log References

_等待開發時填寫_

### Completion Notes

_等待開發時填寫_

### File List

_等待開發時填寫_

## QA Results

_待 QA 填寫_
