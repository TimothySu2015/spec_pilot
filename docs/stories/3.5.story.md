# Story 3.5: MCP 介面文件與範例

## Status

允許

## Story

**As a** 使用者,
**I want** 了解 MCP 介面如何呼叫,
**so that** 能整合到自動化流程。

## Acceptance Criteria

1. 文件說明 MCP 啟動方式、支援方法與參數、回應範例
2. 提供 JSON-RPC 範例請求檔或腳本
3. 說明錯誤格式與常見錯誤碼
4. README 更新 MCP 章節

## Tasks / Subtasks

- [ ] **任務 1**: 建立 MCP 介面完整文件 (AC: 1, 3) _[核心文件]_
  - [ ] 在 `docs/` 目錄下建立 `mcp-interface.md` 文件
  - [ ] 文件說明 MCP 啟動方式（`pnpm run start:mcp`）
  - [ ] 文件說明四個支援方法：`listSpecs`、`listFlows`、`runFlow`、`getReport`
  - [ ] 為每個方法提供參數說明、請求/回應範例、錯誤情況
  - [ ] 說明 JSON-RPC 2.0 格式與常見錯誤碼（-32700 到 -32603）
  - [ ] 包含實際的 JSON 請求/回應範例

- [ ] **任務 2**: 建立 JSON-RPC 範例請求檔案 (AC: 2) _[依賴：任務 1]_
  - [ ] 在 `docs/examples/` 目錄下建立 MCP 範例檔案
  - [ ] 建立 `listSpecs-example.json` - listSpecs 方法的 JSON-RPC 請求範例
  - [ ] 建立 `listFlows-example.json` - listFlows 方法的 JSON-RPC 請求範例
  - [ ] 建立 `runFlow-example.json` - runFlow 方法的 JSON-RPC 請求範例（檔案模式與內容模式）
  - [ ] 建立 `getReport-example.json` - getReport 方法的 JSON-RPC 請求範例
  - [ ] 建立 `mcp-test-script.js` - Node.js 測試腳本，包含連線、請求發送、回應處理功能
  - [ ] 每個範例檔案使用標準 JSON-RPC 2.0 格式（jsonrpc、method、params、id 欄位）

- [ ] **任務 3**: 建立錯誤處理與診斷文件 (AC: 3) _[依賴：任務 1]_
  - [ ] 在 `mcp-interface.md` 中新增錯誤處理章節
  - [ ] 說明 JSON-RPC 錯誤碼意義與常見情況
  - [ ] 提供錯誤診斷指引與常見問題解決方法
  - [ ] 包含結構化日誌查看方式與錯誤追蹤指引

- [ ] **任務 4**: 更新 README MCP 章節 (AC: 4) _[依賴：任務 1, 2, 3]_
  - [ ] 更新 `README.md` 中的 MCP 伺服器操作章節
  - [ ] 新增詳細的 MCP 介面說明與使用範例
  - [ ] 新增連結指向完整的 MCP 介面文件
  - [ ] 確保 MCP 相關資訊與其他文件一致性

- [ ] **任務 5**: 建立文件測試與驗證 (AC: 1, 2, 3, 4) _[依賴：任務 4]_
  - [ ] 手動驗證所有 JSON-RPC 範例檔案格式正確
  - [ ] 確認文件中的指令與實際 MCP 實作一致
  - [ ] 檢查文件連結與交叉參照正確性
  - [ ] 驗證範例腳本可執行性

## Dev Notes

### 前一故事的重要情資

來源：`docs/stories/3.4.story.md`（Dev Agent Record）

- Story 3.4 已完成 `getReport` 方法，MCP 伺服器四個核心方法全部實作完成
- MCP 伺服器架構完善，JSON-RPC 2.0 實作包含完整錯誤處理機制
- 已確認的四個 MCP 方法：`listSpecs`、`listFlows`、`runFlow`、`getReport`
- StructuredLogger 整合完成，支援事件記錄與敏感資料遮罩
- JSON-RPC 錯誤處理使用標準錯誤碼：-32700（解析錯誤）到 -32603（內部錯誤）

### 系統架構與檔案配置

來源：`docs/architecture/原始碼結構.md`

- MCP 伺服器位於 `apps/mcp-server/`，啟動指令 `pnpm run start:mcp`
- 方法處理器存放於 `src/handlers/`：list-specs.ts、list-flows.ts、run-flow.ts、get-report.ts
- 文件應放在 `docs/` 目錄，範例檔案建議放在 `docs/examples/` 下
- README.md 已有基本 MCP 章節，需要擴充詳細資訊

### JSON-RPC 介面定義

來源：`apps/mcp-server/src/rpc-handler.ts`

**核心介面結構**：

```typescript
// JSON-RPC 2.0 請求格式
interface IMcpRequest {
  jsonrpc: '2.0';
  method: string;
  params?: unknown;
  id?: string | number;
}

// JSON-RPC 2.0 回應格式
interface IMcpResponse {
  jsonrpc: '2.0';
  id: string | number | null;
  result?: unknown;
  error?: {
    code: number;
    message: string;
    data?: unknown;
  };
}
```

**標準 JSON-RPC 範例範本**：

```json
// 基本請求範本
{
  "jsonrpc": "2.0",
  "method": "methodName",
  "params": { /* 方法參數 */ },
  "id": "unique-request-id"
}

// 成功回應範本
{
  "jsonrpc": "2.0",
  "id": "unique-request-id",
  "result": { /* 回應資料 */ }
}

// 錯誤回應範本
{
  "jsonrpc": "2.0",
  "id": "unique-request-id",
  "error": {
    "code": -32603,
    "message": "錯誤訊息",
    "data": { /* 額外錯誤資訊 */ }
  }
}
```

**支援的方法與參數**：

1. **listSpecs** - 無參數，回傳 `IFileListItem[]`
2. **listFlows** - 可選參數：`{ directory?, prefix?, filename? }`，回傳 `IFileListItem[]`
3. **runFlow** - 參數：`IRunFlowParams`（支援檔案模式與內容模式），回傳 `IRunFlowResult`
4. **getReport** - 無參數，回傳 `IGetReportResult`

### MCP 方法詳細規格

來源：`apps/mcp-server/src/handlers/` 各方法實作

#### listSpecs 方法

- **目的**：列出 `specs/` 目錄下可用的 OpenAPI 規格檔案
- **參數**：無
- **回傳**：檔案清單，包含 name、path、size、extension
- **錯誤情況**：目錄不存在、讀取權限錯誤

#### listFlows 方法

- **目的**：列出可用的測試流程 YAML 檔案
- **參數**：
  - `directory`（選用）：指定搜尋目錄
  - `prefix`（選用）：檔名前綴篩選
  - `filename`（選用）：完整檔名搜尋
- **回傳**：檔案清單，預設搜尋 `flows/` 目錄下 `.yaml/.yml` 檔案
- **安全性**：包含目錄驗證，防止路徑遍歷攻擊

#### runFlow 方法

- **目的**：執行測試流程
- **兩種模式**：
  - 檔案模式：`{ spec: "path/to/spec", flow: "path/to/flow" }`
  - 內容模式：`{ specContent: "...", flowContent: "..." }`
- **覆寫設定**：支援 `baseUrl`、`port`、`token` 參數
- **回傳**：執行結果包含 executionId、status、reportSummary、reportPath
- **限制**：內容大小限制 10MB

#### getReport 方法

- **目的**：取得最新測試報表
- **參數**：無
- **搜尋順序**：`reports/result.json` → `test-reports/test-report.json`
- **回傳**：報表摘要與完整內容
- **錯誤情況**：檔案不存在、損壞、權限錯誤

### JSON-RPC 錯誤碼規格

來源：`apps/mcp-server/src/rpc-handler.ts#JSON_RPC_ERROR_CODES`

- **-32700**：解析錯誤（Parse error）- JSON 格式錯誤
- **-32600**：無效請求（Invalid Request）- 請求格式不符合 JSON-RPC 2.0
- **-32601**：方法不存在（Method not found）- 呼叫的方法不存在
- **-32602**：無效參數（Invalid params）- 方法參數格式錯誤
- **-32603**：內部錯誤（Internal error）- 伺服器內部執行錯誤

### 結構化日誌系統

來源：`docs/architecture/logging.md`、現有實作模式

- 使用 StructuredLogger 進行 JSON Lines 日誌記錄
- 日誌位置：`logs/specpilot.log`
- 事件類型：`{method}_start`、`{method}_success`、`{method}_error`
- 必要欄位：`timestamp`、`executionId`、`component`、`method`、`event`、`details`
- 敏感資料自動遮罩：token、password、secret 等欄位

### MCP 測試腳本實作指引

**`mcp-test-script.js` 基本功能要求**：

- 建立 STDIN/STDOUT 通訊管道
- 實作 JSON-RPC 2.0 請求/回應處理
- 提供四個 MCP 方法的測試函式
- 包含錯誤處理與逾時機制
- 使用範例：`node docs/examples/mcp-test-script.js`

**腳本基本結構**：

```javascript
// 連線與通訊處理
function sendRequest(method, params) {
  /* 實作 */
}

// 四個 MCP 方法的測試函式
function testListSpecs() {
  /* 實作 */
}
function testListFlows() {
  /* 實作 */
}
function testRunFlow() {
  /* 實作 */
}
function testGetReport() {
  /* 實作 */
}

// 主執行邏輯
async function main() {
  /* 執行所有測試 */
}
```

### 文件結構要求

來源：`docs/architecture/程式撰寫規範.md`

- 文件使用繁體中文撰寫
- Markdown 格式，包含程式碼區塊語法高亮
- 提供實際可執行的範例
- 包含錯誤處理與診斷指引
- 與現有文件結構保持一致

### CLI 與 MCP 介面比較

**CLI 介面**（`pnpm run start`）：

- 適用場景：本地開發、CI/CD 流水線、手動測試
- 參數方式：命令列參數（--spec、--flow、--baseUrl 等）
- 輸出方式：終端輸出 + 檔案報表
- 執行模式：一次性執行，完成後結束

**MCP 介面**（`pnpm run start:mcp`）：

- 適用場景：AI Agent 整合、遠端呼叫、自動化系統
- 參數方式：JSON-RPC 2.0 格式的 STDIN/STDOUT 通訊
- 輸出方式：結構化 JSON 回應
- 執行模式：持續運作的服務，支援多次呼叫

### Testing

#### 測試標準

來源：`docs/architecture/測試策略.md`

- **測試框架**：Vitest 1.6.0，文件驗證不需要單元測試
- **驗證要求**：
  - JSON 範例檔案格式正確性
  - 文件內容與實作一致性
  - 範例腳本可執行性
- **文件測試**：手動驗證文件品質與準確性

#### 本故事測試要求

- **文件內容驗證**：
  - 檢查所有 MCP 方法文件與實作一致
  - 驗證 JSON-RPC 範例格式正確
  - 確認錯誤碼說明準確性
- **範例檔案驗證**：
  - JSON 範例檔案可被 JSON.parse 正確解析
  - 測試腳本範例可執行（Node.js 環境）
- **文件連結驗證**：
  - 檢查文件間交叉參照正確性
  - 確認 README 更新與其他文件一致

## Dev Agent Record

此段落由開發代理在實作過程中填寫。

## Change Log

| Date       | Version | Description                                                             | Author                |
| ---------- | ------- | ----------------------------------------------------------------------- | --------------------- |
| 2025-09-28 | v0.1    | 初次建立                                                                | Bob (Scrum Master)    |
| 2025-09-28 | v0.2    | PO 驗證修正：新增 JSON-RPC 範例範本、測試腳本實作指引、CLI/MCP 比較說明 | Sarah (Product Owner) |
