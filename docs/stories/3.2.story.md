# Story 3.2: 實作 `listSpecs` 與 `listFlows` MCP 方法

## Status

Draft

## Story

**As a** AI Agent,
**I want** 查詢可用的規格與流程清單,
**so that** 能快速選擇測試資源。

## Acceptance Criteria

1. `listSpecs` 回傳 `specs/` 目錄下 `.json`/`.yaml` 檔案清單，回應需包含檔名、相對路徑與大小等基本欄位。
2. `listFlows` 預設回傳 `flows/` 內所有 `.yaml` 檔案，並支援以參數（目錄、檔名前綴、完整檔名）進行篩選，參數須通過驗證後才可使用。
3. `listSpecs` 與 `listFlows` 的 JSON-RPC 成功回應 `result` 必須為 `IFileListItem[]`；當無符合項目時傳回空陣列（`[]`），僅在參數無效或檔案系統錯誤時改以標準錯誤碼 `-32602`/`-32603` 回應。
4. 操作過程需使用 StructuredLogger 記錄事件（開始、成功、錯誤），並附帶目錄、篩選結果與錯誤摘要等資訊。

## Tasks / Subtasks

- [ ] 實作 `listSpecs` 方法處理器 (AC: 1, 3, 4)
  - [ ] 更新 `apps/mcp-server/src/handlers/list-specs.ts`，實作檔案系統掃描邏輯以讀取 `specs/` 目錄並排除子目錄。
  - [ ] 過濾出 `.json` 與 `.yaml`/`.yml` 副檔名的檔案，組成 `IFileListItem` 陣列回傳。
  - [ ] 若沒有符合檔案，回傳空陣列並記錄 `list_specs_success` 日誌；僅在目錄不存在或存取錯誤時回傳 `-32603` 錯誤。
  - [ ] 使用 StructuredLogger 記錄 `list_specs_start`、`list_specs_success`、`list_specs_error`，細節需包含目錄路徑、檔案數量或錯誤訊息。

- [ ] 實作 `listFlows` 方法處理器並支援參數篩選 (AC: 2, 3, 4)
  - [ ] 更新 `apps/mcp-server/src/handlers/list-flows.ts`，預設掃描 `flows/` 目錄，回傳 `.yaml`/`.yml` 檔案的 `IFileListItem[]`。
  - [ ] 驗證並正規化 `params.directory`：限制在專案 `flows/` 目錄底下，拒絕 `..` 或絕對路徑，超出範圍時回傳 `-32602`。
  - [ ] 套用 `prefix` 與 `filename` 篩選條件，支援大小寫一致的比對與多條件組合。
  - [ ] 若無符合檔案，回傳空陣列並記錄包含篩選條件的 `list_flows_success` 日誌；僅在參數無效或檔案系統錯誤時回傳 `-32602`/`-32603`。
  - [ ] 記錄 `list_flows_start`、`list_flows_success`、`list_flows_error` 日誌，`details` 欄位需包含套用的篩選條件與結果。

- [ ] 統一回應格式與錯誤處理 (AC: 3)
  - [ ] 在 `apps/mcp-server/src/rpc-handler.ts` 定義並匯出 `IFileListItem` 介面（若尚未存在），並提供建立成功/錯誤回應的共用函式。
  - [ ] 調整 `listSpecs`、`listFlows` 以共用 `IFileListItem` 型別與 JSON-RPC 回應建構工具，確保成功回應使用空陣列表達無結果。
  - [ ] 統一錯誤回應流程：記錄 StructuredLogger 錯誤日誌後，回傳符合 JSON-RPC 2.0 規範的錯誤物件，`data` 可附帶部分除錯資訊（例如觸發的參數）。

- [ ] 整合至 MCP 服務路由 (AC: 1, 2, 3)
  - [ ] 更新 `apps/mcp-server/src/handlers/index.ts`，確保 `listSpecs` 與 `listFlows` 已正確匯出且簽章一致。
  - [ ] 驗證 `apps/mcp-server/src/rpc-handler.ts` 或 `bootstrap.ts` 的路由邏輯能正確對應 `method: "listSpecs"` 與 `method: "listFlows"`，並捕捉處理器例外轉換為 JSON-RPC 錯誤。
  - [ ] 若需要，為共用檔案掃描邏輯建立 util（例如 `apps/mcp-server/src/utils/file-lister.ts`），避免重複程式碼。

- [ ] 建立單元測試與整合測試 (AC: 1, 2, 3, 4)
  - [ ] 在 `apps/mcp-server/__tests__/handlers/list-specs.test.ts` 撰寫單元測試：成功案例、空結果案例（回傳 `[]`）、目錄不存在與權限錯誤。
  - [ ] 在 `apps/mcp-server/__tests__/handlers/list-flows.test.ts` 撰寫單元測試：預設列出全部、`prefix`/`filename`/`directory` 篩選、空結果、非法參數導致 `-32602`。
  - [ ] 在 `apps/mcp-server/__tests__/mcp-server.test.ts` 新增整合測試：模擬 JSON-RPC 請求並驗證成功與錯誤回應格式、`result` 陣列內容以及 `id` 對應。
  - [ ] 驗證 StructuredLogger：透過注入測試 logger 或覆寫傳輸層收集事件，確認 `event`、`method`、`details` 欄位完整且在錯誤時包含 `error.code`、`error.message`。
  - [ ] 使用 Vitest 與 `packages/testing/fixtures/` 內的測試資料，必要時建立臨時目錄/檔案並於測試後清理。

## Dev Notes

### 前一故事的重要情資

來源：`docs/stories/3.1.story.md`（Dev Agent Record）

- Story 3.1 已完成 MCP 服務啟動、JSON-RPC 2.0 請求驗證與 StructuredLogger 整合，可直接使用其啟動流程與錯誤轉換機制。
- `apps/mcp-server/src/bootstrap.ts` 與 `apps/mcp-server/src/rpc-handler.ts` 已提供路由與回應建構工具，實作本故事時應沿用既有模式避免重工。

### 系統架構與檔案配置

來源：`docs/architecture/index.md`（章節：原始碼結構、系統元件）、`docs/architecture/原始碼結構.md`

- MCP 伺服器位於 `apps/mcp-server/`，方法處理器存放於 `src/handlers/`，共用工具可置於 `src/utils/`。
- 測試檔案建議放在 `apps/mcp-server/__tests__/handlers/` 與現有整合測試檔案同層，便於維護。
- 專案現有設定與 logger 組態位於 `packages/config/` 與 `packages/shared/`，可依需求引用。

### 目錄與參數限制

來源：`docs/architecture/程式撰寫規範.md`、`docs/architecture/錯誤處理策略.md`

- 僅允許存取專案內的 `specs/`、`flows/` 及其子目錄；需透過 `path.resolve` 與根路徑比對確保無路徑遍歷。
- 拒絕帶有 `..`、絕對路徑或非字母數字/底線/連字號的參數值，並以 `-32602` 回應。
- 錯誤訊息應使用相對路徑（例如 `flows/custom/`），避免洩漏系統完整路徑。

### 日誌策略

來源：`docs/architecture/logging.md`

- 結構化日誌需包含 `executionId`、`component`（固定 `"mcp-server"`）、`event`、`method`、`details`。
- `details` 建議放置 `directory`、`prefix`、結果數量、錯誤碼等資訊，協助排錯。
- 發生錯誤時記錄 stack trace 至 `data` 或 logger 內部欄位，但 JSON-RPC `error.message` 應保持對使用者友善。

### 錯誤處理策略

來源：`docs/architecture/錯誤處理策略.md`

- 針對檔案系統錯誤（`ENOENT`、`EACCES` 等）需轉換為 `-32603`，並在 `data` 附帶簡短代碼（例如 `ENOENT`）。
- 參數驗證失敗（非法 `directory`、`prefix`、`filename`）需回傳 `-32602` 且訊息點出問題欄位。
- 任何未捕捉例外需由路由層統一轉換，以避免洩漏 stack trace 至回應。

## Testing

### 測試檔案位置

- 單元測試：
  - `apps/mcp-server/__tests__/handlers/list-specs.test.ts`
  - `apps/mcp-server/__tests__/handlers/list-flows.test.ts`
- 整合測試：
  - `apps/mcp-server/__tests__/mcp-server.test.ts`
- 測試 fixtures：
  - `packages/testing/fixtures/specs/`
  - `packages/testing/fixtures/flows/`

### 測試標準

來源：`docs/architecture/測試策略.md`

- 使用 Vitest 1.6.0，遵循 AAA（Arrange、Act、Assert）模式。
- 單元測試覆蓋率需維持在 85% 以上，整合測試需覆蓋成功與錯誤流程。
- 測試中若需建立臨時檔案或目錄，請於 `afterEach`/`afterAll` 清理，避免影響其他測試。

### 本故事測試要求

- 驗證 `listSpecs`：成功列出檔案、空結果、目錄不存在/權限錯誤（`-32603`）。
- 驗證 `listFlows`：
  - 預設列出所有 `.yaml` 檔案。
  - `prefix`、`filename`、`directory` 篩選成功與空結果案例。
  - 非法 `directory` 或 `prefix` 觸發 `-32602`。
- JSON-RPC 整合測試：確認 `result` 為陣列、`id` 對應、錯誤回應使用正確錯誤碼與訊息。
- 日誌驗證：在測試中注入可攔截的 logger，檢查 `event`、`method`、`details` 欄位與錯誤碼/訊息。

## Change Log

| Date       | Version | Description                                                  | Author             |
| ---------- | ------- | ------------------------------------------------------------ | ------------------ |
| 2025-09-28 | v0.1    | 初次建立                                                    | Bob (Scrum Master) |
| 2025-09-28 | v0.2    | 釐清空結果行為、補齊參數限制與日誌/測試指引                  | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used

（待開發者填寫）

### Debug Log References

（待開發者填寫）

### Completion Notes

（待開發者填寫）

### File List

（待開發者填寫）

## QA Results

（待 QA 填寫）
