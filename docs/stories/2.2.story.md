# Story 2.2: 實作回應驗證與自訂規則

## Status

Draft

## Story

**As a** QA,
**I want** 驗證回應的狀態碼、Schema 與自訂條件,
**so that** 測試能準確捕捉異常。

## Acceptance Criteria

1. 驗證 `expect.status`，不符時回報錯誤。
2. 若設置 `expect.schema`，使用 `ajv` 對應 OpenAPI `components.schemas` 驗證。
3. 支援 `custom.notNull`, `custom.regex`, `custom.contains` 等規則，並提供擴充介面。
4. 驗證結果需寫入 LOG，含成功與失敗細節。

## Tasks / Subtasks

- [ ] 建立 validation 套件與依賴 (AC: 1-4)
  - [ ] 建立 `packages/validation/package.json`，設定 `name: "@specpilot/validation"`, `type: "module"`, `main: "dist/index.cjs"`, `types: "dist/index.d.ts"`
  - [ ] 新增依賴：`ajv@8.12.0`, `@specpilot/shared`, `@specpilot/config`; 開發依賴：`vitest`, `@vitest/coverage-v8`, `tsup`, `tsx`
  - [ ] 更新 `pnpm-workspace.yaml` 納入 `packages/validation`，並設定 scripts 透過 tsup/vitest 執行
  - [ ] 建立 `packages/validation/tsconfig.json` 與 `packages/validation/tsup.config.ts`，輸出 ESM/CJS 與型別 (`src/index.ts` → `dist/index.{js,cjs,d.ts}`)
  - [ ] 建立 `packages/validation/src/index.ts` 匯出驗證引擎公開 API，確保 `package.json` 指定入口可正確編譯

- [ ] 實作狀態碼驗證功能 (AC: 1)
  - [ ] 建立 `StatusValidator` 類別驗證 HTTP 狀態碼
  - [ ] 支援單一狀態碼與範圍驗證（如 2xx, 3xx）
  - [ ] 提供詳細的錯誤訊息包含期望值與實際值
  - [ ] 整合 StructuredLogger 記錄驗證結果

- [ ] 建立 Schema 驗證引擎 (AC: 2)
  - [ ] 實作 `SchemaValidator` 類別包裝 ajv 實例
  - [ ] 支援從 OpenAPI `components.schemas` 載入 Schema 定義
  - [ ] 實作 Schema 快取機制提高驗證效能
  - [ ] 處理 ajv 驗證錯誤並轉換為結構化錯誤訊息
  - [ ] 支援巢狀 Schema 與複雜物件驗證

- [ ] 實作自訂驗證規則系統 (AC: 3)
  - [ ] 建立 `CustomValidator` 類別管理自訂驗證規則
  - [ ] 實作 `notNull` 規則驗證欄位非空值
  - [ ] 實作 `regex` 規則支援正規表達式比對
  - [ ] 實作 `contains` 規則檢查字串包含指定內容
  - [ ] 設計可擴充的驗證規則註冊機制，提供 `registerRule(name: string, handler: CustomRuleHandler)` 與 `listRules()` API
  - [ ] 定義 `CustomRuleHandler` 介面（`(input: CustomRuleContext) => CustomRuleResult`），包含欄位路徑、期望值、回應實際值與 logger
  - [ ] 整合 ajv 自訂關鍵字擴充驗證能力，確保 AJV 內建錯誤訊息可轉換為 `ValidationIssue`

- [ ] 建立驗證協調器與結果處理 (AC: 4)
  - [ ] 實作 `ValidationEngine` 主類別協調所有驗證器，提供 `validateResponse(input: ValidationInput): ValidationOutcome` 入口
  - [ ] 定義 `ValidationInput`（含 `step: FlowStep`, `response: HttpResponse`, `expectations: FlowExpectations`, `schemas: Record<string, JsonSchema>`, `logger: StructuredLogger`, `executionId`, `runContext`）與 `ValidationOutcome`（`status: 'success'|'partial'|'failed'`, `issues: ValidationIssue[]`, `stepResultPatch: Partial<StepResult>`, `logs: ValidationLogEntry[]`）
  - [ ] 明確描述 `ValidationOutcome` 與 `StepResult.customChecks`、報表欄位的對應與錯誤分類（可恢復 vs. 不可恢復）
  - [ ] 實作驗證結果的詳細日誌記錄，記錄欄位：`executionId`, `component: 'validation-engine'`, `stepName`, `validator`, `rule`, `status`, `details`, `durationMs`
  - [ ] 支援批次驗證與錯誤收集（單步驟同時納入 status/schema/custom）
  - [ ] 整合錯誤處理策略與分類，失敗時轉換為 `ValidationError` 並附帶 `expectationKey`

- [ ] 建立完整測試套件 (AC: 1-4)
  - [ ] 建立 `packages/validation/__tests__/status-validator.test.ts`
  - [ ] 建立 `packages/validation/__tests__/schema-validator.test.ts`
  - [ ] 建立 `packages/validation/__tests__/custom-validator.test.ts`
  - [ ] 建立 `packages/validation/__tests__/validation-engine.test.ts`
  - [ ] 使用測試資料 fixtures 覆蓋各種驗證場景
  - [ ] 測試錯誤處理與日誌記錄功能

- [ ] 整合設定管理與類型定義 (AC: 4)
  - [ ] 整合 `@specpilot/config` 載入驗證相關設定
  - [ ] 定義完整的 TypeScript 型別系統
  - [ ] 建立驗證設定的 Schema 與預設值
  - [ ] 實作驗證器工廠模式支援依賴注入

## Dev Notes

### Previous Story Insights

- Story 2.1 (`docs/stories/2.1.story.md`) 已完成 HTTP Runner，可沿用 HTTP 回應物件結構與日誌模式
- Story 1.2 (`docs/stories/1.2.story.md`) 提供 OpenAPI 規格載入，Schema 驗證須整合其解析結果
- Story 1.1 (`docs/stories/1.1.story.md`) 建立 `@specpilot/config` 與 StructuredLogger，驗證結果需使用相同日誌格式

### Technology Stack Requirements

[Source: docs/architecture/技術堆疊.md]

- **Schema Validator**: ajv 8.12.0 - JSON Schema 驗證，效能佳、可擴充
- **Custom Rules**: AJV custom keywords - 實作 notNull/regex，與核心驗證整合
- **Logger**: pino 9.0.0 - 結構化 LOG，JSON Lines 格式
- **Language**: TypeScript 5.4.5 - 強型別支援
- **Config**: node-config / dotenv-flow - 多環境設定

### Data Models

[Source: docs/architecture/資料模型.md]

**FlowStep** - 流程中的單一步驟：
- 屬性：`name`, `request`, `expectations`, `retryPolicy`
- 關聯：多對一 `FlowDefinition`、一對多 `StepResult`

**StepResult** - 步驟執行結果：
- 屬性：`stepName`, `statusCode`, `success`, `timestamp`, `customChecks`
- 關聯：多對一 `RunContext`

### Component Specifications

[Source: docs/architecture/系統元件.md]

**Validation Engine (`packages/validation`)** - AJV 驗證與自訂規則：
- 負責狀態碼、Schema 與自訂條件驗證
- 整合 ajv 進行 JSON Schema 驗證
- 提供可擴充的自訂驗證規則系統
- 記錄詳細的驗證結果與錯誤訊息

### Validation Engine Contracts

- `validateResponse(input: ValidationInput): ValidationOutcome` 為唯一公開入口：
  - `ValidationInput` 包含 `step` (FlowStep)、`response` (HTTP Runner 回傳的 `HttpResponse`)、`expectations` (`FlowExpectations`)、`schemas` (由 Spec Loader 提供的 `Record<string, JsonSchema>`)、`logger` (StructuredLogger 實例)、`executionId` 與 `runContext`。
  - `ValidationOutcome` 需提供 `status`, `issues`, `logs`, `stepResultPatch`，其中 `issues` 依 `category: 'status'|'schema'|'custom'` 與 `severity: 'error'|'warning'` 分類，`stepResultPatch` 用來更新 `StepResult.customChecks` 與 `success` 狀態。
- 各驗證器需實作介面 `Validator`：`validate(ctx: ValidationContext): ValidatorResult`，並由 ValidationEngine 統一調用。`ValidatorResult` 至少包含 `isValid`, `issues`, `telemetry`。
- 驗證結果必須透過 StructuredLogger 撰寫 `VALIDATION_START`, `VALIDATION_SUCCESS`, `VALIDATION_FAILURE` 事件，欄位固定為 `executionId`, `component: 'validation-engine'`, `stepName`, `validator`, `rule`, `status`, `message`, `durationMs`。
- Schema 資料來源：透過 `@specpilot/spec-loader` 已快取之 `OpenApiSchemaRegistry`，若 schema 缺失需回傳 `ValidationIssue` 並記錄 `severity: 'error'`。
- 自訂規則執行時需傳入 `CustomRuleContext`（包含 `payload`, `ruleName`, `ruleOptions`, `schemas`），並允許異步處理。任何例外必須捕捉轉為 `ValidationIssue`。

### Expect 範例

```yaml
expect:
  status: [200, 201]
  schema: UserResponse
  custom:
    - rule: notNull
      path: $.data.id
    - rule: regex
      path: $.data.email
      options:
        pattern: "^[\w.-]+@example\.com$"
    - rule: contains
      path: $.data.roles
      options:
        value: "admin"
```

### File Locations

[Source: docs/architecture/原始碼結構.md]

- Validation Engine 主要實作：`packages/validation/src/index.ts`
- Status Validator：`packages/validation/src/status-validator.ts`
- Schema Validator：`packages/validation/src/schema-validator.ts`
- Custom Validator：`packages/validation/src/custom-validator.ts`
- Validation Engine：`packages/validation/src/validation-engine.ts`
- 測試檔案：`packages/validation/__tests__/`
- 套件配置：`packages/validation/package.json`

### Technical Constraints

[Source: docs/architecture/程式撰寫規範.md]

- 禁用 `console.log/error`，統一使用 StructuredLogger
- 匯出函式需明確型別註解
- 自訂驗證須透過 AJV 自訂 keywords
- 檔案命名使用 kebab-case、類別使用 PascalCase、函式使用 camelCase
- 事件代碼使用 UPPER_SNAKE_CASE

### Error Handling Requirements

[Source: docs/architecture/錯誤處理策略.md]

- **錯誤分類**: 分為可恢復（驗證失敗）與不可恢復（設定缺失等）
- **例外階層**: `BaseError` → `ValidationError`
- **日誌標準**: 使用 pino，JSON Lines 格式，強制帶 `executionId`、`component` 等欄位
- **敏感資訊**: 回應內容中的敏感欄位需遮罩為 '***'
- **驗證結果**: 所有驗證活動都需記錄，包含成功與失敗細節

### Testing Requirements

[Source: docs/architecture/測試策略.md]

- **Test Framework**: Vitest 1.6.0 with `@vitest/coverage-v8`
- **Unit Tests**: `packages/validation/__tests__/*.test.ts`
- **Coverage Target**: ≥ 85% for critical modules like Validation Engine
- **Mock Strategy**: 使用測試 fixtures 提供各種驗證場景
- **Test Pattern**: 遵守 AAA（Arrange, Act, Assert）模式
- **Test Categories**:
  - 狀態碼驗證（單一碼、範圍、錯誤處理）
  - Schema 驗證（有效/無效 Schema、複雜物件）
  - 自訂規則驗證（notNull、regex、contains）
  - 驗證引擎整合（批次驗證、錯誤收集）
  - 日誌記錄與錯誤處理

### Integration Points

- **依賴套件**: `@specpilot/shared`, `@specpilot/config`, `ajv`
- **設定鍵值**: `validation.strict`, `validation.allErrors`, `validation.verbose`
- **日誌事件**: `VALIDATION_START`, `VALIDATION_SUCCESS`, `VALIDATION_FAILURE`, `SCHEMA_LOADED`, `CUSTOM_RULE_APPLIED`
- **Schema 來源**: OpenAPI `components.schemas` from `@specpilot/spec-loader`
- **驗證輸入**: HTTP 回應物件 from `@specpilot/http-runner`

## Testing

### Test File Locations

[Source: docs/architecture/測試策略.md]

- 單元測試：`packages/validation/__tests__/*.test.ts`
- 測試資料：`packages/testing/fixtures` 儲存樣本驗證資料

### Testing Standards

- 使用 Vitest 1.6.0 測試框架
- 目標覆蓋率 ≥ 85%（關鍵模組）
- 遵守 AAA（Arrange, Act, Assert）模式
- 使用 factory 函式提供測試資料
- 測試後清理暫時資料

### Testing Requirements for This Story

- 測試所有驗證器類別的功能
- 驗證 ajv 整合與自訂關鍵字
- 測試錯誤處理與日誌記錄
- 覆蓋各種驗證場景與邊界情況
- 驗證型別定義的正確性
- 驗證 `ValidationOutcome` 與 `StepResult`/LOG 映射是否符合規範

## Change Log

| Date       | Version | Description | Author             |
| ---------- | ------- | ----------- | ------------------ |
| 2025-09-27 | v0.1    | 初稿建立    | Bob (Scrum Master) |

## Dev Agent Record

_此區由開發代理於實作時填寫_

## QA Results

_此區由 QA 代理於驗收後填寫_