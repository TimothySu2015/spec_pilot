# Story 2.1: 建立 HTTP 執行器與 Token 注入

## Status

Draft

## Story

**As a** 測試工程師,
**I want** 執行 YAML 步驟定義的 HTTP 呼叫,
**so that** 能模擬 API 使用情境。

## Acceptance Criteria

1. 使用 `axios` 送出 GET/POST/PUT/PATCH/DELETE 請求。
2. 自動拼接 baseUrl 與 path，並支援變數替換。
3. 支援在流程中儲存與注入 JWT（登入或設定檔來源），於 `Authorization: Bearer <JWT>` header 中使用。
4. 提供預設逾時或重試設定，可透過設定檔覆寫。

## Tasks / Subtasks

- [ ] 建立 http-runner 套件與依賴 (AC: 1-4)
  - [ ] 建立 `packages/http-runner/package.json`，設定 `name: "@specpilot/http-runner"`, `type: "module"`, `main: "dist/index.cjs"`, `types: "dist/index.d.ts"`, 並設定 `exports` 為 ESM/CJS。
  - [ ] 新增依賴：`axios@1.6.8`, `@specpilot/config`, `@specpilot/shared`; 開發依賴：`nock@13.4.0`, `vitest`, `@vitest/coverage-v8`, `tsup`, `tsx`.
  - [ ] 更新 `pnpm-workspace.yaml` 納入 `packages/http-runner`，並設定 `build`, `clean`, `test` scripts 透過 tsup/vitest 執行。

- [ ] 建立 HTTP Runner 核心架構 (AC: 1, 4)
  - [ ] 實作 `HttpClient` 類別包裝 axios 實例，支援所有 HTTP 方法
  - [ ] 設計 `HttpRequest` 與 `HttpResponse` 型別定義
  - [ ] 實作預設逾時與重試機制的配置
  - [ ] 整合 `@specpilot/config` 套件載入逾時與重試設定

- [ ] 實作 URL 拼接與變數替換功能 (AC: 2)
  - [ ] 建立 `UrlBuilder` 工具類別自動拼接 baseUrl 與 path
  - [ ] 實作變數替換機制支援路徑參數與查詢參數
  - [ ] 加入 URL 驗證與格式化功能
  - [ ] 處理特殊字元編碼與 URL escape

- [ ] 實作 JWT Token 管理與注入 (AC: 3)
  - [ ] 建立 `TokenManager` 類別管理 JWT 儲存與檢索
  - [ ] 實作從設定檔載入靜態 Token 功能
  - [ ] 實作從流程步驟中動態提取與儲存 JWT
  - [ ] 自動注入 `Authorization: Bearer <JWT>` header
  - [ ] 支援多服務/命名空間的 Token 隔離

- [ ] 實作錯誤處理與重試機制 (AC: 4)
  - [ ] 實作指數退避重試策略（500ms, 1s, 2s）
  - [ ] 處理 HTTP 錯誤狀態碼與網路錯誤
  - [ ] 實作簡易斷路器機制防止連續失敗
  - [ ] 整合 StructuredLogger 記錄請求/回應摘要
  - [ ] 支援 `Retry-After` header 尊重伺服器指示

- [ ] 建立單元測試套件 (AC: 1-4)
  - [ ] 建立 `packages/http-runner/__tests__/http-client.test.ts`
  - [ ] 使用 nock 模擬 HTTP 請求回應
  - [ ] 測試所有 HTTP 方法與錯誤處理
  - [ ] 測試 Token 注入與管理功能
  - [ ] 測試重試機制與斷路器行為
  - [ ] 測試變數替換與 URL 拼接功能

- [ ] 整合設定管理與日誌系統 (AC: 4)
  - [ ] 整合 `@specpilot/config` 載入 HTTP 相關設定
  - [ ] 整合 `@specpilot/shared` StructuredLogger
  - [ ] 實作請求/回應摘要日誌記錄
  - [ ] 記錄重試與 fallback 事件
  - [ ] 確保敏感資訊（Token）在日誌中遮罩

## Dev Notes

### Previous Story Insights

- Story 1.1 (`docs/stories/1.1.story.md`) 建立 `@specpilot/config` 套件與 StructuredLogger，可沿用設定載入與日誌模式。
- Story 1.2 (`docs/stories/1.2.story.md`) 提供 `@specpilot/spec-loader` 與共用錯誤基底。
- Story 1.3 (`docs/stories/1.3.story.md`) 完成 `@specpilot/flow-parser`，定義流程步驟與 retryPolicy 等欄位。
- Story 1.4 (`docs/stories/1.4.story.md`) 建立 CLI 與流程協調器整合範例，HTTP Runner 須維持相同執行/日誌規範。

### Technology Stack Requirements

[Source: docs/architecture/技術堆疊.md]

- **HTTP Client**: axios 1.6.8 - 發送 API 請求，攔截器支援 Token/重試
- **Test HTTP Mock**: nock 13.4.0 - 模擬外部 API
- **Logger**: pino 9.0.0 - 結構化 LOG
- **Language**: TypeScript 5.4.5
- **Config**: node-config / dotenv-flow

### Data Models

[Source: docs/architecture/資料模型.md]

**RunContext** - 單次流程執行環境：
- 屬性：`executionId`, `spec`, `flow`, `auth`, `variables`
- 關聯：一對多 `StepResult`、一對一 `ExecutionReport`

**FlowStep** - 流程中的單一步驟：
- 屬性：`name`, `request`, `expectations`, `retryPolicy`
- 關聯：多對一 `FlowDefinition`、一對多 `StepResult`

### Component Specifications

[Source: docs/architecture/系統元件.md]

**HTTP Execution Engine (`packages/http-runner`)** - 包裝 axios 處理請求、重試、timeout：
- 負責執行 HTTP 請求並處理重試邏輯
- 提供 Token 管理與自動注入功能
- 整合設定管理載入逾時與重試參數
- 記錄結構化日誌供監控與除錯

### File Locations

[Source: docs/architecture/原始碼結構.md]

- HTTP Runner 主要實作：`packages/http-runner/src/index.ts`
- HTTP Client 實作：`packages/http-runner/src/http-client.ts`
- Token Manager：`packages/http-runner/src/token-manager.ts`
- URL Builder：`packages/http-runner/src/url-builder.ts`
- 測試檔案：`packages/http-runner/__tests__/`
- 套件配置：`packages/http-runner/package.json`

### Technical Constraints

[Source: docs/architecture/程式撰寫規範.md]

- 禁用 `console.log/error`，統一使用 StructuredLogger
- 匯出函式需明確型別註解
- 檔案命名使用 kebab-case、類別使用 PascalCase、函式使用 camelCase
- 事件代碼使用 UPPER_SNAKE_CASE
- 檔案寫入需採非同步 + 臨時檔 rename 流程

### Error Handling Requirements

[Source: docs/architecture/錯誤處理策略.md]

- **重試策略**: exponential backoff（500ms, 1s, 2s）、最多 3 次、尊重 `Retry-After`
- **斷路器**: 連續 5 次失敗停止流程
- **錯誤分類**: 分為可恢復（HTTP/驗證失敗）與不可恢復（設定缺失等）
- **日誌標準**: 使用 pino，JSON Lines 格式，強制帶 `executionId`、`component` 等欄位
- **敏感資訊**: Token、auth header 等欄位需遮罩為 '***'
- **Fallback 機制**: 支援在 HTTP 重試超過上限後改用 fallback 定義

### Testing Requirements

[Source: docs/architecture/測試策略.md]

- **Test Framework**: Vitest 1.6.0 with `@vitest/coverage-v8`
- **Unit Tests**: `packages/http-runner/__tests__/http-client.test.ts`
- **Coverage Target**: ≥ 85% for critical modules like HTTP Runner
- **Mock Strategy**: 使用 nock 模擬 HTTP 請求，測試重試與錯誤處理
- **Test Pattern**: 遵守 AAA（Arrange, Act, Assert）模式
- **Test Categories**:
  - HTTP 方法執行與回應處理
  - Token 注入與管理功能
  - 重試機制與斷路器行為
  - 變數替換與 URL 拼接
  - 錯誤處理與日誌記錄

### Integration Points

- **依賴套件**: `@specpilot/config`, `@specpilot/shared`, `axios`
- **設定鍵值**: `http.timeout`, `http.retries`, `http.circuitBreaker`
- **日誌事件**: `HTTP_REQUEST_START`, `HTTP_REQUEST_SUCCESS`, `HTTP_REQUEST_FAILURE`, `TOKEN_INJECTED`, `RETRY_ATTEMPT`, `CIRCUIT_BREAKER_OPEN`
- **Token 來源**: 設定檔靜態 Token、流程步驟動態提取
- **變數替換**: 支援路徑參數 `{param}` 與查詢參數變數

## Change Log

| Date       | Version | Description | Author             |
| ---------- | ------- | ----------- | ------------------ |
| 2025-09-26 | v0.1    | 初稿建立    | Bob (Scrum Master) |
| 2025-09-26 | v0.2    | 補充套件依賴、清空 Dev Agent Record | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
*待填寫*

### Debug Log References
*待填寫*

### Completion Notes
*待填寫*

### File List
*待填寫*

## QA Results

*此區由 QA 代理於驗收後填寫*
