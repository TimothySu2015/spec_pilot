# Story 1.3: 實作 Flow YAML 解析與基本驗證

## Status

Done

## Story

**As a** 測試工程師,
**I want** 解析 `flow.yaml` 並驗證基本欄位,
**so that** 測試腳本可轉為程式可用結構。

## Acceptance Criteria

1. 支援載入本地檔案與 AI 傳入的 `flowContent`。
2. 解析後包含步驟名稱、HTTP 方法、路徑、期望驗證設定。
3. 缺少必要欄位時丟出明確錯誤並記錄 LOG。
4. 解析結果具 TypeScript 型別定義。

## Tasks / Subtasks

- [x] 建立 flow-parser 套件結構 (AC: 1-4)
  - [x] 建立 `packages/flow-parser/package.json`，設定 name: "@specpilot/flow-parser"、type: "module"、主要匯出與建置腳本
  - [x] 將 `yaml@2.4.3` 註冊為 dependencies，`zod@3.23` 與測試相關套件作為 devDependencies
  - [x] 確保 `@specpilot/shared` 的錯誤基底類別可供 FlowParseError/FlowValidationError 繼承

- [x] 設計 FlowDefinition 資料模型 (AC: 2, 4)
  - [x] 建立 `packages/flow-parser/src/types.ts`，定義 `IFlowDefinition` 介面，包含 `id`, `rawContent`, `steps`, `globals` 屬性
  - [x] 定義 `IFlowStep` 介面，包含 `name`, `request`, `expectations`, `retryPolicy` 屬性
  - [x] 定義 `IFlowLoadOptions` 介面，支援檔案路徑或直接內容輸入（含 `format?: 'yaml'`）
  - [x] 建立完整的 TypeScript 型別定義，包含 HTTP 方法、驗證設定等枚舉類型

- [x] 建立 Flow 專用錯誤類別 (AC: 3)
  - [x] 建立 `packages/flow-parser/src/errors.ts`，定義 `FlowParseError`, `FlowValidationError` 等錯誤類型
  - [x] 錯誤類別需繼承自 `@specpilot/shared` 的 BaseError，並包含 `details`, `hint` 欄位
  - [x] 提供明確的錯誤訊息模板，便於問題診斷

- [x] 實作 Flow YAML 檔案載入邏輯 (AC: 1, 2)
  - [x] 建立 `loadFlowFromFile(filePath: string)` 函式，支援 `.yaml`, `.yml` 副檔名
  - [x] 建立 `loadFlowFromContent(content: string, executionId?: string)` 函式處理 AI 傳入內容
  - [x] 使用 `yaml.parse()` 解析 YAML 檔案，錯誤時拋出 `FlowParseError`
  - [x] 加入完整的錯誤處理：檔案不存在、格式錯誤、內容為空等情況

- [x] 實作基本欄位驗證機制 (AC: 3, 4)
  - [x] 建立 `validateFlowStructure(flowData: unknown)` 函式驗證必要欄位
  - [x] 驗證每個步驟包含必要的 `name`, `request.method`, `request.path` 欄位
  - [x] 驗證 HTTP 方法為有效值 (GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS)
  - [x] 驗證期望設定格式 (`expect.status`, `expect.schema`, `custom` 規則等)
  - [x] 缺少必要欄位時拋出 `FlowValidationError` 並提供具體指導

- [x] 實作結構化日誌記錄 (AC: 3)
  - [x] 整合 `@specpilot/shared` 的 StructuredLogger，component 使用 `flow-parser`
  - [x] 記錄流程載入開始事件：`FLOW_LOAD_START`，包含檔案路徑或內容長度
  - [x] 記錄成功事件：`FLOW_LOAD_SUCCESS`，包含步驟數量、全域設定
  - [x] 記錄失敗事件：`FLOW_LOAD_FAILURE`，包含錯誤類型與詳細訊息
  - [x] 確保敏感資訊（如 token, auth header）在日誌中被適當遮罩

- [x] 建立主要匯出介面 (AC: 1-4)
  - [x] 在 `packages/flow-parser/src/index.ts` 匯出主要函式：`loadFlow()`, `loadFlowSafe()`
  - [x] `loadFlow()` 根據參數自動判斷輸入類型，鏈結載入與驗證流程
  - [x] `loadFlowSafe()` 包裝版本回傳結果物件而不拋出錯誤
  - [x] 統一錯誤處理並確保 `executionId` 正確傳遞

- [x] 撰寫單元測試與測試資料 (AC: 1-4)
  - [x] 於 `packages/testing/fixtures/flows/` 建立測試用範本：`user_crud.yaml`, `minimal_flow.yaml`, `invalid_flow.yaml`
  - [x] 建立 `packages/flow-parser/__tests__/flow-parser.test.ts`，測試正確載入 YAML 流程、內容載入、欄位驗證與錯誤處理
  - [x] 為錯誤情境撰寫測試案例：檔案不存在、格式錯誤、缺少必要欄位
  - [x] 使用 `vi.mock` 模擬檔案存取與 logger，驗證事件日誌正確記錄
  - [x] 確保測試覆蓋率達到 85%（關鍵模組標準）

## Dev Notes

### Previous Story Insights

- Story 1.1 (`docs/stories/1.1.story.md`) 已建立 StructuredLogger 與測試基礎設施，可直接套用至 Flow Parser。
- Story 1.2 (`docs/stories/1.2.story.md`) 已定義 `@specpilot/spec-loader` 套件與共用錯誤基底 `packages/shared/src/errors/base-error.ts`，本故事的 Flow 錯誤類型需沿用。
- Stories 1.1 與 1.2 任務中皆確認 `yaml@2.4.3` 為解析器、Vitest 為測試框架，本故事可以沿用相同依賴與覆蓋率標準。

### Technology Stack Requirements

[Source: docs/architecture/技術堆疊.md]

- **YAML Parser**: yaml 2.4.3 - Flow/OpenAPI 解析，AST 能力充足
- **Schema Validator**: 目前使用 zod 3.23 作為 TypeScript-first schema 驗證
- **Logger**: pino 9.0.0 - 結構化 LOG，JSON Lines、效能良好
- **Language**: TypeScript 5.4.5 - 主力開發語言，強型別支援

### Data Models

[Source: docs/architecture/資料模型.md]

**FlowDefinition** – 表示一份 flow.yaml：

- 屬性：`id`, `rawContent`, `steps`, `globals`
- 關聯：多對一 `SpecDocument`、一對多 `FlowStep`

**FlowStep** – 流程中的單一步驟：

- 屬性：`name`, `request`, `expectations`, `retryPolicy`
- 關聯：多對一 `FlowDefinition`、一對多 `StepResult`

### Component Specifications

[Source: docs/architecture/系統元件.md]

**Flow Parser (`packages/flow-parser`)** – 解析 flow.yaml 並產生 `FlowDefinition`：

- 負責載入並驗證 YAML 流程定義檔案
- 支援檔案路徑和直接內容輸入
- 提供基本欄位驗證和錯誤處理
- 輸出標準化的 FlowDefinition 格式

### File Locations

[Source: docs/architecture/原始碼結構.md]

- 主要實作：`packages/flow-parser/src/index.ts`
- 型別定義：`packages/flow-parser/src/types.ts`
- 錯誤類別：`packages/flow-parser/src/errors.ts`
- 單元測試：`packages/flow-parser/__tests__/flow-parser.test.ts`
- 測試檔案：`packages/testing/fixtures/flows/*.yaml`
- 套件配置：`packages/flow-parser/package.json`

### Technical Constraints

[Source: docs/architecture/程式撰寫規範.md]

- 禁用 `console.log/error`，統一使用 StructuredLogger
- 匯出函式需明確型別註解
- 檔案命名使用 kebab-case、類別使用 PascalCase、函式使用 camelCase
- 事件代碼使用 UPPER_SNAKE_CASE
- 介面命名需使用 I 前綴 (如 IFlowDefinition)

### Error Handling Requirements

[Source: docs/architecture/錯誤處理策略.md]

- LOG 需區分 `component`（如 `flow-parser`）與共用 `executionId`
- 錯誤記錄時需同時輸出至檔案與主控台
- 自訂錯誤需附帶 `context`，方便 Orchestrator 判斷重試或中止
- 敏感資訊遮罩：token、auth header、密鑰類欄位需遮罩為 '\*\*\*'

### Testing

[Source: docs/architecture/測試策略.md]

- **Test Framework**: Vitest 1.6.0 with `@vitest/coverage-v8`
- **Test Location**: `packages/flow-parser/__tests__/flow-parser.test.ts`
- **Test Fixtures**: `packages/testing/fixtures/flows/` 儲存測試用 YAML 流程檔案
- **Coverage Target**: ≥ 85% for critical modules like `packages/flow-parser`
- **Mock Strategy**: 使用 `vi.mock` 模擬外部 I/O，避免實際檔案操作
- **Test Pattern**: 遵守 AAA（Arrange, Act, Assert）模式
- **Test Categories**:
  - 成功載入有效的 YAML 流程檔案
  - 錯誤處理：無效檔案、格式錯誤、缺少必要欄位
  - 驗證 `loadFlow()` 針對檔案輸入與內容輸入皆能回傳完整 `IFlowDefinition`
  - 驗證日誌事件正確記錄

## Change Log

| Date       | Version | Description | Author             |
| ---------- | ------- | ----------- | ------------------ |
| 2025-09-26 | v0.1    | 初稿建立    | Bob (Scrum Master) |

## Dev Agent Record

_此區由開發代理於實作時填寫_

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

無特殊調試問題

### Completion Notes List

- 成功建立完整的 Flow Parser 模組，包含所有必要的類型定義、錯誤處理和驗證邏輯
- 實作了強型別的 TypeScript 介面，避免使用 `any` 以符合 ESLint 規範
- 測試覆蓋率達到 88.19%，超過 85% 的目標要求
- 所有單元測試通過，包括正常流程、錯誤處理和日誌記錄的測試
- ESLint 檢查通過，程式碼品質符合專案規範

### File List

#### 新建檔案

- `packages/flow-parser/src/types.ts` - 完整的 Flow 相關型別定義
- `packages/flow-parser/src/errors.ts` - Flow 專用錯誤類別
- `packages/flow-parser/src/loader.ts` - YAML 載入與驗證邏輯
- `packages/testing/fixtures/flows/user_crud.yaml` - 完整的測試流程範例
- `packages/testing/fixtures/flows/minimal_flow.yaml` - 最小化測試流程
- `packages/testing/fixtures/flows/invalid_flow.yaml` - 無效流程用於錯誤測試

#### 修改檔案

- `packages/flow-parser/package.json` - 更新依賴項目
- `packages/flow-parser/src/index.ts` - 重寫主要匯出介面
- `packages/flow-parser/__tests__/flow-parser.test.ts` - 完整的測試套件

## QA Results

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**整體品質評估: 優秀 (A級)**

Story 1.3 的實作品質達到專案標準，展現了優秀的軟體工程實踐：

- **架構設計**: 採用清晰的模組化架構，符合六角式架構原則
- **型別安全**: 完整的 TypeScript 型別定義，避免使用 `any` 類型
- **錯誤處理**: 統一的錯誤處理策略，提供明確的錯誤訊息和修復建議
- **測試覆蓋**: 88.19% 的測試覆蓋率，超過 85% 的目標要求
- **程式碼品質**: 通過 ESLint 檢查，符合專案編碼規範

### Refactoring Performed

**無需重構** - 程式碼品質已符合生產標準，無發現需要立即重構的問題。

### Compliance Check

- **Coding Standards**: ✓ 通過 ESLint 檢查，符合 TypeScript 最佳實踐
- **Project Structure**: ✓ 符合 Monorepo 結構和套件命名規範
- **Testing Strategy**: ✓ 測試覆蓋率 88.19%，超過 85% 的關鍵模組要求
- **All ACs Met**: ✓ 所有 4 個驗收條件均已完整實現

### Improvements Checklist

**所有項目已完成，無需額外改善:**

- [x] 完整的型別定義系統 (types.ts)
- [x] 統一的錯誤處理機制 (errors.ts)
- [x] 結構化日誌記錄 (loader.ts)
- [x] 全面的測試套件 (flow-parser.test.ts)
- [x] 完整的檔案載入與內容載入支援
- [x] 強健的 YAML 解析與驗證邏輯

### Security Review

✅ **安全性評估通過**

- **敏感資料遮罩**: 實作了 `maskSensitiveData` 方法保護認證憑證
- **輸入驗證**: 完整的 YAML 格式與結構驗證
- **錯誤資訊**: 錯誤訊息不洩露敏感系統資訊
- **日誌安全**: 日誌中敏感欄位已適當遮罩

### Performance Considerations

✅ **效能評估良好**

- **記憶體效率**: 適當的物件結構設計，避免過度複製
- **解析效率**: 使用高效能的 `yaml` 函式庫
- **錯誤處理**: 快速失敗機制，避免無效輸入的深度處理
- **日誌效能**: 結構化日誌避免字串拼接開銷

### Files Modified During Review

**審查期間無修改檔案** - 所有實作已符合品質標準

### Gate Status

Gate: **PASS** → docs/qa/gates/1.3-flow-yaml-parsing-and-basic-validation.yml

### Recommended Status

✅ **Ready for Done**

所有驗收條件已完成，程式碼品質達到生產標準，建議標示為完成狀態。

### Test Coverage Details

**Flow Parser 模組覆蓋率: 88.19%**

- errors.ts: 94.06% (優秀)
- index.ts: 98.88% (優秀)
- loader.ts: 77.63% (良好)
- types.ts: 100% (完美)

**測試場景完整性:**

- ✅ 正常流程測試 (有效 YAML 載入)
- ✅ 錯誤處理測試 (檔案不存在、格式錯誤、驗證失敗)
- ✅ 邊界條件測試 (空內容、無效方法、狀態碼)
- ✅ 日誌記錄測試 (成功/失敗事件記錄)

### Requirements Traceability

**Given-When-Then 映射:**

- **AC 1 (檔案與內容載入)**:
  - Given: 提供檔案路徑或直接內容
  - When: 呼叫 `loadFlow()` 函式
  - Then: 成功解析並返回 `IFlowDefinition`
  - **測試**: `flow-parser.test.ts:37-62, 64-90`

- **AC 2 (解析步驟資訊)**:
  - Given: 有效的 Flow YAML 內容
  - When: 執行解析流程
  - Then: 步驟包含 name、method、path、expectations
  - **測試**: `flow-parser.test.ts:264-310`

- **AC 3 (錯誤處理與日誌)**:
  - Given: 無效或缺少必要欄位的內容
  - When: 嘗試解析 Flow
  - Then: 拋出明確錯誤並記錄日誌
  - **測試**: `flow-parser.test.ts:92-261, 350-423`

- **AC 4 (TypeScript 型別)**:
  - Given: 解析完成的 Flow 資料
  - When: 在 TypeScript 環境中使用
  - Then: 提供完整型別檢查和 IDE 支援
  - **驗證**: 編譯時型別檢查通過
