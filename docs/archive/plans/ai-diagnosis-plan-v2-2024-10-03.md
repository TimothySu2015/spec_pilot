---
**狀態**: 已完成
**歸檔日期**: 2025-10-19
**備註**: v2 版本規劃已實作
---

# SpecPilot AI 診斷功能實作計劃 (更新版)

> **✅ 實作狀態**: 階段 1-5 已完成，自動診斷功能已整合 (2025-01-15)
>
> - ✅ 階段 1: 增強錯誤報表
> - ✅ 階段 2: 建立診斷上下文生成器
> - ✅ 階段 3: 整合診斷上下文到 MCP
> - ✅ 階段 4: 文件與範例
> - ✅ 階段 5: 測試與驗證 (17/17 單元測試通過)
> - ✨ **新增**: runFlow 自動產生診斷摘要 (2025-01-15)

## 📋 專案概述

### 目標
在 SpecPilot 中建立 AI 驅動的錯誤診斷功能,透過 Claude Desktop 分析 API 測試失敗原因並提供修復建議。

### 核心理念
- **一次執行，立即診斷** - runFlow 自動產生診斷上下文並顯示診斷摘要
- **透過 Claude Desktop 進行診斷** - 利用使用者的 Claude Pro 訂閱
- **API 錯誤訊息為核心** - 保留完整的錯誤回應內容 (包含 stack trace)
- **本機開發階段使用** - 不用於正式環境,安全性要求較低
- **診斷友善的錯誤格式** - 制定 API 開發規範,確保錯誤訊息結構化

### 預期效果
- 診斷成功率: **85-90%** (針對常見錯誤)
- 使用方式: 在 Claude Desktop 中透過 MCP 工具互動
- 適用場景: API 開發、測試、除錯階段
- **✨ 自動化診斷**: 執行測試時自動產生診斷摘要，無需額外操作

---

## 🔄 完整流程圖

### 整體架構流程 (更新版)

```
┌────────────────────────────────────────────────────────────────────────┐
│                          使用者 (開發者)                                │
└───────────────────────────┬────────────────────────────────────────────┘
                                │
                                ↓
┌────────────────────────────────────────────────────────────────────────┐
│                        Claude Desktop                                   │
│  ┌──────────────────────────────────────────────────────────────┐     │
│  │ User: 執行測試並診斷錯誤                                      │     │
│  │                                                               │     │
│  │ @mcp__specpilot__runFlow spec=api.yaml flow=test.yaml       │     │
│  │   ↓ (測試執行,部分失敗)                                      │     │
│  │   ↓ ✨ 自動產生診斷上下文並顯示診斷摘要                       │     │
│  │                                                               │     │
│  │ runFlow 回應包含:                                             │     │
│  │ - 📊 診斷摘要 (快速診斷)                                     │     │
│  │ - 💡 可能原因列表                                            │     │
│  │ - 🔧 建議修復動作                                            │     │
│  │                                                               │     │
│  │ Claude 立即分析診斷資訊:                                      │     │
│  │ - 讀取完整錯誤訊息 (包含 stack trace)                        │     │
│  │ - 理解錯誤分類 (auth/network/validation/server)             │     │
│  │ - 查看錯誤模式 (連續失敗、連鎖反應)                          │     │
│  │ - 參考診斷提示                                                │     │
│  │                                                               │     │
│  │ Claude 回應:                                                  │     │
│  │ ✅ 精確的問題診斷                                             │     │
│  │ ✅ 根本原因分析                                               │     │
│  │ ✅ 具體的修復步驟                                             │     │
│  │ ✅ 程式碼範例 (如需要)                                        │     │
│  │                                                               │     │
│  │ (可選) @mcp__specpilot__getReport                            │     │
│  │   ↓ (查看完整診斷報表，含所有技術細節)                       │     │
│  └──────────────────────────────────────────────────────────────┘     │
└───────────────────────────┬────────────────────────────────────────────┘
                                │ (MCP 協議)
                                ↓
┌────────────────────────────────────────────────────────────────────────┐
│                    SpecPilot MCP Server                                 │
│  ┌──────────────────────────────────────────────────────────────┐     │
│  │ handleRunFlow() ✨ 已優化                                     │     │
│  │   → 執行測試                                                  │     │
│  │   → 生成報表 (包含完整錯誤資訊)                              │     │
│  │   → ✨ 自動建立診斷上下文 (DiagnosticContextBuilder)        │     │
│  │   → ✨ 產生診斷摘要文字                                      │     │
│  │   → 回傳測試結果 + 診斷摘要                                  │     │
│  │   → 儲存到 reports/result.json                               │     │
│  └──────────────────────────────────────────────────────────────┘     │
│  ┌──────────────────────────────────────────────────────────────┐     │
│  │ handleGetReport() (可選，用於查看完整報表)                   │     │
│  │   → 載入報表                                                  │     │
│  │   → 建立診斷上下文 (如果報表中沒有)                          │     │
│  │   → 回傳報表 + 診斷上下文                                    │     │
│  └──────────────────────────────────────────────────────────────┘     │
└───────────────────────────┬────────────────────────────────────────────┘
                                │
                                ↓
┌────────────────────────────────────────────────────────────────────────┐
│                      測試報表生成流程                                   │
│                                                                         │
│  Step 1: HTTP 請求執行                                                 │
│  ┌─────────────────────────────────────────────────────┐              │
│  │ HTTP Runner 執行 API 請求                            │              │
│  │   → 成功: 取得回應                                   │              │
│  │   → 失敗: 取得錯誤回應 (含 stack trace)             │              │
│  └─────────────────────────────────────────────────────┘              │
│                                                                         │
│  Step 2: 報表生成 (ReportGenerator)                                    │
│  ┌─────────────────────────────────────────────────────┐              │
│  │ IF 測試失敗:                                         │              │
│  │   ✅ 保留完整錯誤 body                               │              │
│  │   ✅ 保留錯誤 headers                                │              │
│  │   ✅ 提取 stack trace                                │              │
│  │   ✅ 記錄回應時間                                    │              │
│  │   ⚠️  遮罩敏感資料 (password, token, etc.)          │              │
│  │                                                      │              │
│  │ IF 測試成功:                                         │              │
│  │   ✅ 只保留 hash (節省空間)                          │              │
│  └─────────────────────────────────────────────────────┘              │
│                                                                         │
│  Step 3: ✨ 診斷上下文建立 (在 runFlow 中自動執行)                    │
│  ┌─────────────────────────────────────────────────────┐              │
│  │ 1. 分析失敗步驟                                      │              │
│  │    → 錯誤分類 (auth/network/validation/server)      │              │
│  │    → 信心度評分 (0-100)                              │              │
│  │    → 判斷依據記錄                                    │              │
│  │                                                      │              │
│  │ 2. 偵測錯誤模式                                      │              │
│  │    → 連續認證失敗?                                   │              │
│  │    → 連鎖失敗? (第一步失敗導致後續失敗)             │              │
│  │    → 全部網路錯誤? (API 未啟動)                     │              │
│  │                                                      │              │
│  │ 3. 生成診斷提示                                      │              │
│  │    → 快速診斷摘要                                    │              │
│  │    → 可能原因列表                                    │              │
│  │    → 建議的修復動作                                  │              │
│  │    → 建議詢問的問題                                  │              │
│  │                                                      │              │
│  │ 4. ✨ 產生診斷摘要文字 (顯示在 runFlow 回應中)       │              │
│  └─────────────────────────────────────────────────────┘              │
└────────────────────────────────────────────────────────────────────────┘
```

---

## ✨ 最新改進：runFlow 自動診斷功能

### 改進內容

#### 1. **自動診斷上下文生成**
```typescript
// apps/mcp-server/src/index.ts:322-350
if (!result.success && flowResult.report) {
  const diagnosticBuilder = new DiagnosticContextBuilder();
  diagnosticContext = diagnosticBuilder.build(flowResult.report);

  if (diagnosticContext) {
    // 產生診斷摘要文字
    diagnosticSummary = `
📊 診斷摘要：
   ${diagnosticContext.diagnosticHints.quickDiagnosis}

💡 可能原因：
   ${diagnosticContext.diagnosticHints.likelyCauses.map(c => `• ${c}`).join('\n   ')}

🔧 建議動作：
   ${diagnosticContext.diagnosticHints.suggestedActions.map(a => `• ${a}`).join('\n   ')}
    `;
  }
}
```

#### 2. **優化回應訊息**
```typescript
return {
  content: [{
    type: "text",
    text: `測試執行完成！\n\n` +
          `執行 ID: ${executionId}\n` +
          `結果: ${result.success ? '✅ 成功' : '❌ 失敗'}\n` +
          `總步驟數: ${result.steps?.length || 0}\n` +
          `成功步驟: ${result.steps?.filter(s => s.status === 'passed')?.length || 0}\n` +
          `失敗步驟: ${result.steps?.filter(s => s.status === 'failed')?.length || 0}\n\n` +
          (diagnosticSummary || '') + '\n\n' +
          `📁 執行詳情：已產生完整報表與日誌\n` +
          `   使用 @mcp__specpilot__getReport 查看完整診斷報表`
  }]
};
```

### 使用效果對比

#### 改進前：
```
測試執行完成！
結果: 失敗
失敗步驟: 2

→ 需要手動呼叫 @mcp__specpilot__getReport 才能看到診斷資訊
```

#### 改進後：
```
測試執行完成！

執行 ID: run-1234567890
結果: ❌ 失敗
總步驟數: 3
成功步驟: 1
失敗步驟: 2

📊 診斷摘要：
   2 個步驟失敗，主要是認證問題

💡 可能原因：
   • 認證 Token 遺失、無效或已過期
   • API Key 設定錯誤

🔧 建議動作：
   • 更新或重新取得認證 Token
   • 檢查 .env.local 中的 SPEC_PILOT_TOKEN

📁 執行詳情：已產生完整報表與日誌
   使用 @mcp__specpilot__getReport 查看完整診斷報表

→ 立即看到診斷結果，無需額外操作！
```

### 優勢

1. **✅ 自動化** - 執行測試時自動診斷，無需手動呼叫 getReport
2. **✅ 即時反饋** - 立即顯示診斷摘要、可能原因和建議動作
3. **✅ 完整保留** - 診斷上下文仍儲存在報表中，可用 getReport 查看完整資訊
4. **✅ 向下相容** - 成功測試不產生診斷上下文，保持高效能
5. **✅ Claude 友善** - 診斷資訊格式化，方便 Claude 理解和分析

---

## 🎯 使用指南

### 基本使用流程

1. **執行測試（自動診斷）**
   ```
   @mcp__specpilot__runFlow spec=api.yaml flow=test.yaml
   ```
   - 自動執行測試
   - 失敗時自動產生診斷摘要
   - 立即顯示可能原因和建議動作

2. **查看完整報表（可選）**
   ```
   @mcp__specpilot__getReport
   ```
   - 查看完整診斷上下文
   - 包含所有技術細節
   - 適合深入分析

3. **分析與修復**
   - Claude 根據診斷資訊提供精確建議
   - 根據建議動作修復問題
   - 重新執行測試驗證

### 最佳實踐

1. **先看診斷摘要** - runFlow 的回應已包含關鍵診斷資訊
2. **需要細節時用 getReport** - 深入分析時查看完整報表
3. **遵循 API 錯誤規範** - 確保 API 回傳結構化錯誤訊息（參考 `docs/guides/api-errors/api-error-handling-guide.md`）
4. **檢查建議動作** - 優先執行診斷提示中的建議步驟

---

## 📖 相關文件

- [API 錯誤處理標準化指南](./guides/api-errors/api-error-handling-guide.md) - 如何設計診斷友善的 API 錯誤格式
- [MCP 設定指南](../MCP-SETUP.md) - Claude Desktop 整合設定
- [專案 README](../README.md) - SpecPilot 完整使用說明

---

## 🚀 未來展望

### 已完成 ✅
- 自動錯誤分類（auth/network/validation/server）
- 錯誤模式偵測（連續失敗、連鎖失敗、網路錯誤）
- 診斷提示生成（快速診斷、可能原因、建議動作）
- runFlow 自動診斷整合

### 未來可能改進 💡
- 支援自訂診斷規則
- 機器學習輔助診斷
- 多語言錯誤訊息支援
- 診斷歷史記錄與統計

---

*最後更新：2025-01-15*
