# 安全性策略
### Secrets / Token 管理流程
1. **本地開發**：使用 `.env.local` 或 `secrets.local.json` 由開發者自行管理；檔案應列入 `.gitignore`。建議提供 `pnpm run secrets:edit`（或相等腳本）集中寫入，避免手動遺漏欄位。
2. **測試環境**：MVP 階段使用本地測試配置，複雜 CI 環境留待後續版本規劃。
3. **Production 環境**：留待 MVP 完成後規劃雲端 Secrets 管理策略。
4. **程式取用流程**：Config Service 於啟動時載入環境變數，提供 `getBaseUrl()`、`getPort()`、`getToken()` 等方法；Run Context 僅儲存執行期 Token，並在流程結束後清空。
5. **輪替與失效控管**：Token 需設定有效期限並建立輪替排程；流程中若偵測到 401/403，記錄 `AUTH_TOKEN_EXPIRED` 事件並建議重新取得或更新 Secrets。
6. **稽核與遮罩**：Structured Logger 與 Reporter 必須以 `***` 遮蔽敏感欄位，並將輪替操作紀錄於審計 log；禁止在除錯訊息中輸出 Token 內容。

- **輸入驗證：** 所有 CLI/MCP 輸入與 Flow/Spec 設定皆經 AJV；採白名單策略。
- **認證與授權：** Bearer Token 由 RunContext 管理，日誌與報告必須遮罩。
- **秘密管理：** 開發環境使用 `.env.local`，生產建議使用 Vault / Secrets Manager；禁止硬編、禁止 log。
- **API 安全：** 預設強制 HTTPS；允許 HTTP 時需在 Flow 設定 `allowInsecure: true`。
- **資料保護：** 檔案儲存需搭配 OS 或磁碟加密；不記錄完整 Request/Response。
- **依賴安全：** `pnpm audit`（可搭配 Snyk），重大漏洞 48 小時內修補；新依賴需 PR 說明。
- **安全測試：** SAST 透過 ESLint security rules / semgrep；專案非公開 API 暫不執行 DAST，建議每季滲透測試。
