# 錯誤處理策略

### 目標 API Fallback 與模擬策略
- **Mock 層實作**：`packages/testing` 內提供 nock/msw handler 與樣板，`pnpm run mock` 可啟動本地 Mock Server；CI 透過 `pnpm run mock:ci` 於獨立埠執行。
- **Flow 宣告**：Flow YAML 支援 `fallback` 欄位，記錄替代 URL 或 Mock handler 名稱；Flow Orchestrator 在 HTTP 重試超過上限後會改用 fallback 定義。
- **Run Context 行為**：在啟用 fallback 時，Orchestrator 於 RunContext 記錄 `fallback:true` 與來源，Reporter 產出 `FALLBACK_USED` 事件。
- **健康檢查機制**：Config Service 提供 `healthcheck` 設定，於執行前先呼叫目標 API 的健康檢查端點；若失敗則自動切換至 Mock 模式。
- **資料維護**：Mock 回應需以 JSON Schema 驗證並存放於 `packages/testing/fixtures`，每次更新必須同步更新版本註記。
- **責任分工**：
  - Dev/QA：維護 Mock handler 與 Flow fallback 區段。
  - DevOps：維護 sandbox/staging API 與監控，確保 fallback 啟用時發出告警。
  - PM/PO：決策何時允許 fallback 結果視為通過或需人工覆核。

### 錯誤分類與處理流程
- **錯誤模型：** 分為可恢復（HTTP/驗證失敗）與不可恢復（設定缺失等）。
- **例外階層：** `BaseError` → `ConfigurationError`, `SpecLoadError`, `FlowParseError`, `HttpExecutionError`, `ValidationError`, `ReportingError`, `TransientError`。
- **傳遞方式：** 模組內轉換為自訂錯誤類別並附 context，Orchestrator 決定重試或報告，CLI/MCP 入口統一處理。
- **Logging 標準：** 使用 pino，JSON Lines 格式，強制帶 `executionId`、`component` 等欄位；敏感資訊遮罩。
- **模式：**
  - 外部 API：exponential backoff（500ms, 1s, 2s）、最多 3 次、尊重 `Retry-After`、簡易 circuit breaker（連續 5 次失敗停止流程）。
  - 業務錯誤：CLI 提供可讀訊息與報告位置；MCP 回傳 JSON-RPC error，使用 1500 系列錯誤碼。
  - 資料一致性：報告寫入採臨時檔 + rename，流程中斷時標記 `partialFailure`，支援 idempotent 流程。
